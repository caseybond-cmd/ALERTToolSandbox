<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALERT Nursing Risk Assessment Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F0F9F9;
        }
        .category-critical { background-color: #DC2626; color: #FFFFFF; }
        .category-intensive-escalate { background-color: #F97316; color: #FFFFFF; }
        .category-intensive { background-color: #F59E0B; color: #1A202C; }
        .category-standard { background-color: #2DD4BF; color: #134E4A; }
        .category-single { background-color: #67E8F9; color: #164E63; }
        .header-gradient {
            background: linear-gradient(to right, #0D9488, #0F766E);
        }
        .final-score-bg {
            background-color: #134E4A;
        }
        .critical-input-label::after { content: '❗'; color: #ef4444; margin-left: 6px; font-weight: bold; }
        .input-critical-alert { border-color: #ef4444 !important; background-color: #fee2e2 !important; }
        .risk-item-selected-critical { border-left: 4px solid #ef4444; background-color: #fee2e2; padding-left: 8px; border-radius: 4px; transition: all 0.2s ease-in-out; }
        .risk-item-selected-critical > span { font-weight: 600; }
        .risk-item-selected-critical::before { content: '❗'; color: #ef4444; margin-right: 8px; font-weight: bold; }
        .module-bg-a { background-color: #fff1f2; }
        .module-bg-b { background-color: #f0f9ff; }
        .module-bg-c { background-color: #f0fdf4; }
        .module-bg-d { background-color: #fffbeb; }
        .module-bg-e { background-color: #fef2f2; }
        .module-bg-f { background-color: #faf5ff; }
        .module-bg-g { background-color: #f5f3ff; }
        .patient-tabs { @apply flex border-b border-gray-300 mb-4 flex-wrap; }
        .patient-tab { @apply cursor-pointer py-2 px-4 text-gray-600 border-b-2 border-transparent hover:bg-gray-100; margin-bottom: -1px; border: 1px solid transparent; border-bottom: none; border-radius: 6px 6px 0 0; }
        .patient-tab.active { @apply border-gray-300 text-teal-700 font-semibold bg-white; border-bottom: 1px solid white; }
        .delete-patient-btn { @apply text-red-400 hover:text-red-600 ml-2 font-mono; }
        .device-flag { @apply ml-2 text-xs font-bold text-white bg-red-600 px-2 py-1 rounded-full; }
        
        @media print {
            body > *:not(#printoutContainer) { display: none !important; }
            #printoutContainer { display: block !important; }
            .print-sheet { font-family: sans-serif; font-size: 10pt; color: #333; page-break-after: always; }
            .print-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 8px; }
            .print-header h1 { font-size: 14pt; margin: 0; }
            .print-header p { font-size: 10pt; margin: 0; text-align: right; }
            .print-section { border: 1px solid #ccc; border-radius: 4px; margin-top: 12px; padding: 8px; }
            .print-section h2 { font-size: 11pt; margin: 0 0 8px 0; padding-bottom: 4px; border-bottom: 1px solid #eee; }
            .print-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
            .print-item { display: flex; }
            .print-item strong { width: 100px; }
            .print-obs-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
            .print-obs-table th, .print-obs-table td { border: 1px solid #ccc; padding: 6px; text-align: center; }
            .print-obs-table th { background-color: #f2f2f2; }
            .print-checklist li { list-style-type: none; margin-bottom: 6px; }
            .print-checklist .checkbox { display: inline-block; width: 20px; height: 20px; margin-right: 8px; border: 1px solid #333; vertical-align: middle; }
            .print-notes { margin-top: 12px; border: 1px solid #ccc; border-radius: 4px; padding: 8px; height: 150px; }
            @page { size: A4; margin: 0.7in; }
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg mb-6 p-4">
            <h2 class="text-xl font-bold text-gray-800 mb-3">Patient List</h2>
            <div id="patientTabsContainer"></div>
            <div class="flex flex-wrap gap-2 mt-4">
                <button id="addPatientBtn" type="button" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-3 rounded-lg text-sm transition-colors">Add New Patient</button>
                <button id="printListBtn" type="button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg text-sm transition-colors">Print Ward List</button>
                <button id="digitalListBtn" type="button" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-3 rounded-lg text-sm transition-colors">Generate Digital Ward List</button>
                <button id="clearDataBtn" type="button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg text-sm transition-colors">Clear All Data</button>
            </div>
        </div>

        <form id="assessmentForm">
            <div class="bg-white rounded-xl shadow-lg mb-6 overflow-hidden">
                <div class="header-gradient p-6 flex items-center justify-center text-white">
                    <div class="bg-white/20 rounded-full p-2 mr-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    </div>
                    <h1 class="text-2xl sm:text-3xl font-bold">ALERT Nursing Risk Assessment Tool</h1>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg mb-6 p-6">
                <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-6">Part 1: Initial Risk Score</h2>

                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Core Patient Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm">
                        <div>
                            <label for="patientInitials" class="block font-medium text-gray-700">Patient Initials:</label>
                            <input type="text" id="patientInitials" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                        </div>
                        <div>
                            <label for="urnLast4" class="block font-medium text-gray-700">Last 4 Digits of URN:</label>
                            <input type="text" id="urnLast4" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                        </div>
                        <div>
                            <label for="wardAndRoom" class="block font-medium text-gray-700">Ward & Room No.:</label>
                            <input type="text" id="wardAndRoom" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                        </div>
                        <div>
                            <label for="reviewType" class="block font-medium text-gray-700">Type of Review:</label>
                            <select id="reviewType" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                <option value="post">Post-ICU stepdown review on ward</option>
                                <option value="pre">Pre-ICU stepdown review</option>
                            </select>
                        </div>
                        <div id="postStepdownFields" class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                            <div>
                                <label for="icuStepdownDate" class="block font-medium text-gray-700">ICU Stepdown Date:</label>
                                <input type="date" id="icuStepdownDate" class="time-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                            </div>
                            <div>
                                <label for="icuStepdownTime" class="block font-medium text-gray-700">ICU Stepdown Time-band:</label>
                                <select id="icuStepdownTime" class="time-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                    <option value="09:00" data-ooh="false">Morning (0600-1159)</option>
                                    <option value="15:00" data-ooh="false">Afternoon (1200-1759)</option>
                                    <option value="21:00" data-ooh="true">Evening (1800-2359)</option>
                                    <option value="03:00" data-ooh="true">Night (0000-0559)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6">
                    <h3 class="font-semibold text-gray-700 mb-2">Key Bloods for Scoring</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                        <div><label class="block text-sm font-medium text-gray-700" id="lactate_label">Lactate</label><div class="flex gap-x-2"><input type="number" step="0.1" id="lactate_input" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Current"><input type="number" step="0.1" id="lactate_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Prev."></div></div>
                        <div><label class="block text-sm font-medium text-gray-700" id="hb_label">Hb</label><div class="flex gap-x-2"><input type="number" id="hb_input" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Current"><input type="number" id="hb_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Prev."></div></div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700" id="k_label">K+</label>
                            <div class="flex gap-x-2"><input type="number" step="0.1" id="k_input" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Current"><input type="number" step="0.1" id="k_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Prev."></div>
                            <label class="flex items-center mt-2 text-xs"><input type="checkbox" id="k_replaced_checkbox" class="h-3 w-3 mr-1 blood-input"> Replaced since sample</label>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700" id="mg_label">Mg++</label>
                            <div class="flex gap-x-2"><input type="number" step="0.1" id="mg_input" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Current"><input type="number" step="0.1" id="mg_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Prev."></div>
                            <label class="flex items-center mt-2 text-xs"><input type="checkbox" id="mg_replaced_checkbox" class="h-3 w-3 mr-1 blood-input"> Replaced since sample</label>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700" id="creatinine_label">Creatinine</label><div class="flex gap-x-2"><input type="number" id="creatinine_input" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Current"><input type="number" id="creatinine_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Prev."></div></div>
                        <div><label class="block text-sm font-medium text-gray-700" id="crp_label">CRP</label><div class="flex gap-x-2"><input type="number" id="crp_input" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Current"><input type="number" id="crp_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Prev."></div></div>
                        <div><label class="block text-sm font-medium text-gray-700" id="albumin_label">Albumin</label><div class="flex gap-x-2"><input type="number" id="albumin_input" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Current"><input type="number" id="albumin_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Prev."></div></div>
                        <div class="sm:col-span-2 mt-2 pt-2 border-t">
                            <label class="flex items-center">
                                <input type="checkbox" id="cts_cardiac_checkbox" class="blood-input">
                                <span class="ml-2 text-sm font-medium text-gray-700">CTS/Cardiac Patient (apply stricter K+/Mg++ targets)</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="scoringContainer">
                    <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">RISK SCORING ASSESSMENT</h2>
                    <p class="text-sm text-gray-500 mb-6 -mt-4">Check all applicable risk factors. The ADDS score can be estimated initially and confirmed later in Part 2.</p>
                    <div class="space-y-8">
                        <div class="p-4 rounded-lg module-bg-a"><h3 class="font-bold text-xl mb-3 p-3 rounded-t-lg bg-rose-200 text-rose-800">Critical Risk Factors</h3><div class="space-y-2 p-4"><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="15" data-id="crit_met" id="crit_met_checkbox" data-is-critical="true"> <span class="ml-2">Currently in MET criteria</span> <span class="text-gray-600">(+15)</span></label><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="10" data-id="crit_adds4" id="crit_adds4_checkbox" data-is-critical="true"> <span class="ml-2">ADDS Score ≥ 4 (estimated or actual)</span> <span class="text-gray-600">(+10)</span></label><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="10" data-id="crit_lactate_high" id="crit_lactate_high_checkbox" data-is-critical="true"> <span class="ml-2">Lactate ≥ 3.5 mmol/L</span> <span class="text-gray-600">(+10)</span></label><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="10" data-id="crit_af" data-is-critical="true"> <span class="ml-2">Unstable Atrial Fibrillation</span> <span class="text-gray-600">(+10)</span></label><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="10" data-id="crit_hb_drop" id="crit_hb_drop_checkbox" data-is-critical="true"> <span class="ml-2">New Hb drop >20g/L OR Active Bleeding</span> <span class="text-gray-600">(+10)</span></label></div></div>
                        <div class="rounded-lg module-bg-b"><h3 class="font-bold text-xl mb-3 p-3 rounded-t-lg bg-blue-200 text-blue-800">Physiological & Respiratory Stability</h3><div class="space-y-2 p-4"><label class="flex items-center p-1"><input type="radio" name="adds_score" class="score-input" data-score="0" data-id="adds_0" id="adds_0_radio" checked> <span class="ml-2">ADDS Score 0 (estimated or actual) (+0)</span></label><label class="flex items-center p-1"><input type="radio" name="adds_score" class="score-input" data-score="1" data-id="adds_1-2" id="adds_1-2_radio"> <span class="ml-2">ADDS Score 1-2 (estimated or actual) (+1)</span></label><label class="flex items-center p-1"><input type="radio" name="adds_score" class="score-input" data-score="5" data-id="adds_3" id="adds_3_radio"> <span class="ml-2">ADDS Score 3 (estimated or actual) (+5)</span></label><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="5" data-id="adds_worsening"> <span class="ml-2">Worsening ADDS Trend (last 12-24h) (+5)</span></label><hr class="my-3"><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="10" data-id="resp_increasing_o2" data-is-critical="true"> <span class="ml-2">Increasing O2 requirements in last 12h</span> <span class="text-gray-600">(+10)</span></label><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="6" data-id="resp_rapid_wean" data-is-critical="true"> <span class="ml-2">Rapid weaning of respiratory support in last 4h (+6)</span></label></div></div>
                        <div class="p-4 rounded-lg module-bg-c"><h3 class="font-bold text-xl mb-3 p-3 rounded-t-lg bg-green-200 text-green-800">Bloods</h3><div class="space-y-2 p-4"><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="4" data-id="bloods_electrolytes" id="bloods_electrolytes" data-is-critical="true"> <span class="ml-2">Abnormal Electrolytes (K+, Mg++) (+4)</span></label><hr class="my-2"><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="4" data-id="bloods_lactate_mid" id="bloods_lactate_mid_checkbox" data-is-critical="true"> <span class="ml-2">Lactate 2.0 - 3.4 (+4)</span></label><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="4" data-id="bloods_creatinine" id="bloods_creatinine_checkbox"> <span class="ml-2">Creatinine >200 µmol/L (+4)</span></label><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="3" data-id="bloods_albumin" id="bloods_albumin_checkbox"> <span class="ml-2">Albumin &lt;25 g/L (+3)</span></label><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="3" data-id="bloods_crp" id="bloods_crp_checkbox"> <span class="ml-2">CRP >100 mg/L (static/rising) (+3)</span></label><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="3" data-id="bloods_anaemia" id="bloods_anaemia_checkbox"> <span class="ml-2">Anaemia (Hb &lt; 80 g/L) (+3)</span></label></div></div>
                        <div class="p-4 rounded-lg module-bg-d"><h3 class="font-bold text-xl mb-3 p-3 rounded-t-lg bg-yellow-200 text-yellow-800">Clinical</h3><div class="space-y-2 p-4"><label class="flex items-center p-1"><input type="radio" name="pain_score" class="score-input" data-score="0" data-id="pain_0" checked> <span class="ml-2 text-gray-500">Pain: None / Well Controlled</span></label><label class="flex items-center p-1"><input type="radio" name="pain_score" class="score-input" data-score="3" data-id="pain_iv"> <span class="ml-2">Pain: Requires regular IV/potent analgesia (+3)</span></label><label class="flex items-center p-1"><input type="radio" name="pain_score" class="score-input" data-score="5" data-id="pain_pca"> <span class="ml-2">Pain: Poorly controlled / PCA (+5)</span></label><hr class="my-2"><label class="flex items-center p-1"><input type="radio" name="fluid_status_score" class="score-input" data-score="0" data-id="fluid_0" id="fluid_0_radio" checked> <span class="ml-2 text-gray-500">Fluid Status: Euvolaemic</span></label><label class="flex items-center p-1"><input type="radio" name="fluid_status_score" class="score-input" data-score="2" data-id="fluid_mild" id="fluid_mild_radio"> <span class="ml-2">Mild Dehydration/Overload (+2)</span></label><label class="flex items-center p-1"><input type="radio" name="fluid_status_score" class="score-input" data-score="4" data-id="fluid_sig" id="fluid_sig_radio" data-is-critical="true"> <span class="ml-2">Significant Dehydration/Overload (+4)</span></label><hr class="my-2"><label class="flex items-center p-1"><input type="radio" name="diet_score" class="score-input" data-score="0" data-id="diet_0" checked> <span class="ml-2 text-gray-500">Diet: Normal</span></label><label class="flex items-center p-1"><input type="radio" name="diet_score" class="score-input" data-score="2" data-id="diet_modified"> <span class="ml-2">Diet: Supplements / Modified (+2)</span></label><label class="flex items-center p-1"><input type="radio" name="diet_score" class="score-input" data-score="4" data-id="diet_nbm"> <span class="ml-2">Diet: NBM / NG / TPN (+4)</span></label><hr class="my-2"><label class="flex items-center p-1"><input type="radio" name="delirium_score" class="score-input" data-score="0" data-id="delirium_0" checked> <span class="ml-2 text-gray-500">Delirium: None</span></label><label class="flex items-center p-1"><input type="radio" name="delirium_score" class="score-input" data-score="4" data-id="delirium_mild"> <span class="ml-2">Delirium: Mild / Subsyndromal (+4)</span></label><label class="flex items-center p-1"><input type="radio" name="delirium_score" class="score-input" data-score="8" data-id="delirium_mod" data-is-critical="true"> <span class="ml-2">Delirium: Moderate to Severe</span> <span class="text-gray-600">(+8)</span></label><hr class="my-2"><label class="flex items-center p-1"><input type="radio" name="mobility_score" class="score-input" data-score="0" data-id="mobility_0" checked> <span class="ml-2 text-gray-500">Mobility: At Baseline</span></label><label class="flex items-center p-1"><input type="radio" name="mobility_score" class="score-input" data-score="1" data-id="mobility_limited"> <span class="ml-2">Mobility: Limited by devices/attachments (+1)</span></label><label class="flex items-center p-1"><input type="radio" name="mobility_score" class="score-input" data-score="2" data-id="mobility_assisted"> <span class="ml-2">Mobility: Assisted (+2)</span></label><label class="flex items-center p-1"><input type="radio" name="mobility_score" class="score-input" data-score="5" data-id="mobility_bedbound"> <span class="ml-2">Mobility: Bed-bound (+5)</span></label><hr class="my-2"><label class="flex items-center p-1"><input type="radio" name="lines_score" class="score-input" data-score="0" data-id="lines_0" checked> <span class="ml-2 text-gray-500">Lines: None / PIVC only</span></label><label class="flex items-center p-1"><input type="radio" name="lines_score" class="score-input" data-score="5" data-id="lines_cvc_present"> <span class="ml-2">Central Line present (CVC/PICC/Vascath) (+5)</span></label><hr class="my-3"><div class="space-y-2"><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="3" data-id="bowels_issue"> <span class="ml-2">Bowels: Not opened >3 days / Ileus (+3)</span></label><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="5" data-id="airway_altered" data-is-critical="true"> <span class="ml-2">Altered Airway (Tracheostomy/Laryngectomy) (+5)</span></label><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="3" data-id="drains_high_risk"> <span class="ml-2">High-Risk Drain present (+3)</span></label></div><hr class="my-3"><div class="pt-2"><label class="flex items-center p-1"><input type="radio" name="concern_score" class="score-input" data-score="0" data-id="concern_0" value="0" checked> <span class="ml-2 text-gray-500">Nursing Concern: None</span></label><label class="flex items-center p-1"><input type="radio" name="concern_score" class="score-input" data-score="5" data-id="concern_present" value="5" data-is-critical="true"> <span class="ml-2">Nursing Concern Present</span> <span class="text-gray-600">(+5)</span></label><textarea id="nursingConcernText" class="mt-2 ml-6 w-full rounded-md border-gray-300 shadow-sm text-sm" rows="2" placeholder="Specify concern..." style="display: none;"></textarea></div></div></div>
                        <div class="p-4 rounded-lg module-bg-e"><h3 class="font-bold text-xl mb-3 p-3 rounded-t-lg bg-red-200 text-red-800">Systemic</h3><div class="space-y-2 p-4">
                            <div class="flex items-center space-x-4">
                                <label for="losDays" class="font-medium text-gray-700">ICU LOS (days):</label>
                                <input type="number" id="losDays" min="0" class="block w-24 rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                <label class="flex items-center p-1"><input type="checkbox" id="losCheckbox" class="score-input" data-score="4" data-id="systemic_los"> <span class="ml-2">LOS > 3 days (+4)</span></label>
                            </div>
                            <hr class="my-3">
                            <label class="flex items-center p-1"><input type="radio" name="frailty_score" class="score-input" data-score="0" data-id="frailty_0" checked> <span class="ml-2 text-gray-500">Frailty: Not Frail</span></label><label class="flex items-center p-1"><input type="radio" name="frailty_score" class="score-input" data-score="2" data-id="frailty_mild"> <span class="ml-2">Frailty: Mild (+2)</span></label><label class="flex items-center p-1"><input type="radio" name="frailty_score" class="score-input" data-score="4" data-id="frailty_mod"> <span class="ml-2">Frailty: Mod-Severe (+4)</span></label><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="4" id="comorbiditiesCheckbox" data-id="systemic_comorbid"> <span class="ml-2"><span class="comorbidity-main-text">≥3 chronic comorbidities</span> <span class="text-gray-400 text-xs">(e.g. IHD, COPD, T2DM)</span> (+4)</span></label>
                        <div id="after_hours_container"><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="0" data-id="systemic_after_hours" id="systemic_after_hours_checkbox"> <span class="ml-2">After-Hours Discharge (<24h)</span></label></div>
                        </div></div>
                        <div id="receivingWardModule" class="p-4 rounded-lg module-bg-g"><h3 class="font-bold text-xl mb-3 p-3 rounded-t-lg bg-indigo-200 text-indigo-800">Receiving Ward and Staffing</h3><div class="space-y-4 p-4"><div><h4 class="block text-sm font-medium text-gray-700 mb-2">Bed Type</h4><label class="flex items-center p-1"><input type="radio" name="bed_type" class="score-input" data-score="0" data-id="env_unmonitored" checked> <span class="ml-2">Unmonitored Bed (+0)</span></label><label class="flex items-center p-1"><input type="radio" name="bed_type" class="score-input" data-score="-3" data-id="env_monitored"> <span class="ml-2">Monitored / Telemetry Bed (-3)</span></label></div><hr><div><h4 class="block text-sm font-medium text-gray-700 mb-2">Staffing</h4><label class="flex items-center p-1"><input type="radio" name="env_ratio" class="score-input" data-score="0" data-id="env_standard" checked> <span class="ml-2">Standard Ward Ratio (+0)</span></label><label class="flex items-center p-1"><input type="radio" name="env_ratio" class="score-input" data-score="-5" data-id="env_enhanced"> <span class="ml-2">Enhanced Ratio (e.g. 1:1, 1:2) (-5)</span></label></div></div></div>
                   </div>
                </div>

                <div class="final-score-bg text-white rounded-xl shadow-lg p-6 mt-8">
                     <div class="flex flex-col sm:flex-row justify-between items-center text-center">
                         <div class="mb-4 sm:mb-0"><span class="text-lg font-medium text-gray-400">TOTAL SCORE</span><div id="totalScore" class="text-5xl font-bold">0</div></div>
                         <div class="w-full sm:w-auto"><span class="text-lg font-medium text-gray-400">FINAL CATEGORY & ACTION</span><div id="riskCategory" class="text-xl font-bold p-3 rounded-md mt-1 transition-all duration-300"></div></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg mb-6 p-6">
                <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-6">Part 2: Detailed Assessment for DMR Note</h2>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Detailed Clinical Parameters</h3>
                    <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h4 class="font-semibold text-gray-700 mb-4">A-E Assessment (for ADDS calculation)</h4>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center">
                                <label class="block text-sm font-medium text-gray-700 sm:col-span-1">Airway</label>
                                <div class="sm:col-span-2">
                                    <select id="airway_input" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                        <option>Patent</option>
                                        <option>At Risk</option>
                                        <option>Tracheostomy</option>
                                        <option>Laryngectomy</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center">
                                <label class="block text-sm font-medium text-gray-700 sm:col-span-1">Resp Rate</label>
                                <div class="sm:col-span-2"><input type="number" id="rr_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center">
                                <label class="block text-sm font-medium text-gray-700 sm:col-span-1">SpO2 (%)</label>
                                <div class="sm:col-span-2"><input type="number" id="spo2_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center">
                                <label class="block text-sm font-medium text-gray-700 sm:col-span-1">Oxygen Delivery</label>
                                <div class="sm:col-span-2 flex items-center space-x-2">
                                    <input type="number" id="o2_flow_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Value">
                                    <select id="o2_unit_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="lpm">L/min</option><option value="fio2">% FiO2</option></select>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center">
                                <label class="block text-sm font-medium text-gray-700 sm:col-span-1">Heart Rate</label>
                                <div class="sm:col-span-2"><input type="number" id="hr_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center">
                                <label class="block text-sm font-medium text-gray-700 sm:col-span-1">SBP (mmHg)</label>
                                <div class="sm:col-span-2"><input type="number" id="sbp_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center">
                                <label class="block text-sm font-medium text-gray-700 sm:col-span-1">DBP (mmHg)</label>
                                <div class="sm:col-span-2"><input type="number" id="dbp_input" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center">
                                <label class="block text-sm font-medium text-gray-700 sm:col-span-1">Consciousness</label>
                                <div class="sm:col-span-2"><select id="consciousness_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="0">Alert</option><option value="1">Voice</option><option value="2">Pain</option><option value="3">Unresponsive</option></select></div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center">
                                <label class="block text-sm font-medium text-gray-700 sm:col-span-1">Temp (°C)</label>
                                <div class="sm:col-span-2"><input type="number" step="0.1" id="temp_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                            </div>
                        </div>

                        <div class="mt-6 bg-teal-50 p-4 rounded-lg text-center border border-teal-200">
                            <span class="text-sm font-medium text-gray-500">CALCULATED ADDS</span>
                            <div id="calculatedADDSScore" class="font-bold text-5xl text-teal-600 my-2">0</div>
                            <div id="addsBreakdown" class="text-xs text-gray-600 min-h-[3em]">Normal Parameters</div>
                        </div>
                    </div>

                    <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h4 class="font-semibold text-gray-700 mb-2">Fluid Balance</h4>
                        <div class="flex flex-col space-y-4">
                            <div><label class="block text-sm font-medium text-gray-700">24hr Fluid Balance (mL)</label><input type="number" id="fbc_24hr_input" class="fluid-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="+/- mL" step="500"></div>
                            <div><label class="block text-sm font-medium text-gray-700">Total ICU Balance (mL)</label><input type="number" id="fbc_total_input" class="fluid-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="+/- mL" step="500"></div>
                        </div>
                    </div>
                </div>

                <div class="mb-6 space-y-6">
                     <h3 class="text-lg font-semibold text-gray-700 mb-4">Detailed Patient Information</h3>
                     <div class="md:col-span-2 space-y-4">
                         <div>
                             <label for="goc" class="block text-sm font-medium text-gray-700">Goals of Care:</label>
                             <select id="goc" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                 <option value="">Not Documented</option>
                                 <option value="A">A</option>
                                 <option value="B">B</option>
                                 <option value="C">C</option>
                             </select>
                             <div id="gocSpecificsContainer" class="hidden mt-2">
                                 <label for="gocSpecifics" class="block text-sm font-medium text-gray-700">Specifics:</label>
                                 <input type="text" id="gocSpecifics" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                             </div>
                         </div>
                         <div id="allergies-section">
                             <label class="block text-sm font-medium text-gray-700">Allergies:</label>
                             <div class="mt-2 space-y-2">
                                 <div class="flex items-center">
                                     <input type="checkbox" id="nkdaCheckbox" class="h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500">
                                     <label for="nkdaCheckbox" class="ml-2 block text-sm text-gray-900">No Known Drug Allergies (NKDA)</label>
                                 </div>
                                 <div id="allergies_container" class="space-y-2"></div>
                                 <button type="button" id="addAllergyButton" class="mt-2 text-sm bg-blue-100 text-blue-800 hover:bg-blue-200 px-3 py-1 rounded-md">+ Add Allergy</button>
                             </div>
                         </div>
                         <div>
                             <label class="block text-sm font-medium text-gray-700">Infection Control Precautions:</label>
                             <div class="mt-2 flex flex-wrap gap-x-4 gap-y-2">
                                 <label class="flex items-center"><input type="checkbox" name="precautions" class="precaution-cb" id="precaution-Contact" value="Contact"> <span class="ml-2">Contact</span></label>
                                 <label class="flex items-center"><input type="checkbox" name="precautions" class="precaution-cb" id="precaution-Droplet" value="Droplet"> <span class="ml-2">Droplet</span></label>
                                 <label class="flex items-center"><input type="checkbox" name="precautions" class="precaution-cb" id="precaution-Airborne" value="Airborne"> <span class="ml-2">Airborne</span></label>
                             </div>
                             <div id="infectionControlDetails" class="hidden mt-2">
                                 <label for="infectionControlReason" class="block text-sm font-medium text-gray-700">Reason:</label>
                                 <input type="text" id="infectionControlReason" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                             </div>
                         </div>
                     </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Post-ICU Syndrome (PICS) Screening</h3>
                    <div class="p-4 rounded-lg module-bg-f">
                        <div class="space-y-2 p-4">
                            <div class="flex flex-wrap items-center gap-x-6 gap-y-2">
                                <label class="flex items-center text-sm"><input type="radio" name="pics_status" value="negative" checked> <span class="ml-2">Negative</span></label>
                                <label class="flex items-center text-sm"><input type="radio" name="pics_status" value="positive"> <span class="ml-2">Positive</span></label>
                                <label class="flex items-center text-sm"><input type="radio" name="pics_status" value="unable"> <span class="ml-2">Unable to assess</span></label>
                            </div>
                            <div id="pics_details_container" class="hidden ml-6 mt-2">
                                <label for="pics_notes" class="block text-sm font-medium text-gray-700">Information / Plan:</label>
                                <textarea id="pics_notes" rows="2" class="mt-1 block w-full rounded-md border-2 border-gray-400 bg-gray-100 shadow-sm p-2 text-sm" placeholder="Information/Plan..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg mb-6 p-4">
                <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4 px-2 pt-2">Narrative Details for DMR</h2>
                <div class="space-y-8 text-sm px-2 pb-2">
                    <div><label for="admissionReason" class="block font-medium text-gray-600">Reason for ICU Admission:</label><textarea id="admissionReason" rows="3" class="mt-1 block w-full rounded-md border-2 border-gray-400 bg-gray-100 shadow-sm p-2 text-sm"></textarea></div>
                    <div><label for="pmh" class="block font-medium text-gray-600">Past Medical History (PMH):</label><textarea id="pmh" rows="5" class="mt-1 block w-full rounded-md border-2 border-gray-400 bg-gray-100 shadow-sm p-2 text-sm"></textarea></div>
                    <div><label for="icuSummary" class="block font-medium text-gray-600">ICU Summary / Timeline:</label><textarea id="icuSummary" rows="10" class="mt-1 block w-full rounded-md border-2 border-gray-400 bg-gray-100 shadow-sm p-2 text-sm"></textarea></div>
                    
                    <div>
                        <label class="flex items-center font-medium text-gray-600">
                            <input type="checkbox" id="homeTeamPlanCheckbox" class="mr-2">
                            Home Team Plan in Place
                        </label>
                        <div id="homeTeamPlanDetails" class="hidden mt-2">
                             <textarea id="homeTeamPlanText" rows="3" class="mt-1 block w-full rounded-md border-2 border-gray-400 bg-gray-100 shadow-sm p-2 text-sm" placeholder="Enter details of home team plan..."></textarea>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="font-semibold text-gray-700 mb-4">Device, Drain & Wound Assessment</h3>
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-medium text-gray-600 mb-2">Central Vascular Access Devices (CVADs)</h4>
                                <div id="central_lines_container" class="space-y-4"></div>
                                <button type="button" id="addCentralLineButton" class="mt-2 text-sm bg-rose-100 text-rose-800 hover:bg-rose-200 px-3 py-1 rounded-md">+ Add CVAD</button>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-600 mb-2">Peripheral IV Cannulas (PIVCs)</h4>
                                <div id="pivcs_container" class="space-y-4"></div>
                                <button type="button" id="addPivcButton" class="mt-2 text-sm bg-blue-100 text-blue-800 hover:bg-blue-200 px-3 py-1 rounded-md">+ Add PIVC</button>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-600 mb-2">GI / Enteral Devices</h4>
                                <div id="ng_tubes_container" class="space-y-4"></div>
                                <button type="button" id="addNgTubeButton" class="mt-2 text-sm bg-green-100 text-green-800 hover:bg-green-200 px-3 py-1 rounded-md">+ Add Enteral Device</button>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-600 mb-2">Epicardial Pacing Wires</h4>
                                <div class="flex items-center">
                                    <input type="checkbox" id="pacing_wires_present">
                                    <label for="pacing_wires_present" class="ml-2">Pacing Wires Present</label>
                                </div>
                                <div id="pacing_wires_details" class="hidden mt-2 ml-6 space-y-2 p-3 bg-gray-100 rounded-md">
                                    <label class="block text-sm font-medium text-gray-700">Status:</label>
                                    <select id="pacing_status" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                        <option value="capped">Capped & Secured</option>
                                        <option value="backup">Connected (Backup/Sensing)</option>
                                        <option value="pacing">Actively Pacing</option>
                                    </select>
                                    <div id="pacing_settings" class="hidden grid grid-cols-3 gap-2 pt-2">
                                        <div><label class="block text-sm font-medium text-gray-700">Mode</label><input type="text" id="pacing_mode" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                                        <div><label class="block text-sm font-medium text-gray-700">Rate</label><input type="number" id="pacing_rate" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                                        <div><label class="block text-sm font-medium text-gray-700">Output</label><input type="number" id="pacing_output" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t">
                                  <div>
                                    <h4 class="font-medium text-gray-600 mb-2">Drains</h4>
                                    <div id="drains_container" class="space-y-4"></div>
                                    <button type="button" id="addDrainButton" class="mt-2 text-sm bg-teal-100 text-teal-800 hover:bg-teal-200 px-3 py-1 rounded-md">+ Add Drain</button>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-600 mb-2">Wounds</h4>
                                    <div id="wounds_container" class="space-y-4"></div>
                                    <button type="button" id="addWoundButton" class="mt-2 text-sm bg-pink-100 text-pink-800 hover:bg-pink-200 px-3 py-1 rounded-md">+ Add Wound</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div><label for="emrAdditionalNotes" class="block font-medium text-gray-600">Additional Plan Notes:</label><textarea id="emrAdditionalNotes" rows="4" class="mt-1 block w-full rounded-md border-2 border-gray-400 bg-gray-100 shadow-sm p-2 text-sm"></textarea></div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg mt-6 p-6">
                <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">DMR Summary Generator</h2>
                <div class="flex space-x-4 mb-4"><button type="button" id="generateSummaryButton" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-1/2">Generate DMR Summary</button><button type="button" id="copySummaryButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors w-1/2">Copy to Clipboard</button></div>
                <textarea id="emrSummary" rows="20" class="w-full p-2 border border-gray-300 rounded-md bg-gray-50 font-mono text-xs" placeholder="Your summary will appear here..."></textarea>
                <div class="mt-6 text-center"><button type="button" id="resetButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Reset Form</button></div>
            </div>
        </form>
    </div>
    
    <div id="digitalListModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-bold">Digital Ward List</h2>
                 <button id="closeDigitalListModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="digitalListContent" class="prose max-w-none flex-grow overflow-y-auto border p-4 bg-gray-50 text-sm"></div>
            <div class="mt-4 flex justify-end space-x-2">
                <button id="copyDigitalListBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <div id="printoutContainer" class="hidden"></div>
    
    <div class="text-center mt-8 text-gray-500 text-sm">Version 4.6.1 - Bug Fix & Enhancements</div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Element References ---
        const assessmentForm = document.getElementById('assessmentForm');
        const scoreInputs = document.querySelectorAll('.score-input');
        const totalScoreEl = document.getElementById('totalScore');
        const riskCategoryEl = document.getElementById('riskCategory');
        const resetButton = document.getElementById('resetButton');
        const generateSummaryButton = document.getElementById('generateSummaryButton');
        const copySummaryButton = document.getElementById('copySummaryButton');
        const emrSummaryEl = document.getElementById('emrSummary');
        const bloodInputs = document.querySelectorAll('.blood-input');
        const calculatedADDSEl = document.getElementById('calculatedADDSScore');
        const addsBreakdownEl = document.getElementById('addsBreakdown');
        const picsRadios = document.querySelectorAll('input[name="pics_status"]');
        const picsDetailsContainer = document.getElementById('pics_details_container');
        const vitalInputs = document.querySelectorAll('.vital-input');
        const nursingConcernRadios = document.querySelectorAll('input[name="concern_score"]');
        const nursingConcernText = document.getElementById('nursingConcernText');
        const timeInputs = document.querySelectorAll('.time-input');
        const reviewTypeSelect = document.getElementById('reviewType');
        const postStepdownFields = document.getElementById('postStepdownFields');
        const afterHoursContainer = document.getElementById('after_hours_container');
        const afterHoursCheckbox = document.getElementById('systemic_after_hours_checkbox');
        const gocSelect = document.getElementById('goc');
        const gocSpecificsContainer = document.getElementById('gocSpecificsContainer');
        const nkdaCheckbox = document.getElementById('nkdaCheckbox');
        const allergiesContainer = document.getElementById('allergies_container');
        const addAllergyButton = document.getElementById('addAllergyButton');
        const allergiesSection = document.getElementById('allergies-section');
        const precautionCheckboxes = document.querySelectorAll('.precaution-cb');
        const infectionControlDetails = document.getElementById('infectionControlDetails');
        const addCentralLineButton = document.getElementById('addCentralLineButton');
        const centralLinesContainer = document.getElementById('central_lines_container');
        const addPivcButton = document.getElementById('addPivcButton');
        const pivcsContainer = document.getElementById('pivcs_container');
        const addNgTubeButton = document.getElementById('addNgTubeButton');
        const ngTubesContainer = document.getElementById('ng_tubes_container');
        const pacingWiresPresentCheckbox = document.getElementById('pacing_wires_present');
        const pacingWiresDetailsDiv = document.getElementById('pacing_wires_details');
        const pacingStatusSelect = document.getElementById('pacing_status');
        const pacingSettingsDiv = document.getElementById('pacing_settings');
        const addDrainButton = document.getElementById('addDrainButton');
        const drainsContainer = document.getElementById('drains_container');
        const addWoundButton = document.getElementById('addWoundButton');
        const woundsContainer = document.getElementById('wounds_container');
        const homeTeamPlanCheckbox = document.getElementById('homeTeamPlanCheckbox');
        const homeTeamPlanDetails = document.getElementById('homeTeamPlanDetails');
        
        // Patient Management UI
        const patientTabsContainer = document.getElementById('patientTabsContainer');
        const addPatientBtn = document.getElementById('addPatientBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const printListBtn = document.getElementById('printListBtn');
        const digitalListBtn = document.getElementById('digitalListBtn');

        // Digital List Modal UI
        const digitalListModal = document.getElementById('digitalListModal');
        const digitalListContent = document.getElementById('digitalListContent');
        const copyDigitalListBtn = document.getElementById('copyDigitalListBtn');
        const closeDigitalListModalBtn = document.getElementById('closeDigitalListModalBtn');
        const printoutContainer = document.getElementById('printoutContainer');

        // --- State Management ---
        let patients = {};
        let activePatientId = null;
        const LOCAL_STORAGE_KEY = 'alertToolPatientData_v4.6';
        let currentAddsBreakdown = 'Normal Parameters';
        
        // --- Data Maps ---
        const carePlanMap = { 'crit_met_post': 'CRITICAL: Patient is in MET criteria on the ward. Initiate immediate MET call as per local protocol and escalate to senior nursing and medical staff.', 'crit_met_pre': 'CRITICAL: Patient\'s current observations would trigger a MET call on the ward. This is a significant barrier to transfer. Liaise with ICU and home teams to create a clear mitigation plan before stepdown.', 'crit_adds4': 'CRITICAL: High ADDS score indicates significant physiological instability. Escalate for urgent medical review (<30 mins) and ensure adherence to the AORC escalation pathway.', 'crit_lactate_high': 'CRITICAL: Critically high lactate suggests potential tissue hypoperfusion. Escalate immediately to the medical team for urgent review.', 'crit_af': 'CRITICAL: Unstable AF (e.g., with hypotension, ischaemia) requires urgent intervention. Escalate for cardiology/medical review and prepare for 12-lead ECG.', 'crit_hb_drop': 'CRITICAL: Significant Hb drop or active bleeding requires urgent investigation. Escalate for urgent medical/surgical review, ensure IV access, and consider group and hold.', 'resp_increasing_o2': 'Respiratory Plan: Increasing O2 needs noted. Perform focused respiratory assessments (work of breathing) per AORC. Ensure clear documentation of Resp Rate and O2 requirements to monitor trends. Liaise with medical team to review.', 'resp_rapid_wean': 'Respiratory Plan: Recent rapid wean of respiratory support. Perform focused respiratory assessments (work of breathing) per AORC and ensure clear documentation of Resp Rate and O2 requirements to monitor for signs of fatigue.', 'bloods_electrolytes': 'Biochemical Plan: Significant electrolyte abnormalities noted. Escalate to medical officer for review and prescribing of replacement therapy. For severe K+ abnormalities, escalate to senior nursing staff and contact ALERT CNS for support regarding patient placement and monitoring.', 'bloods_lactate_mid': 'Biochemical Plan: Liaise with medical team for serial lactate measurement within 4 hours to ensure clearance. Continue to review fluid status and clinical signs of perfusion.', 'bloods_creatinine': 'Biochemical Plan: Maintain strict fluid balance chart. Ensure urine output remains >0.5ml/kg/hr and escalate to the medical team if it falls below this target. Liaise with pharmacy to review for nephrotoxic medications.', 'bloods_albumin': 'Nutrition Plan: Significant hypoalbuminaemia noted. Ensure active dietitian referral for nutritional assessment and planning. Monitor for oedema.', 'bloods_anaemia': 'Haematology Plan: Monitor for signs of occult bleeding or haemodynamic instability. Liaise with medical team to clarify transfusion threshold.', 'pain_pca': 'Pain Management: Pain appears poorly controlled. Perform comprehensive pain assessments (score 0-10) with each set of observations. Ensure prescribed analgesia is optimised and offered regularly. Escalate to the Acute Pain Service if pain remains severe.', 'fluid_sig': 'Fluid Management: Significant fluid imbalance identified. Maintain strict fluid balance chart and daily weights. Perform clinical fluid assessment (peripheral oedema, lung auscultation). Liaise with medical team to review fluid orders. Please contact ALERT CNS for support with assessment if required.', 'delirium_mod': 'Cognitive Support: Implement delirium prevention strategies (e.g., reorientation, day/night cycle, family presence). Liaise with the medical team and pharmacy to review for potential deliriogenic medications.', 'mobility_bedbound': 'Mobility & Pressure Care: Implement pressure injury prevention bundle: Regular turns, pressure-relieving mattress, skin assessment. Liaise with physiotherapy for in-bed exercise plan.', 'airway_altered': 'Airway Management: Ensure patient is in an appropriate bed location with trained staff. Confirm required emergency equipment (e.g., spare inner cannula, spare tracheostomy tube of same/smaller size, obturator, 10ml syringe, trach dilators) is present and checked at the bedside. Contact ALERT CNS for support if required.', 'lines_cvc_present': 'Line Management: Daily review of Central Line necessity with medical team (to minimise line days). Maintain strict ANTT for all access and monitor site for signs of infection (CLABSI bundle).', 'drains_high_risk': 'Drain Management: Maintain close monitoring of drain patency, output characteristics, and volume. Escalate immediately to the home team for any sudden changes, particularly for outputs >100ml/hr of fresh blood, or signs of blockage.', 'bowels_issue': 'Bowel Management: Patient has not opened bowels >3 days. Monitor for signs of abdominal distension or discomfort. Escalate to the medical team for review and consideration of aperients.', 'concern_present': "Nursing Concerns: Articulate specific nursing concerns and escalate to senior nursing/medical staff for a 'fresh eyes' review of the patient's trajectory.", 'frailty_mod': 'Frailty Plan: Ensure referrals to Physiotherapy and Occupational Therapy are active to support mobility and function. Focus on falls prevention and nutritional support.', 'after_hours_high_risk': 'TRANSFER SAFETY ALERT: This high-risk patient had an after-hours discharge. Ensure handover to the ward team is exceptionally detailed, highlighting key risks for the first 24 hours.', 'after_hours_very_high_risk': 'CRITICAL RISK: This patient\'s high score combined with an after-hours discharge represents a significant risk of readmission. A direct, senior-level (Registrar or Consultant) discussion between ICU and the receiving home team is strongly recommended before transfer.' };
        const impressionMap = {'crit_met':'is currently meeting MET criteria','crit_adds4':'has a high ADDS score indicating physiological instability','crit_lactate_high':'has a critically high lactate concerning for hypoperfusion','crit_af':'is in unstable atrial fibrillation','crit_hb_drop':'has had a significant drop in haemoglobin or is actively bleeding','resp_increasing_o2':'has increasing oxygen requirements','delirium_mod':'is suffering from moderate to severe delirium','fluid_sig':'has a significant fluid imbalance','pain_pca':'has poorly controlled pain requiring advanced analgesia','concern_present':'has specific concerns raised by the bedside nursing staff'};
        const standardScores = { getRrScore(rr) { let s=0,m=false; if(rr>=36||rr<5)m=true;else if(rr>=30&&rr<=35)s=3;else if(rr>=25&&rr<=29)s=2;else if(rr>=21&&rr<=24)s=1;else if(rr>=5&&rr<=9)s=3; return {score:s, isMet:m}; }, getSpo2Score(spo2) { let s=0,m=false; if(spo2<=84)m=true;else if(spo2>=85&&spo2<=90)s=2;else if(spo2>=91&&spo2<=93)s=1; return {score:s, isMet:m}; }, getO2Score(o2Flow, o2Unit) { let s=0; if(o2Unit==='lpm'){if(o2Flow>10)s=3;else if(o2Flow>=5&&o2Flow<=9)s=2;else if(o2Flow>=2&&o2Flow<=4)s=1}else{if(o2Flow>=40)s=3;else if(o2Flow>=29)s=2;else if(o2Flow>=21)s=1} return {score:s, isMet:false}; }, getHrScore(hr) { let s=0,m=false; if(hr>=140||hr<30)m=true;else if(hr>=130&&hr<=139)s=3;else if(hr>=120&&hr<=129)s=2;else if(hr>=100&&hr<=119)s=1;else if(hr>=40&&hr<=49)s=1;else if(hr>=30&&hr<=39)s=2; return {score:s, isMet:m}; }, getSbpScore(sbp) { let s=0,m=false; if(sbp<90)m=true;else if(sbp>=190&&sbp<=199)s=3;else if(sbp>=180&&sbp<=189)s=2;else if(sbp>=150&&sbp<=179)s=1;else if(sbp>=80&&sbp<=99)s=1;else if(sbp>=70&&sbp<=79)s=2; return {score:s, isMet:m}; } };
        
        // --- HELPER FUNCTIONS ---
        const safeGet = (id) => document.getElementById(id)?.value || '';
        const safeIsChecked = (id) => document.getElementById(id)?.checked || false;
        const getSelectText = (selectEl) => selectEl ? (selectEl.options[selectEl.selectedIndex]?.text || '') : '';
        
        // --- ALL FUNCTIONS DECLARED HERE ---
        
        function resetForm(){
            assessmentForm.reset();
            document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], textarea').forEach(el => el.value = '');
            document.querySelectorAll('select').forEach(el => el.selectedIndex = 0);
            document.querySelectorAll('input[type="checkbox"]').forEach(input => input.checked = false);
            document.querySelectorAll('input[type="radio"]').forEach(rb=>{if(rb.dataset.score==="0" || rb.value==="negative" || rb.value==="0"){rb.checked=true}});
            nursingConcernText.style.display='none';
            gocSpecificsContainer.classList.add('hidden');
            allergiesContainer.innerHTML = '';
            allergiesContainer.style.display = 'block';
            addAllergyButton.style.display = 'block';
            infectionControlDetails.classList.add('hidden');
            homeTeamPlanCheckbox.checked = false;
            homeTeamPlanDetails.classList.add('hidden');
            document.getElementById('homeTeamPlanText').value = '';

            [centralLinesContainer, pivcsContainer, ngTubesContainer, drainsContainer, woundsContainer].forEach(c => c.innerHTML = '');
            pacingWiresDetailsDiv.classList.add('hidden');
            pacingSettingsDiv.classList.add('hidden');
            picsDetailsContainer.classList.add('hidden');
            emrSummaryEl.value = '';

            document.querySelectorAll('.input-critical-alert, .critical-input-label, .risk-item-selected-critical').forEach(el => {
                el.classList.remove('input-critical-alert', 'critical-input-label', 'risk-item-selected-critical');
            });
            
            reviewTypeSelect.dispatchEvent(new Event('change'));
            calculateADDS();
        }

        function calculateScore() {
            let totalScore = 0;
            scoreInputs.forEach(input => {
                if (input.checked) {
                    totalScore += parseInt(input.dataset.score, 10) || 0;
                }
            });
            totalScoreEl.textContent = totalScore;
            updateRiskCategory(totalScore);
        }

        function updateRiskCategory(score) {
            let categoryText = '';
            let categoryClass = '';
            let followUpMessage = '';
            const stepdownDateStr = safeGet('icuStepdownDate');

            if (score > 40) {
                categoryText = 'Critical Risks Identified - Immediate Senior Review';
                categoryClass = 'category-critical';
            } else if (score >= 30) {
                categoryText = 'Intensive ALERT Post ICU follow up (72hrs) + Consider ALERT Medical Team Escalation';
                categoryClass = 'category-intensive-escalate';
            } else if (score >= 10) {
                categoryText = 'Intensive ALERT Post ICU follow up for up to 72hrs on ward';
                categoryClass = 'category-intensive';
            } else if (score >= 4) {
                categoryText = 'Standard ALERT Post ICU follow up for up to 24 hours on ward';
                categoryClass = 'category-standard';
            } else if (score >= 1) {
                categoryText = 'Single ALERT Post ICU follow up on ward';
                categoryClass = 'category-single';
            } else {
                 categoryText = 'No specific follow-up required';
                 categoryClass = 'category-single';
            }

            if (stepdownDateStr) {
                const stepdownDate = new Date(stepdownDateStr);
                const now = new Date();
                const hoursSince = (now - stepdownDate) / (1000 * 60 * 60);

                if (score >= 1 && score <= 3) {
                    followUpMessage = 'Minimum follow-up time met. Consider if safe to discharge from ALERT.';
                } else if (score >= 4 && score <= 9 && hoursSince > 24) {
                    followUpMessage = '24hr follow-up period met. Consider if safe to discharge from ALERT.';
                } else if (score >= 10 && hoursSince > 72) {
                    followUpMessage = '72hr follow-up period met. Consider adding to Patient of Concern list for continued follow-up.';
                }
            }
            
            riskCategoryEl.innerHTML = `${categoryText} <br> <span class="text-sm font-normal">${followUpMessage}</span>`;
            riskCategoryEl.className = `text-xl font-bold p-3 rounded-md mt-1 transition-all duration-300 ${categoryClass}`;
        }

        function calculateADDS() {
            let adds = 0; let met = false;
            const breakdownReasons = [];
            
            const processVital = (param, value, scoreFn) => {
                if (isNaN(value)) return;
                const res = scoreFn(value);
                adds += res.score;
                met = met || res.isMet;
                if (res.score > 0) breakdownReasons.push(`${param.toUpperCase()} ${value} (+${res.score})`);
            };
            
            processVital('rr', parseInt(safeGet('rr_input'), 10), standardScores.getRrScore);
            processVital('hr', parseInt(safeGet('hr_input'), 10), standardScores.getHrScore);
            processVital('sbp', parseInt(safeGet('sbp_input'), 10), standardScores.getSbpScore);
            processVital('spo2', parseInt(safeGet('spo2_input'), 10), standardScores.getSpo2Score);
            
            const o2Flow = parseFloat(safeGet('o2_flow_input'));
            if (!isNaN(o2Flow) && o2Flow > 0) {
                 const o2Unit = safeGet('o2_unit_input');
                 const res = standardScores.getO2Score(o2Flow, o2Unit);
                 adds += res.score;
                 if(res.score > 0) breakdownReasons.push(`O2 ${o2Flow}${o2Unit === 'lpm' ? 'L/min' : '%'} (+${res.score})`);
            }
            
            const temp = parseFloat(safeGet('temp_input')); if (!isNaN(temp)) { let tempScore = 0; if(temp>=38.6||temp<35.1) tempScore=2; else if((temp>=38&&temp<=38.5)||(temp>=35.1&&temp<=36)) tempScore=1; if(tempScore > 0) { adds+=tempScore; breakdownReasons.push(`Temp ${temp}C (+${tempScore})`);}}
            const consciousness = parseInt(safeGet('consciousness_input'),10); if (!isNaN(consciousness)) { if(consciousness===3)met=true;else if (consciousness > 0) { adds+=consciousness; breakdownReasons.push(`${getSelectText(document.getElementById('consciousness_input'))} (+${consciousness})`);} }
            
            calculatedADDSEl.textContent = met ? 'MET' : adds;
            calculatedADDSEl.className = `font-bold text-5xl my-2 ${met ? 'text-red-600' : 'text-teal-600'}`;
            currentAddsBreakdown = breakdownReasons.length > 0 ? breakdownReasons.join(', ') : 'Normal Parameters';
            addsBreakdownEl.textContent = currentAddsBreakdown;
            
            document.getElementById('crit_met_checkbox').checked=met;
            document.getElementById('crit_adds4_checkbox').checked=!met && adds >= 4;
            document.getElementById('adds_3_radio').checked=!met && adds === 3;
            document.getElementById('adds_1-2_radio').checked=!met && adds >= 1 && adds <= 2;
            document.getElementById('adds_0_radio').checked=!met && adds === 0;
            
            calculateScore();
        }
        
        function handleBloodInputs() {
            const getF = (id) => parseFloat(safeGet(id));
            const check = (id, condition) => { const el = document.getElementById(id); if (el) el.checked = condition; };
            const isCardiac = safeIsChecked('cts_cardiac_checkbox');
            const flagger = (inputId, labelId, isCritical) => {
                document.getElementById(inputId)?.classList.toggle('input-critical-alert', isCritical);
                document.getElementById(labelId)?.classList.toggle('critical-input-label', isCritical);
            };

            const k = getF('k_input');
            let k_abnormal = !isNaN(k) && ((isCardiac && (k < 4.0 || k > 5.0)) || (!isCardiac && (k < 3.5 || k > 5.2)));
            flagger('k_input', 'k_label', k_abnormal);
            const k_replaced = safeIsChecked('k_replaced_checkbox');
            if (k_replaced) k_abnormal = false;

            const mg = getF('mg_input');
            let mg_abnormal = !isNaN(mg) && ((isCardiac && (mg < 0.8 || mg > 1.0)) || (!isCardiac && (mg < 0.7 || mg > 1.0)));
            flagger('mg_input', 'mg_label', mg_abnormal);
            const mg_replaced = safeIsChecked('mg_replaced_checkbox');
            if (mg_replaced) mg_abnormal = false;

            const lactate = getF('lactate_input');
            flagger('lactate_input', 'lactate_label', lactate >= 2.0);
            if (!isNaN(lactate)) { check('crit_lactate_high_checkbox', lactate >= 3.5); check('bloods_lactate_mid_checkbox', lactate >= 2.0 && lactate < 3.5); }
            
            const hb = getF('hb_input'), hb_prev = getF('hb_input_prev');
            const isAnemic = !isNaN(hb) && hb < 80;
            const isDropping = !isNaN(hb) && !isNaN(hb_prev) && (hb_prev - hb) > 20;
            flagger('hb_input', 'hb_label', isAnemic || isDropping);
            check('bloods_anaemia_checkbox', isAnemic);
            check('crit_hb_drop_checkbox', isDropping);

            const creatinine = getF('creatinine_input');
            const isHighCreatinine = !isNaN(creatinine) && creatinine > 200;
            flagger('creatinine_input', 'creatinine_label', isHighCreatinine);
            check('bloods_creatinine_checkbox', isHighCreatinine);
            
            const crp = getF('crp_input');
            const isHighCrp = !isNaN(crp) && crp > 100;
            flagger('crp_input', 'crp_label', isHighCrp);
            check('bloods_crp_checkbox', isHighCrp);

            const albumin = getF('albumin_input');
            const isLowAlbumin = !isNaN(albumin) && albumin < 25;
            flagger('albumin_input', 'albumin_label', isLowAlbumin);
            check('bloods_albumin_checkbox', isLowAlbumin);

            check('bloods_electrolytes', k_abnormal || mg_abnormal);
            calculateScore();
        }

        function handleFluidBalance(){
            const fbc24hr = parseFloat(safeGet('fbc_24hr_input'));
            const fbcTotal = parseFloat(safeGet('fbc_total_input'));

            const isSig = (!isNaN(fbc24hr) && Math.abs(fbc24hr) > 1000) || (!isNaN(fbcTotal) && Math.abs(fbcTotal) > 2000);
            const isMild = (!isNaN(fbc24hr) && Math.abs(fbc24hr) > 500) || (!isNaN(fbcTotal) && Math.abs(fbcTotal) > 1000);
            
            if(isSig) {
                document.getElementById('fluid_sig_radio').checked = true;
            } else if (isMild) {
                 document.getElementById('fluid_mild_radio').checked = true;
            } else {
                 document.getElementById('fluid_0_radio').checked = true;
            }
            calculateScore();
        }

        function handleAfterHoursLogic() {
            if (safeGet('reviewType') === 'pre') {
                afterHoursContainer.classList.add('hidden');
                afterHoursCheckbox.checked = false;
                afterHoursCheckbox.dataset.score = "0";
                calculateScore();
                return;
            }
            
            afterHoursContainer.classList.remove('hidden');
            const dateStr = safeGet('icuStepdownDate');
            const timeStr = safeGet('icuStepdownTime');
            const isOOH = document.querySelector(`#icuStepdownTime option[value="${timeStr}"]`)?.dataset.ooh === 'true';

            if (!dateStr || !timeStr) {
                afterHoursCheckbox.checked = false;
                afterHoursCheckbox.dataset.score = "0";
                calculateScore();
                return;
            }
            
            const [year, month, day] = dateStr.split('-').map(Number);
            const [hour, minute] = timeStr.split(':').map(Number);
            const dischargeDateTime = new Date(year, month - 1, day, hour, minute);
            const now = new Date();
            const hoursSinceDischarge = (now - dischargeDateTime) / (1000 * 60 * 60);

            if (isOOH && hoursSinceDischarge > 0 && hoursSinceDischarge <= 24) {
                afterHoursCheckbox.checked = true;
                const currentScore = parseInt(totalScoreEl.textContent, 10);
                afterHoursCheckbox.dataset.score = currentScore >= 10 ? "5" : "2"; 
            } else {
                afterHoursCheckbox.checked = false;
                afterHoursCheckbox.dataset.score = "0";
            }
            calculateScore();
        }

        function createDynamicInput(container, templateHTML) {
            const div = document.createElement('div');
            div.innerHTML = templateHTML.trim();
            const newElement = div.firstChild;
            container.appendChild(newElement);
            newElement.querySelectorAll('.device-date-input').forEach(input => {
                input.addEventListener('input', checkDeviceFlags);
            });
        }
        
        const createAllergyInput = () => createDynamicInput(allergiesContainer, `
            <div class="allergy-row flex items-center space-x-2 p-2 bg-gray-100 rounded-md">
                <input type="text" placeholder="Allergen" class="allergen-name mt-1 block w-1/2 rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                <input type="text" placeholder="Reaction" class="allergen-reaction mt-1 block w-1/2 rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                <button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold">X</button>
            </div>
        `);
        
        const createCentralLineInput = () => createDynamicInput(centralLinesContainer, `
            <div class="device-row border border-rose-200 p-3 rounded-lg bg-rose-50 space-y-2">
                <div class="flex justify-between items-center"> <h5 class="font-semibold text-rose-800">CVAD</h5> <button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold text-lg">&times;</button> </div>
                <div class="grid grid-cols-2 gap-2">
                    <select class="cvad-type mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option>CVC</option><option>PICC</option><option>Vascath</option></select>
                    <select class="cvad-location mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="">Location...</option><option>R IJ</option><option>L IJ</option><option>R Subclavian</option><option>L Subclavian</option><option>R Femoral</option><option>L Femoral</option><option>R Antecubital</option><option>L Antecubital</option></select>
                    <div><label class="text-xs text-gray-600">Date Inserted</label><input type="date" title="Insertion Date" class="cvad-date device-date-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                    <input type="number" placeholder="Ext. Length (cm)" class="cvad-length mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                    <select class="cvad-site mt-1 block w-full col-span-2 rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="">Site Appearance...</option><option>Clean & Dry</option><option>Oozing</option><option>Redness</option><option>Swelling</option><option>Painful</option></select>
                </div>
            </div>
        `);

        const createPivcInput = () => createDynamicInput(pivcsContainer, `
            <div class="device-row border border-blue-200 p-3 rounded-lg bg-blue-50 space-y-2">
                <div class="flex justify-between items-center"> <h5 class="font-semibold text-blue-800">PIVC</h5> <button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold text-lg">&times;</button> </div>
                <div class="grid grid-cols-2 gap-2">
                    <select class="pivc-location mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="">Location...</option><option>R Hand</option><option>L Hand</option><option>R Wrist</option><option>L Wrist</option><option>R Forearm</option><option>L Forearm</option><option>R Antecubital</option><option>L Antecubital</option></select>
                    <div><label class="text-xs text-gray-600">Date Inserted</label><input type="date" title="Insertion Date" class="pivc-date device-date-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                    <input type="number" min="0" max="5" placeholder="PIVAS (0-5)" class="pivc-pivas mt-1 block w-full col-span-2 rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                </div>
            </div>
        `);

        const createNgTubeInput = () => createDynamicInput(ngTubesContainer, `
            <div class="device-row border border-green-200 p-3 rounded-lg bg-green-50 space-y-2">
                 <div class="flex justify-between items-center"> <h5 class="font-semibold text-green-800">Enteral Device</h5> <button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold text-lg">&times;</button> </div>
                 <div class="grid grid-cols-2 gap-2">
                    <select class="ng-type mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option>NG Tube</option><option>NJ Tube</option><option>PEG</option></select>
                    <input type="number" placeholder="Ext. Length (cm)" class="ng-length mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                    <select class="ng-use mt-1 block w-full col-span-2 rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="">Purpose...</option><option>Feeds</option><option>Free Drainage</option><option>Aspiration</option></select>
                 </div>
            </div>
        `);
        
        const createDrainInput = () => createDynamicInput(drainsContainer, `
            <div class="device-row border border-teal-200 p-3 rounded-lg bg-teal-50 space-y-2">
                 <div class="flex justify-between items-center"> <h5 class="font-semibold text-teal-800">Drain</h5> <button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold text-lg">&times;</button> </div>
                 <div class="grid grid-cols-2 gap-2">
                    <select class="drain-type mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="">Type/Location...</option><option>Abdominal</option><option>Chest Drain</option><option>Nephrostomy</option><option>Wound Drain</option></select>
                    <input type="text" placeholder="Output Type" class="drain-output-type mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                    <input type="number" placeholder="24h Output (mL)" class="drain-output-24hr mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                    <input type="number" placeholder="Total Output (mL)" class="drain-output-total mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                 </div>
            </div>
        `);
        
        const createWoundInput = () => createDynamicInput(woundsContainer, `
            <div class="device-row border border-pink-200 p-3 rounded-lg bg-pink-50 space-y-2">
                 <div class="flex justify-between items-center"> <h5 class="font-semibold text-pink-800">Wound</h5> <button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold text-lg">&times;</button> </div>
                 <div class="grid grid-cols-2 gap-2">
                    <select class="wound-location mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="">Location...</option><option>Sternal</option><option>Abdominal</option><option>Limb</option><option>Pressure Injury</option></select>
                    <select class="wound-status mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="">Status/Dressing...</option><option>Clean & Dry</option><option>Oozing</option><option>Dehisced</option><option>Infected</option><option>VAC Dressing</option></select>
                 </div>
            </div>
        `);
        
        // --- SUMMARY & INTELLIGENCE FUNCTIONS ---
        function getTrend(current, prev, lowerIsBetter = false) {
            if (isNaN(current) || isNaN(prev)) return '';
            const diff = current - prev;
            if (Math.abs(diff) < (current * 0.05)) return '(static)'; // Less than 5% change is static
            if ((!lowerIsBetter && diff > 0) || (lowerIsBetter && diff < 0)) return '(worsening)';
            return '(improving)';
        }

        function generateImpression() {
            const concerns = [];
            for (const key in impressionMap) {
                if (safeIsChecked(`${key}_checkbox`) || safeIsChecked(`${key}_radio`)) {
                    concerns.push(impressionMap[key]);
                }
            }
            if (concerns.length === 0) {
                return "Overall, the patient appears clinically stable with no major risk factors identified at this time.";
            }
            let impression = `This patient presents with several clinical concerns: the patient ${concerns.join(', ')}.`;
            if (concerns.length > 1) {
                const last = concerns.pop();
                impression = `This patient presents with several clinical concerns: the patient ${concerns.join(', ')}, and ${last}.`;
            }
            return impression;
        }

        function generateSummary() {
            let summary = `--- ALERT LIAISON NURSE REVIEW ---\n\n`;
            
            summary += `IMPRESSION: ${generateImpression()}\n\n`;

            summary += `PATIENT: ${safeGet('patientInitials')} (${safeGet('urnLast4')}), ${safeGet('wardAndRoom')}\n`;
            summary += `REVIEW TYPE: ${getSelectText(reviewTypeSelect)}\n`;
            summary += `ICU LOS: ${safeGet('losDays')} days\n\n`;
            
            summary += `ASSESSMENT (A-E):\n`;
            summary += `- Airway: ${safeGet('airway_input')}\n`;
            summary += `- Breathing: RR ${safeGet('rr_input')}, SpO2 ${safeGet('spo2_input')}% on ${safeGet('o2_flow_input') || 'RA'}${safeGet('o2_flow_input') ? (safeGet('o2_unit_input') === 'lpm' ? 'L/min' : '% FiO2') : ''}\n`;
            summary += `- Circulation: HR ${safeGet('hr_input')}, BP ${safeGet('sbp_input')}/${safeGet('dbp_input')}\n`;
            summary += `- Disability: ${getSelectText(document.getElementById('consciousness_input'))}\n`;
            summary += `- Exposure: Temp ${safeGet('temp_input')}°C\n`;
            summary += `- Calculated ADDS Score: ${calculatedADDSEl.textContent} (${currentAddsBreakdown})\n\n`;

            summary += `KEY BLOODS:\n`;
            const bloods = [
                {label: 'Lactate', id: 'lactate', lowerIsBetter: true}, {label: 'Hb', id: 'hb', lowerIsBetter: false},
                {label: 'K+', id: 'k', lowerIsBetter: false}, {label: 'Mg++', id: 'mg', lowerIsBetter: false},
                {label: 'Creatinine', id: 'creatinine', lowerIsBetter: true}, {label: 'CRP', id: 'crp', lowerIsBetter: true},
                {label: 'Albumin', id: 'albumin', lowerIsBetter: false}
            ];
            bloods.forEach(b => {
                const current = parseFloat(safeGet(`${b.id}_input`));
                const prev = parseFloat(safeGet(`${b.id}_input_prev`));
                if (!isNaN(current)) {
                    summary += `- ${b.label}: ${current} ${getTrend(current, prev, b.lowerIsBetter)}\n`;
                }
            });
            summary += `\n`;

            summary += `RISK ASSESSMENT SCORE: ${totalScoreEl.textContent}\n`;
            summary += `CATEGORY & ACTION: ${riskCategoryEl.innerHTML.replace(/<br\s*\/?>/gi, ' - ')}\n\n`;
            
            summary += `KEY ISSUES & PLAN:\n`;
            const carePlanItems = [];
            document.querySelectorAll('.device-row .device-flag').forEach(flag => {
                if (flag && flag.title) carePlanItems.push(`- ${flag.title}`);
            });

            document.querySelectorAll('.score-input:checked').forEach(input => {
                const id = input.dataset.id;
                let planKey = id;
                if (id === 'crit_met') {
                    planKey = safeGet('reviewType') === 'pre' ? 'crit_met_pre' : 'crit_met_post';
                }
                if (carePlanMap[planKey]) {
                    carePlanItems.push(`- ${carePlanMap[planKey]}`);
                }
            });
            
            if (carePlanItems.length > 0) {
                summary += [...new Set(carePlanItems)].join('\n') + '\n\n';
            } else {
                summary += "- No critical issues identified. Continue standard ward-based care.\n\n";
            }
            
            emrSummaryEl.value = summary;
        }
        
        function checkDeviceFlags() {
            const now = new Date();
            const addFlag = (element, title) => {
                let flag = element.querySelector('.device-flag');
                if (!flag) {
                    flag = document.createElement('span');
                    flag.className = 'device-flag';
                    element.querySelector('h5').appendChild(flag);
                }
                flag.textContent = 'REVIEW';
                flag.title = title;
            };
            const removeFlag = (element) => {
                const flag = element.querySelector('.device-flag');
                if (flag) flag.remove();
            };

            document.querySelectorAll('#pivcs_container .device-row').forEach(row => {
                const dateStr = row.querySelector('.pivc-date').value;
                if (!dateStr) { removeFlag(row); return; }
                const insertedDate = new Date(dateStr);
                const hours = (now - insertedDate) / (1000 * 60 * 60);
                if (hours > 72) {
                    addFlag(row, 'PIVC in situ >72 hours. Assess PIVAS and consider replacement.');
                } else {
                    removeFlag(row);
                }
            });
            document.querySelectorAll('#central_lines_container .device-row').forEach(row => {
                const dateStr = row.querySelector('.cvad-date').value;
                if (!dateStr) { removeFlag(row); return; }
                const insertedDate = new Date(dateStr);
                const days = (now - insertedDate) / (1000 * 60 * 60 * 24);
                if (days > 7) {
                    addFlag(row, 'CVAD in situ >7 days. Review ongoing necessity with home team.');
                } else {
                    removeFlag(row);
                }
            });
        }
        
        // --- PATIENT MANAGEMENT ---

        function getFormData() {
            const data = {};
            assessmentForm.querySelectorAll('input, select, textarea').forEach(el => {
                const id = el.id || `${el.name}-${el.value}`;
                if (el.type === 'checkbox' || el.type === 'radio') {
                     if (id) data[id] = el.checked;
                } else {
                    if (id) data[id] = el.value;
                }
            });
            
            data.allergies = Array.from(allergiesContainer.querySelectorAll('.allergy-row')).map(row => ({
                name: row.querySelector('.allergen-name').value,
                reaction: row.querySelector('.allergen-reaction').value
            }));

            const saveDevices = (container, selectors) => Array.from(container.querySelectorAll('.device-row')).map(row => {
                const deviceData = {};
                for (const key in selectors) { deviceData[key] = row.querySelector(selectors[key])?.value; }
                return deviceData;
            });
            
            data.centralLines = saveDevices(centralLinesContainer, { type: '.cvad-type', location: '.cvad-location', date: '.cvad-date', length: '.cvad-length', site: '.cvad-site' });
            data.pivcs = saveDevices(pivcsContainer, { location: '.pivc-location', date: '.pivc-date', pivas: '.pivc-pivas' });
            data.ngTubes = saveDevices(ngTubesContainer, { type: '.ng-type', length: '.ng-length', use: '.ng-use' });
            data.drains = saveDevices(drainsContainer, { type: '.drain-type', outputType: '.drain-output-type', output24hr: '.drain-output-24hr', outputTotal: '.drain-output-total' });
            data.wounds = saveDevices(woundsContainer, { location: '.wound-location', status: '.wound-status' });

            return data;
        }
        
        function loadFormData(data) {
            if (!data) return;
            resetForm();
            for (const key in data) {
                const el = document.getElementById(key);
                if (el) {
                    if (el.type === 'checkbox' || el.type === 'radio') {
                        el.checked = data[key];
                    } else {
                        el.value = data[key];
                    }
                } else { // Handle radio buttons without IDs
                    const radio = document.querySelector(`input[name="${key.split('-')[0]}"][value="${key.split('-')[1]}"]`);
                    if(radio) radio.checked = data[key];
                }
            }

            // Restore dynamic elements
            if (data.allergies) { data.allergies.forEach(a => { createAllergyInput(); const lastRow = allergiesContainer.lastChild.querySelector('.allergy-row'); lastRow.querySelector('.allergen-name').value = a.name; lastRow.querySelector('.allergen-reaction').value = a.reaction; }); }
            if (data.centralLines) { data.centralLines.forEach(d => { createCentralLineInput(); const lastRow = centralLinesContainer.lastChild.querySelector('.device-row'); for(const k in d) { const el = lastRow.querySelector(`.cvad-${k}`); if (el) el.value = d[k]; } }); }
            if (data.pivcs) { data.pivcs.forEach(d => { createPivcInput(); const lastRow = pivcsContainer.lastChild.querySelector('.device-row'); for(const k in d) { const el = lastRow.querySelector(`.pivc-${k}`); if (el) el.value = d[k]; } }); }
            if (data.ngTubes) { data.ngTubes.forEach(d => { createNgTubeInput(); const lastRow = ngTubesContainer.lastChild.querySelector('.device-row'); for(const k in d) { const el = lastRow.querySelector(`.ng-${k}`); if (el) el.value = d[k]; } }); }
            if (data.drains) { data.drains.forEach(d => { createDrainInput(); const lastRow = drainsContainer.lastChild.querySelector('.device-row'); for(const k in d) { const el = lastRow.querySelector(`.drain-${k.replace('outputType','output-type').replace('output24hr','output-24hr').replace('outputTotal','output-total')}`); if (el) el.value = d[k]; } }); }
            if (data.wounds) { data.wounds.forEach(d => { createWoundInput(); const lastRow = woundsContainer.lastChild.querySelector('.device-row'); for(const k in d) { const el = lastRow.querySelector(`.wound-${k}`); if (el) el.value = d[k]; } }); }
            
            assessmentForm.querySelectorAll('input, select').forEach(el => el.dispatchEvent(new Event('input', { bubbles: true })));
            assessmentForm.querySelectorAll('input, select').forEach(el => el.dispatchEvent(new Event('change', { bubbles: true })));
            checkDeviceFlags();
        }

        function saveState() {
            const dataToSave = { patients: patients, activePatientId: activePatientId };
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
        }

        function loadAllData() {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    patients = parsedData.patients || {};
                    activePatientId = parsedData.activePatientId;
                } catch (e) { console.error("Failed to parse data", e); patients = {}; activePatientId = null; }
            }
            if (Object.keys(patients).length === 0) {
                addPatient(false);
            } else {
                if (!activePatientId || !patients[activePatientId]) { activePatientId = Object.keys(patients)[0]; }
                renderTabs();
                switchPatient(activePatientId);
            }
        }
        
        function saveActivePatientData() {
            if (!activePatientId) return;
            const patientData = getFormData();
            const patientName = patientData.patientInitials || `Patient`;
            patients[activePatientId] = { id: activePatientId, name: patientName, score: totalScoreEl.textContent, category: riskCategoryEl.innerHTML, data: patientData };
            saveState();
            renderTabs();
        }

        function addPatient(doSave = true) {
            const newId = `patient_${Date.now()}`;
            const newPatientName = `Patient ${Object.keys(patients).length + 1}`;
            patients[newId] = { id: newId, name: newPatientName, score: 0, category: '', data: {} };
            activePatientId = newId;
            if(doSave) saveState();
            renderTabs();
            switchPatient(newId);
        }

        function deletePatient(idToDelete) {
            if(Object.keys(patients).length <= 1) { alert("Cannot delete the last patient."); return; }
            if(confirm(`Are you sure you want to delete patient ${patients[idToDelete].name}?`)) {
                delete patients[idToDelete];
                if (activePatientId === idToDelete) { activePatientId = Object.keys(patients)[0]; }
                saveState();
                renderTabs();
                switchPatient(activePatientId);
            }
        }

        function switchPatient(newId) {
            if (activePatientId && activePatientId !== newId) { saveActivePatientData(); }
            activePatientId = newId;
            const patient = patients[newId];
            loadFormData(patient.data);
            renderTabs();
        }

        function renderTabs() {
            patientTabsContainer.innerHTML = '';
            const tabContainer = document.createElement('div');
            tabContainer.className = 'patient-tabs';

            Object.values(patients).forEach(patient => {
                const tab = document.createElement('div');
                tab.className = 'patient-tab';
                if (patient.id === activePatientId) tab.classList.add('active');
                tab.textContent = `${patient.name || 'New Patient'} (Score: ${patient.score || 0})`;
                tab.dataset.id = patient.id;
                const deleteBtn = document.createElement('span');
                deleteBtn.textContent = 'x';
                deleteBtn.className = 'delete-patient-btn';
                deleteBtn.title = `Delete ${patient.name}`;
                deleteBtn.onclick = (e) => { e.stopPropagation(); deletePatient(patient.id); };
                tab.appendChild(deleteBtn);
                tab.onclick = () => switchPatient(patient.id);
                tabContainer.appendChild(tab);
            });
            patientTabsContainer.appendChild(tabContainer);
        }
        
        function getListData(patient) {
            const data = patient.data || {};
            const allergies = data.allergies && data.allergies.length > 0 ? data.allergies.map(a => a.name).join(', ') : (data.nkdaCheckbox ? 'NKDA' : 'Not documented');
            const precautionsList = [];
            if (data['precaution-Contact']) precautionsList.push('Contact');
            if (data['precaution-Droplet']) precautionsList.push('Droplet');
            if (data['precaution-Airborne']) precautionsList.push('Airborne');
            const precautions = precautionsList.length > 0 ? precautionsList.join(', ') : 'Standard';

            return { name: data.patientInitials || patient.name || 'N/A', location: data.wardAndRoom || 'N/A', urn: data.urnLast4 || 'N/A', score: patient.score || 0, category: patient.category || 'N/A', goc: data.goc || 'N/A', los: data.losDays || 'N/A', allergies: allergies, precautions: precautions, reason: data.infectionControlReason || '' };
        }

        function generateDigitalList() {
            let listHtml = ``;
            const sortedPatients = Object.values(patients).sort((a, b) => (b.score || 0) - (a.score || 0));
            sortedPatients.forEach(p => {
                const d = getListData(p);
                listHtml += `<div class="prose max-w-none border-t pt-4 mt-4"><h3>${d.name} - ${d.location} (URN: ${d.urn})</h3><p><strong>Risk Score: ${d.score}</strong> (${d.category.replace(/<br.*?>/gi, ' - ')})</p><p><strong>Key Info:</strong> GOC: ${d.goc} | ICU LOS: ${d.los} days | Allergies: ${d.allergies} | Precautions: ${d.precautions}</p><h4>Review Checklist:</h4><ul><li><strong>Airway:</strong> Patent, secure? Trache status?</li><li><strong>Breathing:</strong> WOB, RR trend, O2 stable/weaning?</li><li><strong>Circulation:</strong> Fluid status? Lines patent/clean? Output adequate?</li><li><strong>Disability:</strong> GCS/AVPU, Delirium screen (CAM-ICU/4AT), Pain controlled?</li><li><strong>Exposure/Systemic:</strong> Bowels opened? Nutrition plan? Mobility plan?</li></ul></div>`;
            });
            digitalListContent.innerHTML = listHtml;
            digitalListModal.classList.remove('hidden');
            digitalListModal.classList.add('flex');
        }
        
        function generatePrintList() {
            let printHtml = '';
            const sortedPatients = Object.values(patients).sort((a,b) => (b.score || 0) - (a.score || 0));
            sortedPatients.forEach(p => {
                const d = getListData(p);
                const precautionsText = d.precautions === 'Standard' ? 'Standard' : `${d.precautions} (${d.reason})`;
                printHtml += `<div class="print-sheet"><div class="print-header"><h1>ALERT Ward Review Sheet</h1><p>${new Date().toLocaleDateString('en-AU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p></div><div class="print-section"><h2>Patient Details</h2><div class="print-grid"><div class="print-item"><strong>Patient:</strong> ${d.name}</div><div class="print-item"><strong>Ward/Room:</strong> ${d.location}</div><div class="print-item"><strong>URN (last 4):</strong> ${d.urn}</div><div class="print-item"><strong>ICU LOS:</strong> ${d.los} days</div><div class="print-item"><strong>G.O.C:</strong> ${d.goc}</div><div class="print-item"><strong>Allergies:</strong> ${d.allergies}</div><div class="print-item" style="grid-column: 1 / -1;"><strong>Precautions:</strong> ${precautionsText}</div></div></div><div class="print-section"><h2>Observations</h2><table class="print-obs-table"><thead><tr><th>HR</th><th>BP</th><th>RR</th><th>SpO2</th><th>O2 (L/min)</th><th>Temp</th></tr></thead><tbody><tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr></tbody></table></div><div class="print-section"><h2>A-E Review Checklist</h2><ul class="print-checklist"><li><span class="checkbox"></span> <strong>Airway:</strong> Airway patent & secure? Tracheostomy status/plan?</li><li><span class="checkbox"></span> <strong>Breathing:</strong> Work of Breathing assessment. O2 requirements stable/weaning?</li><li><span class="checkbox"></span> <strong>Circulation:</strong> Fluid status assessment. Lines patent & PIVAS score? Urine output adequate?</li><li><span class="checkbox"></span> <strong>Disability:</strong> GCS/AVPU documented. Delirium screen (CAM-ICU/4AT). Pain controlled?</li><li><span class="checkbox"></span> <strong>Exposure:</strong> Bowels opened? Nutrition/dietetics plan in place? Mobility/PT plan?</li></ul></div><div class="print-notes"><h2>Notes</h2></div></div>`;
            });
            printoutContainer.innerHTML = printHtml;
            window.print();
        }

        function initializeApp() {
            resetButton.addEventListener('click', () => { if(confirm('Are you sure you want to reset the form for this patient?')) { resetForm(); saveActivePatientData(); } });
            generateSummaryButton.addEventListener('click', generateSummary);
            copySummaryButton.addEventListener('click', copySummary);
            bloodInputs.forEach(input => input.addEventListener('input', handleBloodInputs));
            scoreInputs.forEach(input => input.addEventListener('change', (e) => { const target = e.target; const parentLabel = target.closest('label'); if (!parentLabel) return; if (target.type === 'radio') { document.querySelectorAll(`input[name="${target.name}"]`).forEach(radio => radio.closest('label')?.classList.remove('risk-item-selected-critical')); } if (target.dataset.isCritical === 'true') { parentLabel.classList.toggle('risk-item-selected-critical', target.checked); } calculateScore(); }));
            nursingConcernRadios.forEach(radio => radio.addEventListener('change', () => { nursingConcernText.style.display = document.querySelector('input[name="concern_score"]:checked').value === "5" ? 'block' : 'none'; if (document.querySelector('input[name="concern_score"]:checked').value !== "5") nursingConcernText.value = ''; }));
            picsRadios.forEach(radio => radio.addEventListener('change', (e) => { picsDetailsContainer.classList.toggle('hidden', e.target.value === 'negative'); }));
            vitalInputs.forEach(i=>i.addEventListener('input', calculateADDS));
            document.getElementById('losDays').addEventListener('input', () => { const days = parseFloat(safeGet('losDays')); document.getElementById('losCheckbox').checked = days > 3; calculateScore(); });
            document.querySelectorAll('.fluid-input').forEach(i=>i.addEventListener('input', handleFluidBalance));
            timeInputs.forEach(input => input.addEventListener('input', handleAfterHoursLogic));
            reviewTypeSelect.addEventListener('change', (e) => { const isPre = e.target.value === 'pre'; const postFields = document.getElementById('postStepdownFields'); if(postFields) postFields.style.display = isPre ? 'none' : 'grid'; handleAfterHoursLogic(); calculateScore(); });
            gocSelect.addEventListener('change', () => { const showSpecifics = ['B', 'C'].includes(gocSelect.value); gocSpecificsContainer.classList.toggle('hidden', !showSpecifics); if (!showSpecifics) document.getElementById('gocSpecifics').value = ''; });
            addAllergyButton.addEventListener('click', createAllergyInput);
            nkdaCheckbox.addEventListener('change', () => { const isChecked = nkdaCheckbox.checked; if(isChecked) allergiesContainer.innerHTML = ''; allergiesContainer.style.display = isChecked ? 'none' : 'block'; addAllergyButton.style.display = isChecked ? 'none' : 'block'; });
            precautionCheckboxes.forEach(cb => { cb.addEventListener('change', () => { const anyChecked = [...precautionCheckboxes].some(c => c.checked); infectionControlDetails.classList.toggle('hidden', !anyChecked); if(!anyChecked) document.getElementById('infectionControlReason').value = ''; }); });
            addCentralLineButton.addEventListener('click', createCentralLineInput); addPivcButton.addEventListener('click', createPivcInput); addNgTubeButton.addEventListener('click', createNgTubeInput); addDrainButton.addEventListener('click', createDrainInput); addWoundButton.addEventListener('click', createWoundInput);
            [centralLinesContainer, pivcsContainer, ngTubesContainer, drainsContainer, woundsContainer, allergiesSection].forEach(c => { if (c) c.addEventListener('click', e => { if (e.target.classList.contains('remove-btn')) { e.target.closest('.device-row, .allergy-row').remove(); }}); });
            pacingWiresPresentCheckbox.addEventListener('change', () => { pacingWiresDetailsDiv.classList.toggle('hidden', !pacingWiresPresentCheckbox.checked); });
            pacingStatusSelect.addEventListener('change', () => { pacingSettingsDiv.classList.toggle('hidden', pacingStatusSelect.value === 'capped'); });
            homeTeamPlanCheckbox.addEventListener('change', () => { homeTeamPlanDetails.classList.toggle('hidden', !homeTeamPlanCheckbox.checked); if(!homeTeamPlanCheckbox.checked) { document.getElementById('homeTeamPlanText').value = ''; }});
            addPatientBtn.addEventListener('click', () => addPatient());
            clearDataBtn.addEventListener('click', () => { if(confirm('ARE YOU SURE you want to delete ALL patient data? This is permanent.')) { if(confirm('Second confirmation: This will delete everything.')) { localStorage.removeItem(LOCAL_STORAGE_KEY); patients = {}; activePatientId = null; addPatient(); } } });
            printListBtn.addEventListener('click', generatePrintList);
            digitalListBtn.addEventListener('click', generateDigitalList);
            closeDigitalListModalBtn.addEventListener('click', () => { digitalListModal.classList.add('hidden'); digitalListModal.classList.remove('flex'); });
            copyDigitalListBtn.addEventListener('click', () => { navigator.clipboard.writeText(digitalListContent.innerText).then(() => { copyDigitalListBtn.textContent = 'Copied!'; setTimeout(() => { copyDigitalListBtn.textContent = 'Copy to Clipboard'; }, 2000); }, () => alert('Failed to copy.')); });
            let saveTimeout;
            assessmentForm.addEventListener('input', () => { clearTimeout(saveTimeout); saveTimeout = setTimeout(saveActivePatientData, 500); });
            assessmentForm.addEventListener('change', () => { clearTimeout(saveTimeout); saveTimeout = setTimeout(saveActivePatientData, 500); });
            loadAllData();
        }
        initializeApp();
    });
    </script>
</body>
</html>
