<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALERT Nursing Risk Assessment Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
body { font-family: 'Inter', sans-serif; background-color: #F0F9F9; }
.category-critical { background-color: #DC2626; color: #FFFFFF; }
.category-intensive-escalate { background-color: #F97316; color: #FFFFFF; }
.category-intensive { background-color: #F59E0B; color: #1A202C; }
.category-standard { background-color: #2DD4BF; color: #134E4A; }
.category-single { background-color: #67E8F9; color: #164E63; }
.header-gradient { background: linear-gradient(to right, #0D9488, #0F766E); }
.final-score-bg { background-color: #134E4A; }

.patient-tabs-container { border-bottom: 1px solid #D1D5DB; }
.patient-tab { 
    position: relative; cursor: pointer; padding: 0.75rem 1rem; color: #4B5563; 
    border: 1px solid transparent; border-bottom: none; border-top: 4px solid transparent; 
    margin-bottom: -1px; display: flex; align-items: center; gap: 0.5rem; 
    transition: all 0.2s ease-in-out;
}
.patient-tab:hover { background-color: #F3F4F6; }
.patient-tab.active { border-color: #D1D5DB; color: #047857; font-weight: 600; background-color: #FFFFFF; }
.delete-patient-btn { color: #9CA3AF; font-size: 1.1rem; line-height: 1; padding: 2px; border-radius: 99px; }
.delete-patient-btn:hover { color: #DC2626; background-color: #FEE2E2; }
.tab-score-badge { font-size: 0.7rem; font-weight: 700; color: white; padding: 2px 6px; border-radius: 8px; }

.patient-tab.active.risk-critical { border-top-color: #DC2626; }
.patient-tab.active.risk-intensive-escalate { border-top-color: #F97316; }
.patient-tab.active.risk-intensive { border-top-color: #F59E0B; }
.patient-tab.active.risk-standard { border-top-color: #2DD4BF; }
.patient-tab.active.risk-single { border-top-color: #67E8F9; }

.score-group { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb; }
.score-group-title { margin-bottom: 0.5rem; font-weight: 600; color: #4b5563; }
.score-option {
    display: block; border: 2px solid #d1d5db; border-radius: 0.5rem;
    padding: 0.75rem 1rem; margin-bottom: 0.5rem; cursor: pointer;
    transition: all 0.2s ease-in-out; background-color: #ffffff;
}
.score-option input { display: none; }
.option-label { display: flex; align-items: center; justify-content: space-between; font-size: 1rem; line-height: 1.2; }
.score-option:has(input:checked) { border-color: #2563eb; background-color: #eff6ff; }
.score-option:has(input:checked) .option-label { font-weight: 600; color: #1e40af; }

.segmented-control { display: flex; width: 100%; border-radius: 0.5rem; overflow: hidden; border: 2px solid #d1d5db; }
.segmented-control .score-option { flex-grow: 1; text-align: center; border: none; margin: 0; border-radius: 0; border-right: 2px solid #d1d5db; padding: 0.5rem 0.25rem; }
.segmented-control .score-option:last-child { border-right: none; }
.segmented-control .option-label { justify-content: center; font-size: 0.875rem; }
.segmented-control .score-option:has(input:checked) { background-color: #2563eb; }
.segmented-control .score-option:has(input:checked) .option-label { color: #ffffff; font-weight:600; }

@media (max-width: 420px) {
    .segmented-control { flex-direction: column; border: none; }
    .segmented-control .score-option { border-radius: 0.5rem; border: 2px solid #d1d5db; margin-bottom: 0.5rem; }
    .segmented-control .score-option:last-child { margin-bottom: 0; }
}

@media print {
    @page { size: A4; margin: 0.5in; }
    body { font-size: 9pt; background-color: #fff; }
    .no-print, .print-hide { display: none !important; }

    body.print-blank-mode #main-content, body.print-blank-mode #assessmentForm { display: block !important; visibility: visible !important; }
    body.print-blank-mode > *:not(#main-content) { display: none !important; }
    #main-content > *:not(#assessmentForm) { display: none !important; }
    
    .print-blank-mode #assessmentForm { box-shadow: none !important; border: none !important; padding: 0 !important; margin: 0 !important; }
    .print-blank-mode .print-section { break-inside: avoid; margin-bottom: 1rem; }
    .print-blank-mode .final-score-bg, .print-blank-mode details > summary { display: none !important; }
    .print-blank-mode h1, .print-blank-mode h2, .print-blank-mode h3 { padding: 0 !important; margin: 0 0 4px 0 !important; font-size: 11pt; }
    .print-blank-mode h4 { font-size: 10pt; margin-bottom: 2px; }
    .print-blank-mode .bg-white, .print-blank-mode .bg-gray-50 { padding: 0 !important; margin: 0 0 8px 0 !important; border: none !important; box-shadow: none !important; }
    .print-blank-mode input[type="text"], .print-blank-mode input[type="date"], .print-blank-mode input[type="number"],
    .print-blank-mode textarea, .print-blank-mode select {
        border: none !important; border-bottom: 1px solid #999 !important;
        border-radius: 0 !important; padding: 1px 0 !important; background-color: transparent !important; box-shadow: none !important; width: 100%;
    }
    .print-blank-mode textarea { border: 1px solid #999 !important; min-height: 2em; }
    .print-blank-mode input[type="checkbox"],  .print-blank-mode input[type="radio"] { display: inline-block !important; width: 12px; height: 12px; border: 1px solid #000 !important; vertical-align: middle; }
    .print-blank-mode label { color: #000 !important; }
    .print-blank-mode .grid { display: block; }
    .print-blank-mode .score-option { padding: 4px; }
    .print-blank-mode .option-label { font-size: 9pt; }
}    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div id="launchScreenModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex flex-col items-center justify-center p-4 z-50 no-print">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 text-center max-w-lg w-full">
            <h2 class="text-2xl md:text-3xl font-bold text-teal-700 mb-4">Welcome to the ALERT Tool</h2>
            <p class="text-gray-600 mb-6">Choose how you want to begin your workflow.</p>
            <div id="scannerContainer" class="hidden my-4 flex flex-col items-center">
                 <div id="qr-reader" style="width: 250px; height: 250px;"></div>
                 <p id="qr-scan-result" class="mt-2 text-sm font-medium"></p>
            </div>
            <div id="launchButtons" class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="scanQRBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg text-lg">üì≤ Scan QR Code</button>
                <button id="startFromScratchBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg text-lg">üìù Start From Scratch</button>
            </div>
             <button id="stopScanningBtn" class="hidden mt-4 text-sm text-red-600 hover:underline">Cancel Scan</button>
        </div>
    </div>

     <div id="qrCodeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50 no-print">
        <div class="bg-white rounded-lg shadow-xl p-6 text-center">
            <h2 class="text-xl font-bold mb-4">Send to Mobile</h2>
            <p class="text-sm text-gray-600 mb-4">Scan this QR code to transfer patient data.</p>
            <div id="qrcode" class="flex justify-center p-4 bg-white"></div>
            <button id="closeQRCodeModalBtn" class="mt-6 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Close</button>
        </div>
    </div>

    <div id="main-content" class="max-w-4xl mx-auto" style="visibility: hidden;">
        <div class="bg-white rounded-xl shadow-lg mb-6 p-4 no-print">
            <div class="flex flex-wrap justify-end items-center gap-2 mb-3">
                 <button id="sendToMobileBtn" type="button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg text-sm">üì≤ Send to Mobile</button>
                 <button id="addPatientBtn" type="button" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Add Patient</button>
                 <button id="printBlankBtn" type="button" class="bg-gray-100 text-gray-800 hover:bg-gray-200 font-semibold py-2 px-3 rounded-lg text-sm">Print Blank Form</button>
                 <button id="clearDataBtn" type="button" class="bg-red-100 text-red-800 hover:bg-red-200 font-semibold py-2 px-3 rounded-lg text-sm">Clear All Data</button>
            </div>
            <div id="patientTabsContainer" class="patient-tabs-container flex flex-wrap items-center"></div>
        </div>

        <form id="assessmentForm" onsubmit="return false;">
            <div class="bg-white rounded-xl shadow-lg mb-6 overflow-hidden">
                <div class="header-gradient p-6 flex items-center justify-center text-white">
                    <div class="bg-white/20 rounded-full p-2 mr-4 no-print">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    </div>
                    <h1 class="text-2xl sm:text-3xl font-bold">ALERT Nursing Risk Assessment Tool</h1>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg mb-6 p-6 space-y-6 print-section">
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Patient & Review Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm">
                        <div class="md:col-span-2">
                            <label for="reviewType" class="block font-medium text-gray-700">Type of Review:</label>
                            <select id="reviewType" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                <option value="post">Post-ICU stepdown review on ward</option>
                                <option value="pre">Pre-ICU stepdown review</option>
                            </select>
                        </div>
                        <div>
                            <label for="patientInitials" class="block font-medium text-gray-700">Patient Initials:</label>
                            <input type="text" id="patientInitials" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                        </div>
                        <div>
                            <label for="wardAndRoom" class="block font-medium text-gray-700">Ward & Room No.:</label>
                            <input type="text" id="wardAndRoom" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                        </div>
                        <div id="postStepdownFields" class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4 md:col-span-2">
                            <div>
                                <label for="icuStepdownDate" class="block font-medium text-gray-700">ICU Stepdown Date:</label>
                                <input type="date" id="icuStepdownDate" class="time-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                            </div>
                            <div>
                                <label for="icuStepdownTime" class="block font-medium text-gray-700">ICU Stepdown Time-band:</label>
                                <select id="icuStepdownTime" class="time-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                    <option value="Morning (0600-1159)" data-ooh="false">Morning (0600-1159)</option>
                                    <option value="Afternoon (1200-1759)" data-ooh="false">Afternoon (1200-1759)</option>
                                    <option value="Evening (1800-2359)" data-ooh="true">Evening (1800-2359)</option>
                                    <option value="Night (0000-0559)" data-ooh="true">Night (0000-0559)</option>
                                </select>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                             <label for="losDays" class="block font-medium text-gray-700">ICU LOS (days):</label>
                             <input type="number" id="losDays" min="0" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg mb-6 p-6 space-y-6 print-hide">
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                     <h3 class="text-lg font-semibold text-gray-700 mb-4">Clinical Background</h3>
                     <div class="space-y-4">
                        <div>
                            <label for="goc" class="block text-sm font-medium text-gray-700">Goals of Care:</label>
                             <select id="goc" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                 <option value="">Not Documented</option><option value="A">A</option><option value="B">B</option><option value="C">C</option>
                             </select>
                             <div id="gocSpecificsContainer" class="hidden mt-2">
                                 <label for="gocSpecifics" class="block text-sm font-medium text-gray-700">Specifics:</label>
                                 <input type="text" id="gocSpecifics" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                             </div>
                        </div>
                        <div id="allergies-section">
                             <label class="block text-sm font-medium text-gray-700">Allergies:</label>
                             <div class="mt-2 space-y-2">
                                 <div class="flex items-center"><input type="checkbox" id="nkdaCheckbox" class="h-4 w-4 rounded"><label for="nkdaCheckbox" class="ml-2">No Known Drug Allergies</label></div>
                                 <div id="allergies_container" class="space-y-2"></div>
                                 <button type="button" id="addAllergyButton" class="no-print mt-2 text-sm bg-blue-100 text-blue-800 hover:bg-blue-200 px-3 py-1 rounded-md">+ Add Allergy</button>
                             </div>
                        </div>
                        <div>
                             <label class="block text-sm font-medium text-gray-700">Infection Control Precautions:</label>
                             <div class="mt-2 flex flex-wrap gap-x-4 gap-y-2">
                                 <label class="flex items-center"><input type="checkbox" name="precautions" class="precaution-cb" value="Contact"> <span class="ml-2">Contact</span></label>
                                 <label class="flex items-center"><input type="checkbox" name="precautions" class="precaution-cb" value="Droplet"> <span class="ml-2">Droplet</span></label>
                                 <label class="flex items-center"><input type="checkbox" name="precautions" class="precaution-cb" value="Airborne"> <span class="ml-2">Airborne</span></label>
                             </div>
                             <div id="infectionControlDetails" class="hidden mt-2">
                                 <label for="infectionControlReason" class="block text-sm font-medium text-gray-700">Reason:</label>
                                 <input type="text" id="infectionControlReason" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                             </div>
                        </div>
                    </div>
                </div>
                <div> <h3 class="text-lg font-semibold">Reason for ICU Admission:</h3> <textarea id="admissionReason" rows="3" class="mt-1 block w-full rounded-md border-2 border-gray-400 bg-gray-100 p-2"></textarea> </div>
                <div> <h3 class="text-lg font-semibold">ICU Summary / Timeline:</h3> <textarea id="icuSummary" rows="10" class="mt-1 block w-full rounded-md border-2 border-gray-400 bg-gray-100 p-2"></textarea> </div>
                <div> <h3 class="text-lg font-semibold">Past Medical History (PMH):</h3> <textarea id="pmh" rows="5" class="mt-1 block w-full rounded-md border-2 border-gray-400 bg-gray-100 p-2"></textarea> </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg mb-6 p-6">
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-gray-700 mb-2">Key Bloods</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                        <div class="flex items-center gap-x-2"><label class="block text-sm font-medium text-gray-700 w-20">Lactate</label><div class="flex-grow"><input type="number" step="0.1" id="lactate_input" class="blood-input mt-1 block w-full rounded-md border-2 p-2" placeholder="Current"><input type="number" step="0.1" id="lactate_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 p-2" placeholder="Prev."></div></div>
                        <div class="flex items-center gap-x-2"><label class="block text-sm font-medium text-gray-700 w-20">Hb</label><div class="flex-grow"><input type="number" id="hb_input" class="blood-input mt-1 block w-full rounded-md border-2 p-2" placeholder="Current"><input type="number" id="hb_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 p-2" placeholder="Prev."></div></div>
                        <div><div class="flex items-center gap-x-2"><label class="block text-sm font-medium w-20">K+</label><div class="flex-grow"><input type="number" step="0.1" id="k_input" class="blood-input mt-1 block w-full rounded-md border-2 p-2" placeholder="Current"><input type="number" step="0.1" id="k_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 p-2" placeholder="Prev."></div></div><div class="flex gap-x-4 mt-2 pl-24"><label class="flex items-center text-xs"><input type="checkbox" id="k_replaced_checkbox" class="h-3 w-3 mr-1"> Replaced</label> <label class="flex items-center text-xs"><input type="checkbox" id="k_planned_checkbox" class="h-3 w-3 mr-1"> Planned</label></div></div>
                        <div><div class="flex items-center gap-x-2"><label class="block text-sm font-medium w-20">Mg++</label><div class="flex-grow"><input type="number" step="0.1" id="mg_input" class="blood-input mt-1 block w-full rounded-md border-2 p-2" placeholder="Current"><input type="number" step="0.1" id="mg_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 p-2" placeholder="Prev."></div></div><div class="flex gap-x-4 mt-2 pl-24"><label class="flex items-center text-xs"><input type="checkbox" id="mg_replaced_checkbox" class="h-3 w-3 mr-1"> Replaced</label> <label class="flex items-center text-xs"><input type="checkbox" id="mg_planned_checkbox" class="h-3 w-3 mr-1"> Planned</label></div></div>
                        <div class="flex items-center gap-x-2"><label class="block text-sm font-medium w-20">Creatinine</label><div class="flex-grow"><input type="number" id="creatinine_input" class="blood-input mt-1 block w-full rounded-md border-2 p-2" placeholder="Current"><input type="number" id="creatinine_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 p-2" placeholder="Prev."></div></div>
                        <div class="flex items-center gap-x-2"><label class="block text-sm font-medium w-20">CRP</label><div class="flex-grow"><input type="number" id="crp_input" class="blood-input mt-1 block w-full rounded-md border-2 p-2" placeholder="Current"><input type="number" id="crp_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 p-2" placeholder="Prev."></div></div>
                        <div class="flex items-center gap-x-2"><label class="block text-sm font-medium w-20">Albumin</label><div class="flex-grow"><input type="number" id="albumin_input" class="blood-input mt-1 block w-full rounded-md border-2 p-2" placeholder="Current"><input type="number" id="albumin_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 p-2" placeholder="Prev."></div></div>
                        <div class="sm:col-span-2 mt-2 pt-2 border-t"><label class="flex items-center"><input type="checkbox" id="cts_cardiac_checkbox" class="blood-input"><span class="ml-2 text-sm font-medium">CTS/Cardiac Patient</span></label></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg mb-6 p-6 print-hide">
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-gray-700 mb-2">ADDS Calculator</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center"><label class="block text-sm font-medium sm:col-span-1">Resp Rate</label><div class="sm:col-span-2"><input type="number" id="rr_input" class="vital-input mt-1 w-full rounded-md border-2 p-2"></div></div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center"><label class="block text-sm font-medium sm:col-span-1">SpO2 (%)</label><div class="sm:col-span-2"><input type="number" id="spo2_input" class="vital-input mt-1 w-full rounded-md border-2 p-2"></div></div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center"><label class="block text-sm font-medium sm:col-span-1">Oxygen Delivery</label><div class="sm:col-span-2 flex items-center space-x-2"><input type="number" id="o2_flow_input" class="vital-input mt-1 w-full rounded-md border-2 p-2" placeholder="Value"><select id="o2_unit_input" class="vital-input mt-1 w-auto rounded-md border-2 p-2"><option value="L/min">L/min</option><option value="%">% FiO2</option></select></div></div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center"><label class="block text-sm font-medium sm:col-span-1">Heart Rate</label><div class="sm:col-span-2"><input type="number" id="hr_input" class="vital-input mt-1 w-full rounded-md border-2 p-2"></div></div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center"><label class="block text-sm font-medium sm:col-span-1">SBP (mmHg)</label><div class="sm:col-span-2"><input type="number" id="sbp_input" class="vital-input mt-1 w-full rounded-md border-2 p-2"></div></div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center"><label class="block text-sm font-medium sm:col-span-1">DBP (mmHg)</label><div class="sm:col-span-2"><input type="number" id="dbp_input" class="mt-1 w-full rounded-md border-2 p-2"></div></div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center"><label class="block text-sm font-medium sm:col-span-1">Consciousness</label><div class="sm:col-span-2"><select id="consciousness_input" class="vital-input mt-1 w-full rounded-md border-2 p-2"><option value="0">Alert</option><option value="1">Voice</option><option value="2">Pain</option><option value="3">Unresponsive</option></select></div></div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center"><label class="block text-sm font-medium sm:col-span-1">Temp (¬∞C)</label><div class="sm:col-span-2"><input type="number" step="0.1" id="temp_input" class="vital-input mt-1 w-full rounded-md border-2 p-2"></div></div>
                    </div>
                    <div class="mt-6 bg-gray-100 p-4 rounded-lg border"><label class="flex items-center"><input type="checkbox" id="addsModificationCheckbox"> <span class="ml-2 text-sm font-medium">Apply MODS to ADDS</span></label><div id="addsModificationDetails" class="hidden ml-6 mt-4 space-y-4"><div><label for="manualADDSScore" class="block text-sm font-medium">Manual Override ADDS Score:</label><input type="number" id="manualADDSScore" class="mt-1 w-full rounded-md border-2 p-2"></div><div><label for="addsModificationText" class="block text-sm font-medium">Modification Rationale:</label><textarea id="addsModificationText" rows="2" class="mt-1 w-full rounded-md border-2 p-2"></textarea></div></div></div>
                    <div class="mt-6 bg-teal-50 p-4 rounded-lg text-center border"><span class="text-sm font-medium text-gray-500">CALCULATED ADDS</span><div id="calculatedADDSScore" class="font-bold text-5xl text-teal-600 my-2">0</div><div id="addsBreakdown" class="text-xs text-gray-600 min-h-[1.5em]">Enter vitals to calculate</div></div>
                </div>
            </div>

            <div class="print-section-break"></div>

            <div class="bg-white rounded-xl shadow-lg mb-6 p-6 print-section">
                <div id="scoringContainer">
                    <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">RISK SCORING ASSESSMENT</h2>
                    <div class="space-y-8">
                        <div class="rounded-lg bg-blue-50 p-4"><h3 class="font-bold text-xl mb-3">Physiological & Respiratory Stability</h3><label class="score-option"><input type="checkbox" name="crit_met" class="score-input" data-score="15" data-is-critical="true"><span class="option-label"><span>Patient is in MET Criteria</span><span>(+15)</span></span></label><div class="score-group"><div class="score-group-title">ADDS Score</div><label class="score-option"><input type="radio" name="adds_score" class="score-input" data-score="1" checked><span class="option-label"><span>ADDS Score 0-2</span><span>(+1)</span></span></label><label class="score-option"><input type="radio" name="adds_score" class="score-input" data-score="5"><span class="option-label"><span>ADDS Score 3</span><span>(+5)</span></span></label><label class="score-option"><input type="radio" name="adds_score" class="score-input" data-score="10" data-is-critical="true"><span class="option-label"><span>ADDS Score ‚â• 4</span><span>(+10)</span></span></label></div><div class="score-group"><div class="score-group-title">Respiratory Trend</div><label class="score-option"><input type="checkbox" name="adds_worsening" class="score-input" data-score="5"><span class="option-label"><span>Worsening ADDS Trend (last 12-24h)</span><span>(+5)</span></span></label><label class="score-option"><input type="checkbox" name="resp_increasing_o2" class="score-input" data-score="10"><span class="option-label"><span>Increasing O‚ÇÇ requirements in last 12h</span><span>(+10)</span></span></label><label class="score-option"><input type="checkbox" name="resp_rapid_wean" class="score-input" data-score="6"><span class="option-label"><span>Rapid wean of resp support in last 4h</span><span>(+6)</span></span></label></div></div>
                        <div class="p-4 rounded-lg bg-yellow-50"><h3 class="font-bold text-xl mb-3">Clinical</h3><div class="score-group"><div class="score-group-title">Pain Score</div><div class="segmented-control"><label class="score-option"><input type="radio" name="pain_score" class="score-input" data-score="0" checked><span class="option-label">Controlled</span></label><label class="score-option"><input type="radio" name="pain_score" class="score-input" data-score="3"><span class="option-label">Needs IV</span></label><label class="score-option"><input type="radio" name="pain_score" class="score-input" data-score="5"><span class="option-label">PCA/Poorly Controlled</span></label></div></div><div class="score-group"><div class="score-group-title">Fluid Status</div><div class="segmented-control"><label class="score-option"><input type="radio" name="fluid_status_score" class="score-input" data-score="0" checked><span class="option-label">Euvolaemic</span></label><label class="score-option"><input type="radio" name="fluid_status_score" class="score-input" data-score="2"><span class="option-label">Mild Dehydration/Overload</span></label><label class="score-option"><input type="radio" name="fluid_status_score" class="score-input" data-score="4" data-is-critical="true"><span class="option-label">Significant Dehydration/Overload</span></label></div></div><div class="score-group"><div class="score-group-title">Diet</div><div class="segmented-control"><label class="score-option"><input type="radio" name="diet_score" class="score-input" data-score="0" checked><span class="option-label">Normal</span></label><label class="score-option"><input type="radio" name="diet_score" class="score-input" data-score="2"><span class="option-label">Modified</span></label><label class="score-option"><input type="radio" name="diet_score" class="score-input" data-score="4"><span class="option-label">NBM/NG/TPN</span></label></div></div><div class="score-group"><div class="score-group-title">Delirium</div><div class="segmented-control"><label class="score-option"><input type="radio" name="delirium_score" class="score-input" data-score="0" checked><span class="option-label">None</span></label><label class="score-option"><input type="radio" name="delirium_score" class="score-input" data-score="4"><span class="option-label">Mild</span></label><label class="score-option"><input type="radio" name="delirium_score" class="score-input" data-score="8" data-is-critical="true"><span class="option-label">Mod-Severe</span></label></div></div><div class="score-group"><div class="score-group-title">Mobility</div><div class="segmented-control"><label class="score-option"><input type="radio" name="mobility_score" class="score-input" data-score="0" checked><span class="option-label">Baseline</span></label><label class="score-option"><input type="radio" name="mobility_score" class="score-input" data-score="1"><span class="option-label">Limited</span></label><label class="score-option"><input type="radio" name="mobility_score" class="score-input" data-score="2"><span class="option-label">Assisted</span></label><label class="score-option"><input type="radio" name="mobility_score" class="score-input" data-score="5"><span class="option-label">Bed-bound</span></label></div></div><div class="score-group"><div class="score-group-title">Lines & Drains</div><label class="score-option"><input type="checkbox" name="lines_cvc_present" class="score-input" data-score="5"><span class="option-label"><span>Central Line present</span><span>(+5)</span></span></label><label class="score-option"><input type="checkbox" name="crit_af" class="score-input" data-score="10" data-is-critical="true"><span class="option-label"><span>Unstable Atrial Fibrillation</span><span>(+10)</span></span></label><label class="score-option"><input type="checkbox" name="airway_altered" class="score-input" data-score="5" data-is-critical="true"><span class="option-label"><span>Altered Airway (Trach/Lary)</span><span>(+5)</span></span></label><label class="score-option"><input type="checkbox" name="drains_high_risk" class="score-input" data-score="3"><span class="option-label"><span>High-Risk Drain present</span><span>(+3)</span></span></label><label class="score-option"><input type="checkbox" name="bowels_issue" class="score-input" data-score="3"><span class="option-label"><span>Bowels not opened >3 days or Ileus</span><span>(+3)</span></span></label><div class="grid grid-cols-2 gap-x-4 p-2 text-sm mt-2 border-t"><div><label for="bowel_last_open" class="block font-medium">Last Bowel Movement:</label><input type="date" id="bowel_last_open" class="mt-1 block w-full"></div><div><label for="bowel_type" class="block font-medium">Type:</label><select id="bowel_type" class="mt-1 block w-full"><option value="">Select...</option><option>Normal</option><option>Diarrhoea</option><option>Constipated</option><option>Ileus / Not passed flatus</option><option>Stoma Active</option></select></div></div></div></div>
                        <div class="p-4 rounded-lg bg-red-50"><h3 class="font-bold text-xl mb-3">Systemic</h3><div class="score-group"><div class="score-group-title">Patient Factors</div><label class="score-option"><input type="checkbox" id="losCheckbox" name="systemic_los" class="score-input" data-score="4"><span class="option-label"><span>ICU LOS > 3 days</span><span>(+4)</span></span></label><label class="score-option"><input type="checkbox" name="systemic_comorbid" class="score-input" data-score="4"><span class="option-label"><span>‚â•3 chronic comorbidities</span><span>(+4)</span></span></label></div><div class="score-group"><div class="score-group-title">Frailty (pre-hospital)</div><div class="segmented-control"><label class="score-option"><input type="radio" name="frailty_score" class="score-input" data-score="0" checked><span class="option-label">Not Frail</span></label><label class="score-option"><input type="radio" name="frailty_score" class="score-input" data-score="2"><span class="option-label">Mild</span></label><label class="score-option"><input type="radio" name="frailty_score" class="score-input" data-score="4"><span class="option-label">Mod-Severe</span></label></div></div><div id="after_hours_container" class="score-group"><label class="score-option"><input type="checkbox" id="systemic_after_hours_checkbox" name="systemic_after_hours" class="score-input"><span class="option-label"><span>After-Hours Discharge (first 24h)</span></span></label></div></div>
                        <div id="receivingWardModule" class="p-4 rounded-lg bg-indigo-50"><h3 class="font-bold text-xl mb-3">Receiving Ward and Staffing</h3><div class="score-group"><div class="score-group-title">Bed Type</div><div class="segmented-control"><label class="score-option"><input type="radio" name="bed_type" class="score-input" data-score="0" checked><span class="option-label">Unmonitored</span></label><label class="score-option"><input type="radio" name="bed_type" class="score-input" data-score="-3"><span class="option-label">Monitored</span></label></div></div><div class="score-group"><div class="score-group-title">Staffing</div><div class="segmented-control"><label class="score-option"><input type="radio" name="env_ratio" class="score-input" data-score="0" checked><span class="option-label">Standard Ratio</span></label><label class="score-option"><input type="radio" name="env_ratio" class="score-input" data-score="-5"><span class="option-label">Enhanced Ratio</span></label></div></div></div>
                        <div class="p-4 rounded-lg bg-yellow-50"><h3 class="font-bold text-xl mb-3">Nursing Concern</h3><div class="score-group"><div class="segmented-control"><label class="score-option"><input type="radio" name="concern_score" class="score-input" data-score="0" value="0" checked><span class="option-label">No Concerns</span></label><label class="score-option"><input type="radio" name="concern_score" class="score-input" data-score="5" value="5" data-is-critical="true"><span class="option-label">Concern Present</span></label></div><textarea id="nursingConcernText" class="mt-4 w-full rounded-md border-gray-300" rows="2" placeholder="Specify concern..." style="display: none;"></textarea></div></div>
                    </div>
                </div> 
            </div>

            <div class="bg-white rounded-xl shadow-lg mb-6 p-6 print-hide">
                <details class="bg-gray-50 p-4 rounded-lg border" open>
                    <summary class="font-semibold cursor-pointer">Device, Drain & Wound Assessment</summary>
                    <div class="space-y-6 pt-4">
                        <div><h4 class="font-medium">CVADs</h4><div id="central_lines_container" class="space-y-2"></div><button type="button" id="addCentralLineButton" class="no-print mt-2 text-sm bg-rose-100 px-3 py-1 rounded-md">+ Add CVAD</button></div>
                        <div class="mt-4 pt-4 border-t"><h4 class="font-medium">PIVCs</h4><div id="pivcs_container"  class="space-y-2"></div><button type="button" id="addPivcButton" class="no-print mt-2 text-sm bg-blue-100 px-3 py-1 rounded-md">+ Add PIVC</button></div>
                        <details class="pt-4 border-t"><summary class="text-sm font-medium">Show Additional</summary><div class="space-y-6 pt-4">
                            <div><h4 class="font-medium">IDC</h4><div id="idcs_container" class="space-y-2"></div><button type="button" id="addIdcButton" class="no-print mt-2 text-sm bg-gray-100 px-3 py-1 rounded-md">+ Add IDC</button></div>
                        </div></details>
                    </div>
                </details>
            </div>

            <div class="bg-white rounded-xl shadow-lg mb-6 p-6 space-y-6 print-hide">
                <h2 class="text-xl font-bold border-b pb-3">Final Assessment & Plan</h2>
                <div class="bg-gray-50 p-4 rounded-lg border"><h3 class="font-semibold mb-2">Fluid Balance</h3><div class="grid md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium">24hr Fluid Balance (mL)</label><input type="number" id="fbc_24hr_input" class="mt-1 w-full rounded-md border-2 p-2" step="100"></div><div><label class="block text-sm font-medium">Total ICU Balance (mL)</label><input type="number" id="fbc_total_input" class="mt-1 w-full rounded-md border-2 p-2" step="100"></div></div></div>
                <div><h3 class="text-lg font-semibold mb-2">PICS</h3><div class="p-4 rounded-lg module-bg-f"><div class="space-y-2"><div class="segmented-control"><label class="score-option"><input type="radio" name="pics_status" value="Negative" checked><span class="option-label">Negative</span></label><label class="score-option"><input type="radio" name="pics_status" value="Positive"><span class="option-label">Positive</span></label><label class="score-option"><input type="radio" name="pics_status" value="Unable to assess"><span class="option-label">Unable to assess</span></label></div><div id="pics_details_container" class="hidden pt-2"><label for="pics_notes" class="block text-sm font-medium">Plan:</label><textarea id="pics_notes" rows="2" class="mt-1 w-full rounded-md border-2 p-2" placeholder="Plan..."></textarea></div></div></div></div>
                <div><label class="flex items-center font-medium"><input type="checkbox" id="homeTeamPlanCheckbox" class="mr-2 h-4 w-4">Home Team Plan in Place</label><div id="homeTeamPlanDetails" class="hidden mt-2"><textarea id="homeTeamPlanText" rows="3" class="mt-1 w-full rounded-md border-2 p-2" placeholder="Enter plan details..."></textarea></div></div>
                <div><label for="emrAdditionalNotes" class="block font-medium">Additional Notes:</label><textarea id="emrAdditionalNotes" rows="4" class="mt-1 w-full rounded-md border-2 p-2"></textarea></div>
            </div>

            <div class="bg-white rounded-xl shadow-lg mt-6 p-6">
                <div class="final-score-bg text-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex flex-col sm:flex-row justify-between items-center text-center">
                        <div class="mb-4 sm:mb-0"><span class="text-lg font-medium text-gray-400">Final Score</span><div id="updatedTotalScore" class="text-5xl font-bold">0</div></div>
                        <div class="w-full sm:w-auto"><span class="text-lg font-medium text-gray-400">FINAL CATEGORY & ACTION</span><div id="updatedRiskCategory" class="text-xl font-bold p-3 rounded-md mt-1">Enter data</div></div>
                    </div>
                </div>
                <h2 class="text-xl font-bold border-b pb-3 mb-4">DMR Summary Generator</h2>
                <div class="flex space-x-4 mb-4 no-print">
                    <button type="button" id="generateSummaryButton" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg w-1/2">Generate</button>
                    <button type="button" id="copySummaryButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg w-1/2">Copy</button>
                </div>
                <textarea id="emrSummary" rows="25" class="w-full p-2 border rounded-md bg-gray-50 font-mono text-xs" placeholder="Your summary will appear here..."></textarea>
                <div class="mt-6 text-center no-print"><button type="button" id="resetButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Reset Form</button></div>
            </div>
        </form>
    </div>
    
    <div class="text-center mt-8 text-gray-500 text-sm no-print">Version 11.0.0 - Bugfix & Logic Overhaul</div>
    
    <script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE MANAGEMENT ---
    let patients = [];
    let currentPatientId = null;
    let deviceCounters = {};

    const RISK_CATEGORIES = {
        critical: { score: 25, text: 'CRITICAL: Escalate to ICU Liaison / MET / Critical Care', class: 'category-critical' },
        intensive_escalate: { score: 20, text: 'INTENSIVE+: Escalate to ICU Liaison / ANM', class: 'category-intensive-escalate' },
        intensive: { score: 11, text: 'INTENSIVE: Requires multiple reviews per day', class: 'category-intensive' },
        standard: { score: 5, text: 'STANDARD: At least one follow-up review required', class: 'category-standard' },
        single: { score: 0, text: 'SINGLE: Follow-up as required', class: 'category-single' }
    };
    
    const form = document.getElementById('assessmentForm');

    // --- INITIALIZATION ---
    function initializeApp() {
        loadState();
        const isMobile = window.innerWidth < 768 || navigator.userAgent.includes("Mobi");
        const launchModal = document.getElementById('launchScreenModal');
        const mainContent = document.getElementById('main-content');
        if (patients.length > 0) {
            renderTabs();
            switchPatientTab(currentPatientId || patients[0].id);
            mainContent.style.visibility = 'visible';
            launchModal.style.display = 'none';
        } else {
            if (isMobile) {
                launchModal.style.display = 'flex';
            } else {
                mainContent.style.visibility = 'visible';
                launchModal.style.display = 'none';
                addPatient();
            }
        }
        setupEventListeners();
    }

    // --- PATIENT & TAB MANAGEMENT ---
    function generatePatientId() { return `p_${Date.now()}`; }
    
    function addPatient() {
        if (currentPatientId) saveCurrentPatientData();
        const newPatientId = generatePatientId();
        patients.push({ id: newPatientId, data: {}, name: `Patient ${patients.length + 1}` });
        switchPatientTab(newPatientId);
    }
    
    function switchPatientTab(patientId) {
        if (!patientId) return;
        if (currentPatientId && currentPatientId !== patientId) saveCurrentPatientData();
        
        currentPatientId = patientId;
        loadPatientData(patientId);
        renderTabs();
        calculateTotalScore();
    }

    function deletePatient(patientId) {
        const index = patients.findIndex(p => p.id === patientId);
        if (index > -1) patients.splice(index, 1);
        if (currentPatientId === patientId) {
            currentPatientId = patients.length > 0 ? patients[Math.max(0, index - 1)].id : null;
        }
        if (patients.length === 0) {
            addPatient();
        } else {
            switchPatientTab(currentPatientId || patients[0].id);
        }
        saveState();
        renderTabs();
    }
    
    function renderTabs() {
        const container = document.getElementById('patientTabsContainer');
        container.innerHTML = '';
        patients.forEach(patient => {
            const score = patient.data?.finalScore || 0;
            const riskClass = getRiskCategory(score).class;
            const tab = document.createElement('div');
            tab.className = `patient-tab ${patient.id === currentPatientId ? 'active' : ''}`;
            tab.dataset.patientId = patient.id;
            tab.innerHTML = `<span class="tab-score-badge ${riskClass}">${score}</span><span class="tab-name">${patient.name}</span><button class="delete-patient-btn no-print" data-patient-id="${patient.id}">&times;</button>`;
            container.appendChild(tab);
            if (patient.id === currentPatientId) updateTabRiskClass(tab);
        });
    }

    function updateTabRiskClass(tabElement) {
        const patient = patients.find(p => p.id === tabElement.dataset.patientId);
        if (!patient || !patient.data) return;
        const categoryInfo = getRiskCategory(patient.data.finalScore || 0);
        const riskClass = { 'category-critical': 'risk-critical', 'category-intensive-escalate': 'risk-intensive-escalate', 'category-intensive': 'risk-intensive', 'category-standard': 'risk-standard', 'category-single': 'risk-single' }[categoryInfo.class] || 'risk-single';
        tabElement.className = `patient-tab ${patient.id === currentPatientId ? 'active' : ''} ${riskClass}`;
    }

    // --- DATA & STATE HANDLING ---
    function gatherFormData() {
        const data = {};
        form.querySelectorAll('input, select, textarea').forEach(el => {
            const key = el.id || el.name;
            if (!key || el.closest('.device-entry, .allergy-item')) return;
            if (el.type === 'checkbox') data[key] = el.checked;
            else if (el.type === 'radio') { if (el.checked) data[el.name] = el.value; }
            else data[key] = el.value;
        });
        data.allergies = Array.from(document.querySelectorAll('.allergy-item')).map(item => ({ name: item.querySelector('input[data-type="name"]').value, reaction: item.querySelector('input[data-type="reaction"]').value }));
        data.devices = {};
        ['central_lines', 'pivcs', 'idcs'].forEach(type => {
            data.devices[type] = Array.from(document.getElementById(`${type}_container`).querySelectorAll('.device-entry')).map(entry => {
                const deviceData = {};
                entry.querySelectorAll('input[data-key], select[data-key]').forEach(input => {
                    if (input.dataset.key) {
                        if (input.type === 'radio') { if(input.checked) deviceData[input.name] = input.value; }
                        else { deviceData[input.dataset.key] = input.value; }
                    }
                });
                return deviceData;
            });
        });
        return data;
    }

    function saveCurrentPatientData() {
        if (!currentPatientId) return;
        const patient = patients.find(p => p.id === currentPatientId);
        if (!patient) return;
        const formData = gatherFormData();
        patient.data = JSON.parse(JSON.stringify(formData));
        patient.name = formData.patientInitials || `Patient ${patients.findIndex(p => p.id === currentPatientId) + 1}`;
        patient.data.finalScore = parseInt(document.getElementById('updatedTotalScore').textContent) || 0;
        saveState();
    }
    
    function loadPatientData(patientId) {
        clearForm();
        const patient = patients.find(p => p.id === patientId);
        if (!patient || !patient.data) return;
        const data = JSON.parse(JSON.stringify(patient.data)); // Deep copy
        Object.keys(data).forEach(key => {
            const el = form.querySelector(`#${key}`) || form.querySelector(`[name="${key}"]`);
            if (el) {
                if (el.type === 'checkbox') el.checked = data[key];
                else if (el.type === 'radio') {
                    const radio = form.querySelector(`[name="${el.name}"][value="${data[el.name]}"]`);
                    if (radio) radio.checked = true;
                } else el.value = data[key];
            }
        });
        if (data.allergies) data.allergies.forEach(a => addAllergy(a.name, a.reaction));
        if (data.devices) {
             ['central_lines', 'pivcs', 'idcs'].forEach(type => {
                if (data.devices[type]) {
                    const addFunc = window[`add${type.charAt(0).toUpperCase() + type.slice(1).replace(/_s$/, '')}`];
                    if (addFunc) data.devices[type].forEach(device => addFunc(device));
                }
            });
        }
        form.querySelectorAll('input, select').forEach(el => el.dispatchEvent(new Event('change', { bubbles: true })));
    }

    function clearForm() {
        form.reset();
        deviceCounters = {};
        document.querySelectorAll('.device-entry, .allergy-item').forEach(el => el.remove());
        form.querySelectorAll('input, select').forEach(el => el.dispatchEvent(new Event('change', { bubbles: true })));
        calculateTotalScore();
        calculateADDS();
    }
    
    function saveState() { localStorage.setItem('alertToolState_v11', JSON.stringify({ patients, currentPatientId })); }
    function loadState() {
        const state = JSON.parse(localStorage.getItem('alertToolState_v11'));
        if (state) {
            patients = state.patients || [];
            currentPatientId = state.currentPatientId;
        }
    }
    function clearAllData() {
        if (confirm('Are you sure you want to delete ALL patient data?')) {
            patients = []; currentPatientId = null;
            localStorage.removeItem('alertToolState_v11');
            addPatient();
        }
    }
    
    // --- SCORING & CALCULATIONS ---
    function calculateTotalScore() {
        let score = 0;
        const hasCriticalItem = Array.from(form.querySelectorAll('.score-input:checked')).some(input => {
            score += parseInt(input.dataset.score, 10) || 0;
            return input.dataset.isCritical === 'true';
        });
        const totalScoreEl = document.getElementById('updatedTotalScore');
        totalScoreEl.title = '';
        if (hasCriticalItem && score < RISK_CATEGORIES.critical.score) {
            score = RISK_CATEGORIES.critical.score;
            totalScoreEl.textContent = `${score}*`;
            totalScoreEl.title = '*Score elevated due to critical risk item.';
        } else {
             totalScoreEl.textContent = score;
        }
        const category = getRiskCategory(score);
        const categoryEl = document.getElementById('updatedRiskCategory');
        categoryEl.textContent = category.text;
        categoryEl.className = `text-xl font-bold p-3 rounded-md mt-1 transition-all duration-300 ${category.class}`;
        if (currentPatientId) saveCurrentPatientData();
    }
    
    function getRiskCategory(score) {
        for (const key in RISK_CATEGORIES) { if (score >= RISK_CATEGORIES[key].score) return RISK_CATEGORIES[key]; }
        return RISK_CATEGORIES.single;
    }

    function calculateADDS() {
        const getScore = (val, ranges) => { for (const r of ranges) { if (val >= r.min && val <= r.max) return { score: r.score, text: r.text }; } return { score: 0, text: null }; };
        const p = (id) => parseFloat(document.getElementById(id).value);
        let total = 0; let breakdown = [];
        const rr = p('rr_input'); if (!isNaN(rr)) { const res = getScore(rr, [{min:0, max:8, score:2, text:"RR Low"}, {min:9, max:11, score:1, text:"RR Low"}, {min:21, max:29, score:2, text:"RR High"}, {min:30, max:999, score:3, text:"RR High"}]); total += res.score; if(res.text) breakdown.push(res.text);}
        const spo2 = p('spo2_input'); if (!isNaN(spo2)) { const res = getScore(spo2, [{min:0, max:89, score:3, text:"SpO2 Low"}, {min:90, max:93, score:2, text:"SpO2 Low"}, {min:94, max:95, score:1, text:"SpO2 Low"}]); total += res.score; if(res.text) breakdown.push(res.text);}
        const o2 = p('o2_flow_input'); if (!isNaN(o2) && o2 > 0) { total += 2; breakdown.push("On O2"); }
        const hr = p('hr_input'); if (!isNaN(hr)) { const res = getScore(hr, [{min:0, max:39, score:2, text:"HR Low"}, {min:40, max:49, score:1, text:"HR Low"}, {min:100, max:119, score:1, text:"HR High"}, {min:120, max:999, score:2, text:"HR High"}]); total += res.score; if(res.text) breakdown.push(res.text);}
        const sbp = p('sbp_input'); if (!isNaN(sbp)) { const res = getScore(sbp, [{min:0, max:79, score:3, text:"SBP Low"}, {min:80, max:99, score:2, text:"SBP Low"}, {min:200, max:999, score:2, text:"SBP High"}]); total += res.score; if(res.text) breakdown.push(res.text);}
        const cons = p('consciousness_input'); if (!isNaN(cons) && cons > 0) { total += 3; breakdown.push("Consciousness Not Alert"); }
        const temp = p('temp_input'); if (!isNaN(temp)) { const res = getScore(temp, [{min:0, max:35.0, score:2, text:"Temp Low"}, {min:38.1, max:38.9, score:1, text:"Temp High"}, {min:39.0, max:99, score:2, text:"Temp High"}]); total += res.score; if(res.text) breakdown.push(res.text);}
        document.getElementById('calculatedADDSScore').textContent = total;
        document.getElementById('addsBreakdown').textContent = breakdown.length > 0 ? breakdown.join(', ') : 'Normal Parameters';
    }

    // --- DEVICE MANAGEMENT ---
    function createDeviceEntryHTML(id, content) { return `<div id="${id}" class="device-entry bg-white p-3 rounded-md border border-gray-300 space-y-2">${content}<button type="button" class="remove-device-btn text-xs text-red-600 hover:underline no-print">Remove</button></div>`;}
    window.addCentral_line = function(data = {}) { deviceCounters.central = (deviceCounters.central || 0) + 1; document.getElementById('central_lines_container').insertAdjacentHTML('beforeend', createDeviceEntryHTML(`central_${deviceCounters.central}`, `<div class="grid grid-cols-2 gap-2 text-sm"><input type="text" data-key="type" value="${data.type || ''}" placeholder="Type (e.g., PICC)" class="p-1 border rounded-md"><input type="text" data-key="location" value="${data.location || ''}" placeholder="Location" class="p-1 border rounded-md"><input type="date" data-key="insertion_date" value="${data.insertion_date || ''}" class="p-1 border rounded-md col-span-2"></div>`)); }
    window.addPivc = function(data = {}) { deviceCounters.pivc = (deviceCounters.pivc || 0) + 1; document.getElementById('pivcs_container').insertAdjacentHTML('beforeend', createDeviceEntryHTML(`pivc_${deviceCounters.pivc}`, `<div class="grid grid-cols-2 gap-2 text-sm"><input type="text" data-key="location" value="${data.location || ''}" placeholder="Location" class="p-1 border rounded-md"><input type="date" data-key="insertion_date" value="${data.insertion_date || ''}" class="p-1 border rounded-md"></div>`)); }
    window.addIdc = function(data = {}) { deviceCounters.idc = (deviceCounters.idc || 0) + 1; document.getElementById('idcs_container').insertAdjacentHTML('beforeend', createDeviceEntryHTML(`idc_${deviceCounters.idc}`, `<div class="grid grid-cols-2 gap-2 text-sm items-center"><input type="date" data-key="insertion_date" value="${data.insertion_date || ''}" class="p-1 border rounded-md"><select data-key="size" class="p-1 border rounded-md bg-white"><option value="">Size</option><option value="12" ${data.size === '12' ? 'selected' : ''}>12 Ch</option><option value="14" ${data.size === '14' ? 'selected' : ''}>14 Ch</option><option value="16" ${data.size === '16' ? 'selected' : ''}>16 Ch</option></select></div>`)); }
    function addAllergy(name = '', reaction = '') { document.getElementById('allergies_container').insertAdjacentHTML('beforeend', `<div class="allergy-item flex items-center gap-2"><input type="text" data-type="name" value="${name}" placeholder="Allergen" class="flex-grow p-1 border rounded-md text-sm"><input type="text" data-type="reaction" value="${reaction}" placeholder="Reaction" class="flex-grow p-1 border rounded-md text-sm"><button type="button" class="remove-allergy-btn text-red-500 font-bold no-print">&times;</button></div>`);}
    
    // --- DMR & QR CODE ---
    function generateEMRSummary() {
        const val = (id) => document.getElementById(id)?.value?.trim() || 'N/A';
        const isChecked = (id) => document.getElementById(id)?.checked;
        let summary = `ALERT NURSE REVIEW:\n\n--- PATIENT & REVIEW DETAILS ---\n`;
        summary += `Patient: ${val('patientInitials')}\nLocation: ${val('wardAndRoom')}\n`;
        summary += `ICU Stepdown: ${val('icuStepdownDate')} @ ${val('icuStepdownTime')}\nICU LOS: ${val('losDays')} days\n`;
        summary += `\n--- CLINICAL BACKGROUND ---\n`;
        summary += `GOC: ${val('goc') || 'N/A'}${val('gocSpecifics') ? ` (${val('gocSpecifics')})` : ''}\n`;
        const precautions = Array.from(document.querySelectorAll('.precaution-cb:checked')).map(cb => cb.value).join(', ');
        summary += `Infection Control: ${precautions || 'None'}${precautions ? ` (Reason: ${val('infectionControlReason')})` : ''}\n`;
        if (isChecked('nkdaCheckbox')) { summary += `Allergies: NKDA\n`; }
        else { const allergies = Array.from(document.querySelectorAll('.allergy-item')).map(item => `${item.querySelector('input[data-type="name"]').value} (${item.querySelector('input[data-type="reaction"]').value})`).join('; '); summary += `Allergies: ${allergies || 'None'}\n`; }
        summary += `\n--- OBSERVATIONS (ADDS) ---\n`;
        summary += `Calculated ADDS: ${document.getElementById('calculatedADDSScore').textContent} (${document.getElementById('addsBreakdown').textContent})\n`;
        if(isChecked('addsModificationCheckbox')) { summary += `MODIFIED ADDS: ${val('manualADDSScore')} (Rationale: ${val('addsModificationText')})\n`; }
        summary += `Vitals: RR ${val('rr_input')}, SpO2 ${val('spo2_input')}% on ${val('o2_flow_input')}${val('o2_unit_input')}, HR ${val('hr_input')}, BP ${val('sbp_input')}/${val('dbp_input')}, Temp ${val('temp_input')}C\n`;
        
        summary += `\n--- RISK ASSESSMENT ---\n`;
        summary += `Final Score: ${document.getElementById('updatedTotalScore').textContent}\nCategory & Action: ${document.getElementById('updatedRiskCategory').textContent}\n`;
        if (isChecked('systemic_after_hours_checkbox')) {
            const stepdownTimeEl = document.getElementById('icuStepdownTime');
            const isOOH = stepdownTimeEl.options[stepdownTimeEl.selectedIndex].dataset.ooh === 'true';
            if ((new Date() - new Date(val('icuStepdownDate'))) / (1000*60*60*24) <= 1) {
                summary += `**! AFTER-HOURS DISCHARGE RISK (${isOOH ? 'OOH' : 'Afternoon'}) !**\n`;
            }
        }
        summary += `\nContributing Factors:\n`;
        document.querySelectorAll('.score-group').forEach(group => {
            const title = group.querySelector('.score-group-title').textContent;
            group.querySelectorAll('.score-option').forEach(option => {
                const input = option.querySelector('.score-input');
                const label = option.querySelector('.option-label span:first-child')?.textContent || option.querySelector('.option-label')?.textContent;
                if(input.type === 'radio'){
                    if(input.checked) summary += `- ${title}: ${label.replace(/\(\S+\)/, '').trim()}\n`;
                } else {
                    summary += `- ${label}: [${input.checked ? 'Yes' : 'No'}]\n`;
                }
            });
        });
        
        summary += `\n--- DEVICES ---\n`;
        const getDeviceText = (containerId, typeName) => Array.from(document.getElementById(containerId).querySelectorAll('.device-entry')).map(entry => `- ${typeName}: ` + Array.from(entry.querySelectorAll('input[data-key], select[data-key]')).map(input => input.value ? `${input.dataset.key.replace(/_/g, ' ')}: ${input.value}` : null).filter(Boolean).join(', ')).join('\n');
        ['central_lines', 'pivcs', 'idcs'].forEach(type => { const text = getDeviceText(`${type}_container`, type.replace('_', ' ').toUpperCase()); if(text) summary += text + '\n'; });

        summary += `\n--- ASSESSMENT & PLAN ---\n`;
        summary += `Fluid Balance: 24hr: ${val('fbc_24hr_input')}mL, Total ICU: ${val('fbc_total_input')}mL\n`;
        summary += `PICS: ${document.querySelector('input[name="pics_status"]:checked').value}. ${val('pics_notes') || ''}\n`;
        summary += `Home Team Plan: ${isChecked('homeTeamPlanCheckbox') ? `Yes - ${val('homeTeamPlanText')}` : 'No'}\n`;
        summary += `Nursing Concern: ${document.querySelector('input[name="concern_score"]:checked').value === '5' ? `Yes - ${val('nursingConcernText')}` : 'No'}\n`;
        summary += `Additional Notes: ${val('emrAdditionalNotes') || 'None'}\n`;

        document.getElementById('emrSummary').value = summary;
    }

    function gatherQrData() {
        const data = gatherFormData(); // Use the same data gathering function
        const qrData = {
            patientDetails: {
                reviewType: data.reviewType, patientInitials: data.patientInitials,
                wardAndRoom: data.wardAndRoom, icuStepdownDate: data.icuStepdownDate,
                icuStepdownTime: data.icuStepdownTime, losDays: data.losDays
            },
            clinicalBackground: {
                goc: data.goc, gocSpecifics: data.gocSpecifics, nkdaCheckbox: data.nkdaCheckbox,
                allergies: data.allergies, precautions: data.precautions,
                infectionControlReason: data.infectionControlReason, admissionReason: data.admissionReason,
                icuSummary: data.icuSummary, pmh: data.pmh
            },
            keyBloods: {
               lactate_input: data.lactate_input, lactate_input_prev: data.lactate_input_prev,
               hb_input: data.hb_input, hb_input_prev: data.hb_input_prev,
               k_input: data.k_input, k_input_prev: data.k_input_prev,
               mg_input: data.mg_input, mg_input_prev: data.mg_input_prev,
               creatinine_input: data.creatinine_input, creatinine_input_prev: data.creatinine_input_prev,
               crp_input: data.crp_input, crp_input_prev: data.crp_input_prev,
               albumin_input: data.albumin_input, albumin_input_prev: data.albumin_input_prev,
               cts_cardiac_checkbox: data.cts_cardiac_checkbox
            }
        };
        return qrData;
    }

    // --- EVENT LISTENER SETUP ---
    function setupEventListeners() {
        form.addEventListener('input', () => { saveCurrentPatientData(); calculateTotalScore(); });
        form.addEventListener('change', () => { saveCurrentPatientData(); calculateTotalScore(); });
        document.getElementById('addPatientBtn').addEventListener('click', addPatient);
        document.getElementById('clearDataBtn').addEventListener('click', clearAllData);
        document.getElementById('patientTabsContainer').addEventListener('click', (e) => {
            const tab = e.target.closest('.patient-tab');
            const delBtn = e.target.closest('.delete-patient-btn');
            if (delBtn) { e.stopPropagation(); if (confirm('Delete patient?')) deletePatient(delBtn.dataset.patientId); } 
            else if (tab) { switchPatientTab(tab.dataset.patientId); }
        });
        let activeRadio = null;
        form.addEventListener('mousedown', e => { if (e.target.type === 'radio') activeRadio = e.target.checked ? e.target : null; });
        form.addEventListener('click', e => { if (e.target.type === 'radio' && e.target === activeRadio) { e.target.checked = false; e.target.dispatchEvent(new Event('change', { bubbles: true })); activeRadio = null; } });
        
        document.getElementById('startFromScratchBtn').addEventListener('click', () => { document.getElementById('launchScreenModal').style.display = 'none'; document.getElementById('main-content').style.visibility = 'visible'; addPatient(); });
        document.getElementById('addCentralLineButton').addEventListener('click', () => window.addCentral_line());
        document.getElementById('addPivcButton').addEventListener('click', () => window.addPivc());
        document.getElementById('addIdcButton').addEventListener('click', () => window.addIdc());
        document.getElementById('addAllergyButton').addEventListener('click', () => addAllergy());
        document.addEventListener('click', (e) => { if (e.target.matches('.remove-device-btn, .remove-allergy-btn')) e.target.closest('div').remove(); });

        document.getElementById('homeTeamPlanCheckbox').addEventListener('change', e => { document.getElementById('homeTeamPlanDetails').style.display = e.target.checked ? 'block' : 'none'; });
        document.querySelectorAll('.precaution-cb').forEach(cb => cb.addEventListener('change', () => { document.getElementById('infectionControlDetails').style.display = document.querySelector('.precaution-cb:checked') ? 'block' : 'none'; }));
        document.getElementById('addsModificationCheckbox').addEventListener('change', e => { document.getElementById('addsModificationDetails').style.display = e.target.checked ? 'block' : 'none'; });
        document.getElementById('goc').addEventListener('change', e => { document.getElementById('gocSpecificsContainer').style.display = e.target.value ? 'block' : 'none'; });
        document.querySelectorAll('input[name="pics_status"]').forEach(r => r.addEventListener('change', e => { document.getElementById('pics_details_container').style.display = e.target.value !== 'Negative' ? 'block' : 'none'; }));
        document.querySelectorAll('input[name="concern_score"]').forEach(r => r.addEventListener('change', e => { document.getElementById('nursingConcernText').style.display = e.target.value === '5' ? 'block' : 'none'; }));
        
        form.querySelectorAll('.vital-input').forEach(el => el.addEventListener('input', calculateADDS));

        document.getElementById('printBlankBtn').addEventListener('click', () => { document.body.classList.add('print-blank-mode'); window.print(); document.body.classList.remove('print-blank-mode'); });
        document.getElementById('generateSummaryButton').addEventListener('click', generateEMRSummary);
        document.getElementById('copySummaryButton').addEventListener('click', () => { const el = document.getElementById('emrSummary'); el.select(); document.execCommand('copy'); alert('Summary copied!'); });
        document.getElementById('resetButton').addEventListener('click', () => { if (confirm('Reset form?')) clearForm(); });
        
        document.getElementById('sendToMobileBtn').addEventListener('click', () => {
            const qrCodeContainer = document.getElementById('qrcode');
            qrCodeContainer.innerHTML = '';
            const dataStr = JSON.stringify(gatherQrData());
            new QRCode(qrCodeContainer, { text: dataStr, width: 256, height: 256, correctLevel : QRCode.CorrectLevel.L });
            document.getElementById('qrCodeModal').style.display = 'flex';
        });
        document.getElementById('closeQRCodeModalBtn').addEventListener('click', () => document.getElementById('qrCodeModal').style.display = 'none');
    }
    
    initializeApp();
});    </script>

</body>
</html>
