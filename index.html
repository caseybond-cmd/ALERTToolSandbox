<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALERT Nursing Risk Assessment Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F0F9F9;
        }
        .category-critical { background-color: #DC2626; color: #FFFFFF; }
        .category-intensive-escalate { background-color: #F97316; color: #FFFFFF; }
        .category-intensive { background-color: #F59E0B; color: #1A202C; }
        .category-standard { background-color: #2DD4BF; color: #134E4A; }
        .category-single { background-color: #67E8F9; color: #164E63; }
        .header-gradient {
            background: linear-gradient(to right, #0D9488, #0F766E);
        }
        .final-score-bg {
            background-color: #134E4A;
        }
        .critical-input-label::after { content: '‚ùó'; color: #ef4444; margin-left: 6px; font-weight: bold; }
        .input-critical-alert { border-color: #ef4444 !important; background-color: #fee2e2 !important; }
        
        .risk-item-selected-amber {
            background-color: #fef3c7 !important;
            border-left: 4px solid #f59e0b !important;
            padding-left: 8px;
            border-radius: 4px;
        }
        .risk-item-selected-amber::before { content: '‚ö†Ô∏è'; color: #f59e0b; margin-right: 8px; font-weight: bold; }

        .risk-item-selected-critical { 
            border-left: 4px solid #ef4444 !important; 
            background-color: #fee2e2 !important; 
            padding-left: 8px; 
            border-radius: 4px; 
        }
        .risk-item-selected-critical > span { font-weight: 600; }
        .risk-item-selected-critical::before { content: '‚ùó'; color: #ef4444; margin-right: 8px; font-weight: bold; }
        
        .module-bg-b { background-color: #f0f9ff; }
        .module-bg-d { background-color: #fffbeb; }
        .module-bg-e { background-color: #fef2f2; }
        .module-bg-f { background-color: #faf5ff; }
        .module-bg-g { background-color: #f5f3ff; }
        
        .tabs-placeholder {
            color: #9CA3AF;
            padding: 1rem;
            text-align: center;
            font-style: italic;
            font-size: 0.875rem;
            border: 2px dashed #E5E7EB;
            border-radius: 6px;
        }
        .patient-tabs-container { border-bottom: 1px solid #D1D5DB; }
        .patient-tab { 
            position: relative;
            cursor: pointer; 
            padding: 0.75rem 1rem;
            color: #4B5563; 
            border: 1px solid transparent;
            border-bottom: none;
            border-top: 4px solid transparent;
            margin-bottom: -1px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        .patient-tab:hover { background-color: #F3F4F6; }
        .patient-tab.active { 
            border-color: #D1D5DB; 
            color: #047857; 
            font-weight: 600; 
            background-color: #FFFFFF;
        }
        .delete-patient-btn { color: #9CA3AF; font-size: 1.1rem; line-height: 1; padding: 2px; border-radius: 99px; }
        .delete-patient-btn:hover { color: #DC2626; background-color: #FEE2E2; }
        .tab-score-badge { font-size: 0.7rem; font-weight: 700; color: white; padding: 2px 6px; border-radius: 8px; }
        
        .patient-tab.active.risk-critical { border-top-color: #DC2626; }
        .patient-tab.active.risk-intensive-escalate { border-top-color: #F97316; }
        .patient-tab.active.risk-intensive { border-top-color: #F59E0B; }
        .patient-tab.active.risk-standard { border-top-color: #2DD4BF; }
        .patient-tab.active.risk-single { border-top-color: #67E8F9; }

        .ward-list-card {
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            overflow: hidden;
            font-family: sans-serif;
            font-size: 9pt;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            break-inside: avoid;
        }
        .ward-list-header { display: flex; justify-content: space-between; align-items: center; padding: 4px 8px; background-color: #F3F4F6; border-bottom: 1px solid #D1D5DB; }
        .ward-list-header h3 { font-size: 11pt; font-weight: bold; margin: 0; }
        .ward-list-header .score-box { text-align: right; }
        .ward-list-body { padding: 8px; flex-grow: 1; line-height: 1.4; }
        .ward-list-section { margin-bottom: 8px; }
        .ward-list-section h4 { font-size: 9pt; font-weight: bold; margin: 0 0 4px 0; padding-bottom: 2px; border-bottom: 1px solid #E5E7EB;}
        .ward-list-section p, .ward-list-section ul { margin: 0; font-size: 8.5pt; }
        .ward-list-section ul { padding-left: 1.2em; list-style-type: disc; }
        .data-grid-3 { display: grid; grid-template-columns: auto 1fr auto; gap: 2px 8px; align-items: center; font-size: 8.5pt;}
        .data-grid-3 strong { font-weight: bold; }
        .trend { font-style: italic; font-size: 8pt; color: #6B7280; }
        .blood-score { font-size: 0.75rem; font-weight: 600; padding: 2px 4px; border-radius: 4px; color: #fff; }
        .score-amber { background-color: #F59E0B; }
        .score-red { background-color: #EF4444; }

        #qr-reader {
            width: 100%;
            max-width: 500px;
            border: 2px solid #0D9488;
            border-radius: 8px;
            overflow: hidden;
        }

        @media print {
            .no-print { display: none !important; }
            body > *:not(#printoutContainer):not(.print-this) { display: none !important; }
            
            #printoutContainer, .print-this { display: block !important; }
            
            @page { 
                size: A4; 
                margin: 0.5in;
            }

            /* Print list styles */
            .print-list-mode #printoutContainer h1 { text-align: center; font-size: 14pt; margin-bottom: 1rem; }
            .print-list-mode .print-grid-container {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                grid-auto-rows: min-content;
                gap: 12px;
                height: 100%;
            }
             .print-list-mode @page { 
                size: A4 landscape;
            }

            /* Print blank form styles */
            .print-blank-mode #assessmentForm {
                display: block !important;
                box-shadow: none;
                border: 1px solid #ccc;
            }
             .print-blank-mode .final-score-bg, .print-blank-mode details > summary {
                display: none;
            }
             .print-blank-mode details {
                border: none;
            }
             .print-blank-mode details[open] {
                padding: 0;
            }
             .print-blank-mode input,  .print-blank-mode textarea,  .print-blank-mode select {
                border-bottom: 1px solid #000 !important;
                border-top: none !important;
                border-left: none !important;
                border-right: none !important;
                border-radius: 0 !important;
                padding: 4px 0 !important;
                background-color: transparent !important;
                box-shadow: none !important;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }
             .print-blank-mode input[type="checkbox"],  .print-blank-mode input[type="radio"] {
                border: 1px solid #000 !important;
                height: 1rem;
                width: 1rem;
            }
             .print-blank-mode label {
                color: #000 !important;
            }
        }
        .digital-list-container { display: flex; flex-direction: column; gap: 1rem; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div id="launchScreenModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex flex-col items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 text-center max-w-lg w-full">
            <h2 class="text-2xl md:text-3xl font-bold text-teal-700 mb-4">Welcome to the ALERT Tool</h2>
            <p class="text-gray-600 mb-6">Choose how you want to begin your workflow.</p>
            <div id="scannerContainer" class="hidden my-4 flex flex-col items-center">
                 <div id="qr-reader"></div>
                 <p id="qr-scan-result" class="mt-2 text-sm font-medium"></p>
            </div>
            <div id="launchButtons" class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="scanQRBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105">
                    üì≤ Scan QR Code
                </button>
                <button id="startFromScratchBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105">
                    üìù Start From Scratch
                </button>
            </div>
             <button id="stopScanningBtn" class="hidden mt-4 text-sm text-red-600 hover:underline">Cancel Scan</button>
        </div>
    </div>

     <div id="qrCodeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 text-center">
            <h2 class="text-xl font-bold mb-4">Send to Mobile</h2>
            <p class="text-sm text-gray-600 mb-4">Scan this QR code with the tool on your mobile device to load all patient data.</p>
            <div id="qrcode" class="flex justify-center"></div>
            <button id="closeQRCodeModalBtn" class="mt-6 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Close</button>
        </div>
    </div>

    <div id="main-content" class="max-w-4xl mx-auto" style="visibility: hidden;">
        <div class="bg-white rounded-xl shadow-lg mb-6 p-4">
            <div class="flex flex-wrap justify-end items-center gap-2 mb-3">
                 <button id="sendToMobileBtn" type="button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg text-sm transition-colors">üì≤ Send to Mobile</button>
                 <button id="addPatientBtn" type="button" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-3 rounded-lg text-sm transition-colors">Add Patient</button>
                 <div class="flex flex-wrap gap-2">
                    <button id="printListBtn" type="button" class="bg-blue-100 text-blue-800 hover:bg-blue-200 font-semibold py-2 px-3 rounded-lg text-sm transition-colors">Print List</button>
                    <button id="printBlankBtn" type="button" class="bg-gray-100 text-gray-800 hover:bg-gray-200 font-semibold py-2 px-3 rounded-lg text-sm transition-colors">Print Blank Form</button>
                    <button id="digitalListBtn" type="button" class="bg-indigo-100 text-indigo-800 hover:bg-indigo-200 font-semibold py-2 px-3 rounded-lg text-sm transition-colors">Digital List</button>
                 </div>
                 <button id="clearDataBtn" type="button" class="bg-red-100 text-red-800 hover:bg-red-200 font-semibold py-2 px-3 rounded-lg text-sm transition-colors">Clear All Data</button>
            </div>
            <div id="patientTabsContainer" class="patient-tabs-container flex flex-wrap items-center">
                <div id="tabsPlaceholder" class="w-full p-4 text-center border-2 border-dashed border-gray-200 rounded-md" style="display: none;">
                    <p class="text-sm text-gray-400 italic font-light">Patient tabs will appear here as you add them.</p>
                </div>
            </div>
        </div>

        <form id="assessmentForm" class="print-this" onsubmit="return false;">
            <div class="bg-white rounded-xl shadow-lg mb-6 overflow-hidden">
                <div class="header-gradient p-6 flex items-center justify-center text-white">
                    <div class="bg-white/20 rounded-full p-2 mr-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    </div>
                    <h1 class="text-2xl sm:text-3xl font-bold">ALERT Nursing Risk Assessment Tool</h1>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg mb-6 p-6 space-y-6">
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Patient & Review Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm">
                        <div class="md:col-span-2">
                            <label for="reviewType" class="block font-medium text-gray-700">Type of Review:</label>
                            <select id="reviewType" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                <option value="post">Post-ICU stepdown review on ward</option>
                                <option value="pre">Pre-ICU stepdown review</option>
                            </select>
                        </div>
                        <div>
                            <label for="patientInitials" class="block font-medium text-gray-700">Patient Initials:</label>
                            <input type="text" id="patientInitials" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                        </div>
                        <div>
                            <label for="wardAndRoom" class="block font-medium text-gray-700">Ward & Room No.:</label>
                            <input type="text" id="wardAndRoom" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                        </div>
                        <div id="postStepdownFields" class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                            <div>
                                <label for="icuStepdownDate" class="block font-medium text-gray-700">ICU Stepdown Date:</label>
                                <input type="date" id="icuStepdownDate" class="time-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                            </div>
                            <div>
                                <label for="icuStepdownTime" class="block font-medium text-gray-700">ICU Stepdown Time-band:</label>
                                <select id="icuStepdownTime" class="time-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                    <option value="09:00" data-ooh="false">Morning (0600-1159)</option>
                                    <option value="15:00" data-ooh="false">Afternoon (1200-1759)</option>
                                    <option value="21:00" data-ooh="true">Evening (1800-2359)</option>
                                    <option value="03:00" data-ooh="true">Night (0000-0559)</option>
                                </select>
                            </div>
                        </div>
                        <div>
                             <label for="losDays" class="block font-medium text-gray-700">ICU LOS (days):</label>
                             <input type="number" id="losDays" min="0" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                        </div>
                    </div>
                    <div class="mt-6 pt-4 border-t grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                             <label for="goc" class="block text-sm font-medium text-gray-700">Goals of Care:</label>
                             <select id="goc" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                 <option value="">Not Documented</option>
                                 <option value="A">A</option>
                                 <option value="B">B</option>
                                 <option value="C">C</option>
                             </select>
                             <div id="gocSpecificsContainer" class="hidden mt-2">
                                 <label for="gocSpecifics" class="block text-sm font-medium text-gray-700">Specifics:</label>
                                 <input type="text" id="gocSpecifics" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                             </div>
                        </div>
                        <div id="allergies-section">
                             <label class="block text-sm font-medium text-gray-700">Allergies:</label>
                             <div class="mt-2 space-y-2">
                                 <div class="flex items-center">
                                     <input type="checkbox" id="nkdaCheckbox" class="h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500">
                                     <label for="nkdaCheckbox" class="ml-2 block text-sm text-gray-900">No Known Drug Allergies (NKDA)</label>
                                 </div>
                                 <div id="allergies_container" class="space-y-2"></div>
                                 <button type="button" id="addAllergyButton" class="mt-2 text-sm bg-blue-100 text-blue-800 hover:bg-blue-200 px-3 py-1 rounded-md no-print">+ Add Allergy</button>
                             </div>
                        </div>
                        <div class="md:col-span-2">
                             <label class="block text-sm font-medium text-gray-700">Infection Control Precautions:</label>
                             <div class="mt-2 flex flex-wrap gap-x-4 gap-y-2">
                                 <label class="flex items-center"><input type="checkbox" name="precautions" class="precaution-cb" id="precaution-Contact" value="Contact"> <span class="ml-2">Contact</span></label>
                                 <label class="flex items-center"><input type="checkbox" name="precautions" class="precaution-cb" id="precaution-Droplet" value="Droplet"> <span class="ml-2">Droplet</span></label>
                                 <label class="flex items-center"><input type="checkbox" name="precautions" class="precaution-cb" id="precaution-Airborne" value="Airborne"> <span class="ml-2">Airborne</span></label>
                             </div>
                             <div id="infectionControlDetails" class="hidden mt-2">
                                 <label for="infectionControlReason" class="block text-sm font-medium text-gray-700">Reason:</label>
                                 <input type="text" id="infectionControlReason" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                             </div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Pre-Review Observations (last documented on DMR or Metavision)</h3>
                    <div class="space-y-2 text-sm">
                        <label class="flex items-center p-1"><input type="radio" name="pre_review_method" value="calculate" checked> <span class="ml-2">Calculate from Observations</span></label>
                        <label class="flex items-center p-1"><input type="radio" name="pre_review_method" value="direct"> <span class="ml-2">Enter Documented ADDS</span></label>
                    </div>
                    <div id="pre_review_direct_container" class="hidden mt-4 pl-6 space-y-3">
                        <div>
                            <label for="initialAdds" class="block text-sm font-medium text-gray-700">Last Documented ADDS:</label>
                            <input type="number" id="initialAdds" class="mt-1 block w-full md:w-1/2 rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                        </div>
                        <div>
                             <label class="flex items-center text-sm"><input type="checkbox" id="initialAddsModified"> <span class="ml-2">ADDS is modified</span></label>
                             <textarea id="initialAddsRationale" rows="2" class="hidden mt-2 w-full md:w-1/2 rounded-md border-2 border-gray-300 bg-white p-2 text-sm" placeholder="modification details/rationale..."></textarea>
                        </div>
                    </div>
                    <div id="pre_review_calculate_container" class="mt-4 pl-6 space-y-3">
                        <p class="text-xs italic text-gray-500">Enter the latest observations to get a preliminary score.</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-2 text-sm">
                             <div><label>RR</label><input type="number" id="pre_rr" class="pre-obs-input mt-1 block w-full rounded-md border-2 border-gray-300 p-1"></div>
                             <div><label>SpO2</label><input type="number" id="pre_spo2" class="pre-obs-input mt-1 block w-full rounded-md border-2 border-gray-300 p-1"></div>
                             <div><label>O2 Flow</label><input type="number" id="pre_o2" class="pre-obs-input mt-1 block w-full rounded-md border-2 border-gray-300 p-1"></div>
                             <div><label>O2 Unit</label><select id="pre_o2_unit" class="pre-obs-input mt-1 block w-full rounded-md border-2 border-gray-300 p-1"><option value="lpm">L/min</option><option value="fio2">%</option></select></div>
                             <div><label>HR</label><input type="number" id="pre_hr" class="pre-obs-input mt-1 block w-full rounded-md border-2 border-gray-300 p-1"></div>
                             <div><label>SBP</label><input type="number" id="pre_sbp" class="pre-obs-input mt-1 block w-full rounded-md border-2 border-gray-300 p-1"></div>
                             <div><label>Temp</label><input type="number" id="pre_temp" step="0.1" class="pre-obs-input mt-1 block w-full rounded-md border-2 border-gray-300 p-1"></div>
                             <div class="col-span-1 md:col-span-1"><label>Consciousness</label><select id="pre_consciousness" class="pre-obs-input mt-1 block w-full rounded-md border-2 border-gray-300 p-1"><option value="0">Alert</option><option value="1">Voice</option><option value="2">Pain</option><option value="3">Unresponsive</option></select></div>
                        </div>
                        <div class="mt-2 text-sm">
                            <span class="font-semibold">Calculated ADDS: <span id="pre_calculated_adds">0</span></span>
                             <label class="flex items-center mt-2"><input type="checkbox" id="preAddsModified"> <span class="ml-2">Manually modify pre-review ADDS</span></label>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Reason for ICU Admission:</h3>
                    <textarea id="admissionReason" rows="3" class="mt-1 block w-full rounded-md border-2 border-gray-400 bg-gray-100 shadow-sm p-2 text-sm"></textarea>
                </div>
                 <div>
                      <h3 class="text-lg font-semibold text-gray-700 mb-2">ICU Summary / Timeline:</h3>
                      <textarea id="icuSummary" rows="10" class="mt-1 block w-full rounded-md border-2 border-gray-400 bg-gray-100 shadow-sm p-2 text-sm"></textarea>
                 </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Past Medical History (PMH):</h3>
                    <textarea id="pmh" rows="5" class="mt-1 block w-full rounded-md border-2 border-gray-400 bg-gray-100 shadow-sm p-2 text-sm"></textarea>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-gray-700 mb-2">Key Bloods</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                        <div class="flex items-center gap-x-2"><label class="block text-sm font-medium text-gray-700 w-20" id="lactate_label">Lactate</label><div class="flex-grow"><input type="number" step="0.1" id="lactate_input" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Current"><input type="number" step="0.1" id="lactate_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Prev."></div><span id="lactate_score_display" class="blood-score"></span></div>
                        <div class="flex items-center gap-x-2"><label class="block text-sm font-medium text-gray-700 w-20" id="hb_label">Hb</label><div class="flex-grow"><input type="number" id="hb_input" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Current"><input type="number" id="hb_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Prev."></div><span id="hb_score_display" class="blood-score"></span></div>
                        <div>
                            <div class="flex items-center gap-x-2"><label class="block text-sm font-medium text-gray-700 w-20" id="k_label">K+</label><div class="flex-grow"><input type="number" step="0.1" id="k_input" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Current"><input type="number" step="0.1" id="k_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Prev."></div><span id="k_score_display" class="blood-score"></span></div>
                            <div class="flex gap-x-4 mt-2 pl-24"><label class="flex items-center text-xs"><input type="checkbox" id="k_replaced_checkbox" class="h-3 w-3 mr-1 blood-input"> Replaced</label> <label class="flex items-center text-xs"><input type="checkbox" id="k_planned_checkbox" class="h-3 w-3 mr-1 blood-input"> Planned/Ordered</label></div>
                        </div>
                        <div>
                            <div class="flex items-center gap-x-2"><label class="block text-sm font-medium text-gray-700 w-20" id="mg_label">Mg++</label><div class="flex-grow"><input type="number" step="0.1" id="mg_input" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Current"><input type="number" step="0.1" id="mg_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Prev."></div><span id="mg_score_display" class="blood-score"></span></div>
                            <div class="flex gap-x-4 mt-2 pl-24"><label class="flex items-center text-xs"><input type="checkbox" id="mg_replaced_checkbox" class="h-3 w-3 mr-1 blood-input"> Replaced</label> <label class="flex items-center text-xs"><input type="checkbox" id="mg_planned_checkbox" class="h-3 w-3 mr-1 blood-input"> Planned/Ordered</label></div>
                        </div>
                        <div class="flex items-center gap-x-2"><label class="block text-sm font-medium text-gray-700 w-20" id="creatinine_label">Creatinine</label><div class="flex-grow"><input type="number" id="creatinine_input" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Current"><input type="number" id="creatinine_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Prev."></div><span id="creatinine_score_display" class="blood-score"></span></div>
                        <div class="flex items-center gap-x-2"><label class="block text-sm font-medium text-gray-700 w-20" id="crp_label">CRP</label><div class="flex-grow"><input type="number" id="crp_input" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Current"><input type="number" id="crp_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Prev."></div><span id="crp_score_display" class="blood-score"></span></div>
                        <div class="flex items-center gap-x-2"><label class="block text-sm font-medium text-gray-700 w-20" id="albumin_label">Albumin</label><div class="flex-grow"><input type="number" id="albumin_input" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Current"><input type="number" id="albumin_input_prev" class="blood-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Prev."></div><span id="albumin_score_display" class="blood-score"></span></div>
                        <div class="sm:col-span-2 mt-2 pt-2 border-t">
                            <label class="flex items-center">
                                <input type="checkbox" id="cts_cardiac_checkbox" class="blood-input">
                                <span class="ml-2 text-sm font-medium text-gray-700">CTS/Cardiac Patient (apply stricter K+/Mg++ targets)</span>
                            </label>
                        </div>
                    </div>
                    <div id="bloods_summary_container" class="mt-4 pt-2 border-t text-sm space-y-1 font-bold text-red-600"></div>
                </div>

                <details class="bg-gray-50 p-4 rounded-lg border border-gray-200" open>
                    <summary class="font-semibold text-gray-700 cursor-pointer">Device, Drain & Wound Assessment</summary>
                    <div class="space-y-6 pt-4">
                        <div id="default_devices">
                             <h4 class="font-medium text-gray-600 mb-2">Central Vascular Access Devices (CVADs)</h4>
                            <div id="central_lines_container" class="space-y-4"></div>
                            <button type="button" id="addCentralLineButton" class="no-print mt-2 text-sm bg-rose-100 text-rose-800 hover:bg-rose-200 px-3 py-1 rounded-md">+ Add CVAD</button>
                        </div>
                         <div class="mt-6">
                             <h4 class="font-medium text-gray-600 mb-2">Peripheral IV Cannulas (PIVCs)</h4>
                             <div id="pivcs_container" class="space-y-4"></div>
                            <button type="button" id="addPivcButton" class="no-print mt-2 text-sm bg-blue-100 text-blue-800 hover:bg-blue-200 px-3 py-1 rounded-md">+ Add PIVC</button>
                         </div>
                        <details class="pt-4 border-t">
                            <summary class="text-sm font-medium text-blue-700 cursor-pointer">Show Additional Devices, Drains & Wounds</summary>
                            <div class="space-y-6 pt-4">
                                <div>
                                     <h4 class="font-medium text-gray-600 mb-2">GI / Enteral Devices</h4>
                                     <div id="ng_tubes_container" class="space-y-4"></div>
                                    <button type="button" id="addNgTubeButton" class="no-print mt-2 text-sm bg-green-100 text-green-800 hover:bg-green-200 px-3 py-1 rounded-md">+ Add Enteral Device</button>
                                </div>
                                <div id="pacing-wires-section">
                                      <h4 class="font-medium text-gray-600 mb-2">Epicardial Pacing Wires</h4>
                                      <div id="pacing_wires_container" class="space-y-4"></div>
                                      <button type="button" id="addPacingWiresButton" class="no-print mt-2 text-sm bg-purple-100 text-purple-800 hover:bg-purple-200 px-3 py-1 rounded-md">+ Add Pacing Wires</button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t">
                                    <div>
                                         <h4 class="font-medium text-gray-600 mb-2">Drains</h4>
                                         <div id="drains_container" class="space-y-4"></div>
                                        <button type="button" id="addDrainButton" class="no-print mt-2 text-sm bg-teal-100 text-teal-800 hover:bg-teal-200 px-3 py-1 rounded-md">+ Add Drain</button>
                                    </div>
                                    <div>
                                         <h4 class="font-medium text-gray-600 mb-2">Wounds</h4>
                                         <div id="wounds_container" class="space-y-4"></div>
                                        <button type="button" id="addWoundButton" class="no-print mt-2 text-sm bg-pink-100 text-pink-800 hover:bg-pink-200 px-3 py-1 rounded-md">+ Add Wound</button>
                                    </div>
                                </div>
                            </div>
                        </details>
                    </div>
                </details>
            </div>

            <div class="bg-white rounded-xl shadow-lg mb-6 p-6">
                 <div id="scoringContainer">
                     <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">RISK SCORING ASSESSMENT</h2>
                      <div class="space-y-8">
                           <div class="rounded-lg module-bg-b"><h3 class="font-bold text-xl mb-3 p-3 rounded-t-lg bg-blue-200 text-blue-800">Physiological & Respiratory Stability</h3><div class="space-y-2 p-4">
                                <label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="15" data-id="crit_met" data-is-critical="true"> <span class="ml-2">Patient is in MET Criteria</span> <span class="text-gray-600">(+15)</span></label>
                                <hr class="my-3">
                                <label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="10" data-id="crit_adds4" id="crit_adds4_checkbox" data-is-critical="true"> <span class="ml-2">ADDS Score ‚â• 4</span> <span class="text-gray-600">(+10)</span></label>
                                <label class="flex items-center p-1"><input type="radio" name="adds_score" class="score-input" data-score="5" data-id="adds_3" id="adds_3_radio" data-is-amber="true"> <span class="ml-2">ADDS Score 3</span> <span class="text-gray-600">(+5)</span></label>
                                <label class="flex items-center p-1"><input type="radio" name="adds_score" class="score-input" data-score="1" data-id="adds_0-2" id="adds_0-2_radio" > <span class="ml-2">ADDS Score 0-2</span> <span class="text-gray-600">(+1)</span></label>
                                <hr class="my-3">
                                <label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="5" data-id="adds_worsening" data-is-amber="true"> <span class="ml-2">Worsening ADDS Trend (last 12-24h) (+5)</span></label>
                                <label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="10" data-id="resp_increasing_o2" data-is-amber="true"> <span class="ml-2">Increasing O2 requirements in last 12h</span> <span class="text-gray-600">(+10)</span></label>
                                <label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="6" data-id="resp_rapid_wean" data-is-amber="true"> <span class="ml-2">Rapid weaning of resp support (e.g. FiO2, NIV, HFNP) in last 4h (+6)</span></label>
                            </div></div>
                           <div class="p-4 rounded-lg module-bg-d"><h3 class="font-bold text-xl mb-3 p-3 rounded-t-lg bg-yellow-200 text-yellow-800">Clinical</h3><div class="space-y-2 p-4"><label class="flex items-center p-1"><input type="radio" name="pain_score" class="score-input" data-score="0" data-id="pain_0" checked> <span class="ml-2 text-gray-500">Pain: None or Well Controlled</span></label><label class="flex items-center p-1"><input type="radio" name="pain_score" class="score-input" data-score="3" data-id="pain_iv"> <span class="ml-2">Pain: Requires regular IV or potent analgesia (+3)</span></label><label class="flex items-center p-1"><input type="radio" name="pain_score" class="score-input" data-score="5" data-id="pain_pca"> <span class="ml-2">Pain: Poorly controlled or PCA (+5)</span></label><hr class="my-2"><label class="flex items-center p-1"><input type="radio" name="fluid_status_score" class="score-input" data-score="0" data-id="fluid_0" id="fluid_0_radio" checked> <span class="ml-2 text-gray-500">Fluid Status: Euvolaemic</span></label><label class="flex items-center p-1"><input type="radio" name="fluid_status_score" class="score-input" data-score="2" data-id="fluid_mild" id="fluid_mild_radio"> <span class="ml-2">Mild dehydration or overload (+2)</span></label><label class="flex items-center p-1"><input type="radio" name="fluid_status_score" class="score-input" data-score="4" data-id="fluid_sig" id="fluid_sig_radio" data-is-critical="true"> <span class="ml-2">Significant dehydration or overload (+4)</span></label><hr class="my-2"><label class="flex items-center p-1"><input type="radio" name="diet_score" class="score-input" data-score="0" data-id="diet_0" checked> <span class="ml-2 text-gray-500">Diet: Normal</span></label><label class="flex items-center p-1"><input type="radio" name="diet_score" class="score-input" data-score="2" data-id="diet_modified"> <span class="ml-2">Diet: Supplements or Modified (+2)</span></label><label class="flex items-center p-1"><input type="radio" name="diet_score" class="score-input" data-score="4" data-id="diet_nbm"> <span class="ml-2">Diet: NBM, NG, or TPN (+4)</span></label><hr class="my-2"><label class="flex items-center p-1"><input type="radio" name="delirium_score" class="score-input" data-score="0" data-id="delirium_0" checked> <span class="ml-2 text-gray-500">Delirium: None</span></label><label class="flex items-center p-1"><input type="radio" name="delirium_score" class="score-input" data-score="4" data-id="delirium_mild"> <span class="ml-2">Delirium: Mild or Subsyndromal (+4)</span></label><label class="flex items-center p-1"><input type="radio" name="delirium_score" class="score-input" data-score="8" data-id="delirium_mod" data-is-critical="true"> <span class="ml-2">Delirium: Moderate to Severe</span> <span class="text-gray-600">(+8)</span></label><hr class="my-2"><label class="flex items-center p-1"><input type="radio" name="mobility_score" class="score-input" data-score="0" data-id="mobility_0" checked> <span class="ml-2 text-gray-500">Mobility: At Baseline</span></label><label class="flex items-center p-1"><input type="radio" name="mobility_score" class="score-input" data-score="1" data-id="mobility_limited"> <span class="ml-2">Mobility: Limited by devices or attachments (+1)</span></label><label class="flex items-center p-1"><input type="radio" name="mobility_score" class="score-input" data-score="2" data-id="mobility_assisted"> <span class="ml-2">Mobility: Assisted (+2)</span></label><label class="flex items-center p-1"><input type="radio" name="mobility_score" class="score-input" data-score="5" data-id="mobility_bedbound"> <span class="ml-2">Mobility: Bed-bound (+5)</span></label><hr class="my-2"><label class="flex items-center p-1"><input type="radio" name="lines_score" class="score-input" data-score="0" data-id="lines_0" checked> <span class="ml-2 text-gray-500">Lines: None or PIVC only</span></label><label class="flex items-center p-1"><input type="radio" name="lines_score" class="score-input" data-score="5" data-id="lines_cvc_present"> <span class="ml-2">Central Line present (CVC/PICC/Vascath) (+5)</span></label><hr class="my-3">
                                <label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="10" data-id="crit_af" data-is-critical="true"> <span class="ml-2">Unstable Atrial Fibrillation</span> <span class="text-gray-600">(+10)</span></label>
                                <div class="p-2 border-t mt-2">
                                    <label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="3" data-id="bowels_issue" id="bowels_issue_checkbox"> <span class="ml-2">Bowels not opened >3 days or Ileus (+3)</span></label>
                                    <div class="grid grid-cols-2 gap-x-4 pl-8 text-sm mt-1">
                                        <div>
                                            <label for="bowel_last_open" class="block font-medium text-gray-600">Last Bowel Movement:</label>
                                            <input type="date" id="bowel_last_open" class="bowel-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white p-1 text-sm">
                                        </div>
                                        <div>
                                            <label for="bowel_type" class="block font-medium text-gray-600">Type:</label>
                                            <select id="bowel_type" class="bowel-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white p-1 text-sm">
                                                <option value="">Select...</option>
                                                <option>Normal</option>
                                                <option>Diarrhoea</option>
                                                <option>Constipated</option>
                                                <option>Ileus / Not passed flatus</option>
                                                <option>Stoma Active</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="5" data-id="airway_altered" data-is-critical="true"> <span class="ml-2">Altered Airway (Tracheostomy/Laryngectomy) (+5)</span></label>
                                <label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="3" data-id="drains_high_risk"> <span class="ml-2">High-Risk Drain present <span class="text-gray-400 text-xs">(e.g., chest/subcostal, complex abdo, high output)</span> (+3)</span></label>
                            </div></div>
                           <div class="p-4 rounded-lg module-bg-e"><h3 class="font-bold text-xl mb-3 p-3 rounded-t-lg bg-red-200 text-red-800">Systemic</h3><div class="space-y-2 p-4">
                                <label class="flex items-center p-1"><input type="checkbox" id="losCheckbox" class="score-input" data-score="4" data-id="systemic_los"> <span class="ml-2">ICU LOS > 3 days</span> <span class="text-gray-600">(+4)</span></label>
                                <hr class="my-3">
                                <label class="flex items-center p-1"><input type="radio" name="frailty_score" class="score-input" data-score="0" data-id="frailty_0" checked> <span class="ml-2 text-gray-500">Frailty: Not Frail <span class="text-xs italic">(pre-hospital baseline)</span></span></label><label class="flex items-center p-1"><input type="radio" name="frailty_score" class="score-input" data-score="2" data-id="frailty_mild"> <span class="ml-2">Frailty: Mild <span class="text-xs italic">(pre-hospital baseline)</span> (+2)</span></label><label class="flex items-center p-1"><input type="radio" name="frailty_score" class="score-input" data-score="4" data-id="frailty_mod"> <span class="ml-2">Frailty: Mod-Severe <span class="text-xs italic">(pre-hospital baseline)</span> (+4)</span></label><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="4" id="comorbiditiesCheckbox" data-id="systemic_comorbid"> <span class="ml-2"><span class="comorbidity-main-text">‚â•3 chronic comorbidities</span> <span class="text-gray-400 text-xs">(e.g. IHD, COPD, T2DM)</span> (+4)</span></label>
                            <div id="after_hours_container"><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="0" data-id="systemic_after_hours" id="systemic_after_hours_checkbox" data-is-amber="true"> <span class="ml-2">After-Hours Discharge <span class="text-gray-400 text-xs">(only applies in first 24h)</span></span></label></div>
                           </div></div>
                           <div id="receivingWardModule" class="p-4 rounded-lg module-bg-g"><h3 class="font-bold text-xl mb-3 p-3 rounded-t-lg bg-indigo-200 text-indigo-800">Receiving Ward and Staffing</h3><div class="space-y-4 p-4"><div><h4 class="block text-sm font-medium text-gray-700 mb-2">Bed Type</h4><label class="flex items-center p-1"><input type="radio" name="bed_type" class="score-input" data-score="0" data-id="env_unmonitored" checked> <span class="ml-2">Unmonitored Bed (+0)</span></label><label class="flex items-center p-1"><input type="radio" name="bed_type" class="score-input" data-score="-3" data-id="env_monitored"> <span class="ml-2">Monitored / Telemetry Bed (-3)</span></label></div><hr><div><h4 class="block text-sm font-medium text-gray-700 mb-2">Staffing</h4><label class="flex items-center p-1"><input type="radio" name="env_ratio" class="score-input" data-score="0" data-id="env_standard" checked> <span class="ml-2">Standard Ward Ratio (+0)</span></label><label class="flex items-center p-1"><input type="radio" name="env_ratio" class="score-input" data-score="-5" data-id="env_enhanced"> <span class="ml-2">Enhanced Ratio (e.g. 1:1, 1:2) (-5)</span></label></div></div></div>
                           <div class="p-4 rounded-lg module-bg-d"><h3 class="font-bold text-xl mb-3 p-3 rounded-t-lg bg-yellow-200 text-yellow-800">Nursing Concern</h3><div class="pt-2 p-4"><label class="flex items-center p-1"><input type="radio" name="concern_score" class="score-input" data-score="0" data-id="concern_0" value="0" checked> <span class="ml-2 text-gray-500">Nursing Concern: None</span></label><label class="flex items-center p-1"><input type="radio" name="concern_score" class="score-input" data-score="5" data-id="concern_present" value="5" data-is-critical="true"> <span class="ml-2">Nursing Concern Present</span> <span class="text-gray-600">(+5)</span></label><textarea id="nursingConcernText" class="mt-2 ml-6 w-full rounded-md border-gray-300 shadow-sm text-sm" rows="2" placeholder="Specify concern..." style="display: none;"></textarea></div></div>

                     </div>
                 </div>

                <div class="final-score-bg text-white rounded-xl shadow-lg p-6 mt-8">
                    <div class="flex flex-col sm:flex-row justify-between items-center text-center">
                        <div class="mb-4 sm:mb-0">
                            <span class="text-lg font-medium text-gray-400">Preliminary Score</span>
                             <div id="totalScore" class="text-5xl font-bold">0</div>
                             <span class="text-xs text-gray-500">(pending patient review)</span>
                        </div>
                        <div class="w-full sm:w-auto"><span class="text-lg font-medium text-gray-400">Preliminary Category & Action</span><div id="riskCategory" class="text-xl font-bold p-3 rounded-md mt-1 transition-all duration-300"></div></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg mb-6 p-6 space-y-6">
                <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-6">ALERT Nurse Assessment</h2>
                <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-gray-700 mb-2">ADDS</h3>
                    <p class="text-xs italic text-gray-500 mb-4">Entering observations here will calculate a new ADDS and update the final score.</p>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center">
                            <label class="block text-sm font-medium text-gray-700 sm:col-span-1">Airway</label>
                            <div class="sm:col-span-2">
                                <select id="airway_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                    <option>Patent</option>
                                    <option>At Risk</option>
                                    <option>Tracheostomy</option>
                                    <option>Laryngectomy</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center">
                            <label class="block text-sm font-medium text-gray-700 sm:col-span-1">Resp Rate</label>
                            <div class="sm:col-span-2"><input type="number" id="rr_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center">
                            <label class="block text-sm font-medium text-gray-700 sm:col-span-1">SpO2 (%)</label>
                            <div class="sm:col-span-2"><input type="number" id="spo2_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center">
                            <label class="block text-sm font-medium text-gray-700 sm:col-span-1">Oxygen Delivery</label>
                            <div class="sm:col-span-2 flex items-center space-x-2">
                                <input type="number" id="o2_flow_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Value">
                                <select id="o2_unit_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="lpm">L/min</option><option value="fio2">% FiO2</option></select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center">
                            <label class="block text-sm font-medium text-gray-700 sm:col-span-1">Heart Rate</label>
                            <div class="sm:col-span-2"><input type="number" id="hr_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center">
                            <label class="block text-sm font-medium text-gray-700 sm:col-span-1">SBP (mmHg)</label>
                            <div class="sm:col-span-2"><input type="number" id="sbp_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center">
                            <label class="block text-sm font-medium text-gray-700 sm:col-span-1">DBP (mmHg)</label>
                            <div class="sm:col-span-2"><input type="number" id="dbp_input" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center">
                            <label class="block text-sm font-medium text-gray-700 sm:col-span-1">Consciousness</label>
                            <div class="sm:col-span-2"><select id="consciousness_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="0">Alert</option><option value="1">Voice</option><option value="2">Pain</option><option value="3">Unresponsive</option></select></div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center">
                            <label class="block text-sm font-medium text-gray-700 sm:col-span-1">Temp (¬∞C)</label>
                            <div class="sm:col-span-2"><input type="number" step="0.1" id="temp_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                        </div>
                    </div>

                    <div class="mt-6 bg-gray-100 p-4 rounded-lg border border-gray-300">
                         <label class="flex items-center"><input type="checkbox" id="addsModificationCheckbox" class="vital-input"> <span class="ml-2 text-sm font-medium text-gray-800">Apply MODS to ADDS</span></label>
                         <div id="addsModificationDetails" class="hidden ml-6 mt-4 space-y-4">
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 text-sm">
                                 <div class="space-y-1">
                                     <label class="flex items-center"><input type="checkbox" name="mod_param" value="RR"> <span class="ml-2 font-medium">Resp Rate</span></label>
                                     <div class="hidden mod-details space-y-2 pl-5 pt-2">
                                         <select data-param="rr" class="mod-operator mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="less_than">Less than</option><option value="greater_than">Greater than</option><option value="between">Between</option></select>
                                         <div class="flex items-center space-x-2">
                                             <input type="number" data-param="rr_val1" placeholder="Value" class="mod-value mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                             <span class="mod-val2-container" style="display:none;"><input type="number" data-param="rr_val2" placeholder="Max" class="mod-value mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></span>
                                         </div>
                                     </div>
                                 </div>
                                  <div class="space-y-1">
                                     <label class="flex items-center"><input type="checkbox" name="mod_param" value="HR"> <span class="ml-2 font-medium">Heart Rate</span></label>
                                     <div class="hidden mod-details space-y-2 pl-5 pt-2">
                                         <select data-param="hr" class="mod-operator mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="less_than">Less than</option><option value="greater_than">Greater than</option><option value="between">Between</option></select>
                                         <div class="flex items-center space-x-2">
                                             <input type="number" data-param="hr_val1" placeholder="Value" class="mod-value mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                             <span class="mod-val2-container" style="display:none;"><input type="number" data-param="hr_val2" placeholder="Max" class="mod-value mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></span>
                                         </div>
                                     </div>
                                 </div>
                                 <div class="space-y-1">
                                     <label class="flex items-center"><input type="checkbox" name="mod_param" value="SpO2"> <span class="ml-2 font-medium">SpO2</span></label>
                                     <div class="hidden mod-details flex items-center space-x-2 pl-5 pt-2">
                                         <span class="font-semibold">Target ></span>
                                         <input type="number" data-param="spo2_lower" placeholder="e.g. 88" class="mod-value mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                         <span>%</span>
                                     </div>
                                 </div>
                                  <div class="space-y-1">
                                     <label class="flex items-center"><input type="checkbox" name="mod_param" value="SBP"> <span class="ml-2 font-medium">SBP</span></label>
                                     <div class="hidden mod-details flex items-center space-x-2 pl-5 pt-2">
                                         <span class="font-semibold">Target ></span>
                                         <input type="number" data-param="sbp_lower" placeholder="e.g. 90" class="mod-value mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                     </div>
                                 </div>
                                 <div class="space-y-1 md:col-span-2">
                                     <label class="flex items-center"><input type="checkbox" name="mod_param" value="Consciousness"> <span class="ml-2 font-medium">Consciousness</span></label>
                                     <div class="hidden mod-details space-y-2 pl-5 pt-2">
                                         <label class="block text-xs font-medium text-gray-600">Consider 'Normal' if at or better than:</label>
                                         <select data-param="consciousness_baseline" class="mod-value mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                             <option value="0">Alert</option>
                                             <option value="1">Voice</option>
                                             <option value="2">Pain</option>
                                             <option value="3">Unresponsive</option>
                                         </select>
                                         <label class="block text-xs font-medium text-gray-600 mt-2">Notes (e.g., GCS target):</label>
                                         <input type="text" data-param="consciousness_notes" placeholder="e.g. GCS E4V5M6" class="mod-value mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                     </div>
                                 </div>
                             </div>
                              <div class="pt-4">
                                  <label for="addsModificationText" class="block text-sm font-medium text-gray-700">Modification Rationale:</label>
                                  <textarea id="addsModificationText" rows="2" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></textarea>
                              </div>
                         </div>
                    </div>

                    <div class="mt-6 bg-teal-50 p-4 rounded-lg text-center border border-teal-200">
                        <span class="text-sm font-medium text-gray-500">CALCULATED ADDS</span>
                        <div id="calculatedADDSScore" class="font-bold text-5xl text-teal-600 my-2">0</div>
                        <div id="addsBreakdown" class="text-xs text-gray-600 min-h-[3em]">Normal Parameters</div>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-gray-700 mb-2">Fluid Balance</h3>
                    <div class="flex flex-col space-y-4">
                        <div><label class="block text-sm font-medium text-gray-700">24hr Fluid Balance (mL)</label><input type="number" id="fbc_24hr_input" class="fluid-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="+/- mL" step="500"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Total ICU Balance (mL)</label><input type="number" id="fbc_total_input" class="fluid-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="+/- mL" step="500"></div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Post-ICU Syndrome (PICS)</h3>
                    <div class="p-4 rounded-lg module-bg-f">
                        <div class="space-y-2 p-4">
                            <div class="flex flex-wrap items-center gap-x-6 gap-y-2">
                                <label class="flex items-center text-sm"><input type="radio" name="pics_status" value="negative" checked> <span class="ml-2">Negative</span></label>
                                <label class="flex items-center text-sm"><input type="radio" name="pics_status" value="positive"> <span class="ml-2">Positive</span></label>
                                <label class="flex items-center text-sm"><input type="radio" name="pics_status" value="unable"> <span class="ml-2">Unable to assess</span></label>
                            </div>
                            <div id="pics_details_container" class="hidden ml-6 mt-2">
                                <label for="pics_notes" class="block text-sm font-medium text-gray-700">Information / Plan:</label>
                                <textarea id="pics_notes" rows="2" class="mt-1 block w-full rounded-md border-2 border-gray-400 bg-gray-100 shadow-sm p-2 text-sm" placeholder="Information/Plan..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                 <div>
                      <label class="flex items-center font-medium text-gray-600">
                          <input type="checkbox" id="homeTeamPlanCheckbox" class="mr-2">
                          Home Team Plan in Place
                      </label>
                      <div id="homeTeamPlanDetails" class="hidden mt-2">
                           <textarea id="homeTeamPlanText" rows="3" class="mt-1 block w-full rounded-md border-2 border-gray-400 bg-gray-100 shadow-sm p-2 text-sm" placeholder="Enter details of home team plan..."></textarea>
                      </div>
                 </div>
                 <div>
                      <label for="emrAdditionalNotes" class="block font-medium text-gray-600">Additional Notes:</label>
                      <textarea id="emrAdditionalNotes" rows="4" class="mt-1 block w-full rounded-md border-2 border-gray-400 bg-gray-100 shadow-sm p-2 text-sm"></textarea>
                 </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg mt-6 p-6">
                <div class="final-score-bg text-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex flex-col sm:flex-row justify-between items-center text-center">
                        <div class="mb-4 sm:mb-0">
                            <span class="text-lg font-medium text-gray-400">Updated Final Score</span>
                             <div id="updatedTotalScore" class="text-5xl font-bold">0</div>
                        </div>
                        <div class="w-full sm:w-auto"><span class="text-lg font-medium text-gray-400">FINAL CATEGORY & ACTION</span><div id="updatedRiskCategory" class="text-xl font-bold p-3 rounded-md mt-1 transition-all duration-300"></div></div>
                    </div>
                </div>
                <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">DMR Summary Generator</h2>
                <div class="flex space-x-4 mb-4 no-print"><button type="button" id="generateSummaryButton" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-1/2">Generate DMR Summary</button><button type="button" id="copySummaryButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors w-1/2">Copy to Clipboard</button></div>
                <textarea id="emrSummary" rows="20" class="w-full p-2 border border-gray-300 rounded-md bg-gray-50 font-mono text-xs" placeholder="Your summary will appear here..."></textarea>
                <div class="mt-6 text-center no-print"><button type="button" id="resetButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Reset Form</button></div>
            </div>
        </form>
    </div>
    
    <div id="digitalListModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-6xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-bold">Digital Ward List</h2>
                 <button id="closeDigitalListModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="digitalListContent" class="flex-grow overflow-y-auto border p-4 bg-gray-50 text-sm"></div>
            <div class="mt-4 flex justify-end space-x-2">
                <button id="copyDigitalListBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <div id="printoutContainer" class="hidden"></div>
    
    <div class="text-center mt-8 text-gray-500 text-sm">Version 6.0.0 - Hybrid Workflow Implemented</div>
    
    <script>
        // Moved constants to global scope to prevent reference errors.
        const categoryColorMap = {
            'risk-critical': '#DC2626',
            'risk-intensive-escalate': '#F97316',
            'risk-intensive': '#F59E0B',
            'risk-standard': '#2DD4BF',
            'risk-single': '#67E8F9'
        };

        const consciousnessMap = { '0': 'Alert', '1': 'Voice', '2': 'Pain', '3': 'Unresponsive' };
        
        const carePlanMap = { 'crit_met': 'CRITICAL: Patient is in MET Criteria. This is a significant barrier to transfer. Liaise with ICU and home teams to create a clear mitigation plan before stepdown.', 'crit_adds4': 'CRITICAL: High ADDS score indicates significant physiological instability. Escalate for urgent medical review (<30 mins) and ensure adherence to the AORC escalation pathway.', 'crit_lactate_high': 'CRITICAL: Critically high lactate suggests potential tissue hypoperfusion. Escalate immediately to the medical team for urgent review.', 'crit_af': "CRITICAL: Unstable AF (e.g., with hypotension) requires urgent intervention. Escalate for cardiology/medical review and complete 12-lead ECG.", 'crit_hb_drop': 'CRITICAL: Significant Hb drop or active bleeding requires urgent investigation. Escalate for urgent medical/surgical review, ensure IV access, and consider group and hold.', 'resp_increasing_o2': 'Respiratory Plan: Increasing O2 needs noted. Perform focused respiratory assessments (work of breathing) per AORC. Ensure clear documentation of Resp Rate and O2 requirements to monitor trends. Liaise with medical team to review.', 'resp_rapid_wean': 'Respiratory Plan: Recent rapid wean of respiratory support. Perform focused respiratory assessments (work of breathing) per AORC and ensure clear documentation of Resp Rate and O2 requirements to monitor for signs of fatigue.', 'bloods_electrolytes': 'Biochemical Plan: Significant electrolyte abnormalities noted. Escalate to medical officer for review and prescribing of replacement therapy. For severe K+ abnormalities, escalate to senior nursing staff and contact ALERT CNS for support regarding patient placement and monitoring.', 'bloods_lactate_mid': 'Biochemical Plan: Liaise with medical team for serial lactate measurement within 4 hours to ensure clearance. Continue to review fluid status and clinical signs of perfusion.', 'bloods_creatinine': 'Biochemical Plan: Maintain strict fluid balance chart. Ensure urine output remains >0.5ml/kg/hr and escalate to the medical team if it falls below this target. Liaise with pharmacy to review for nephrotoxic medications.', 'bloods_albumin': 'Nutrition Plan: Significant hypoalbuminaemia noted. Ensure active dietitian referral for nutritional assessment and planning. Monitor for oedema.', 'bloods_anaemia': 'Haematology Plan: Monitor for signs of occult bleeding or haemodynamic instability. Liaise with medical team to clarify transfusion threshold.', 'pain_pca': 'Pain Management: Pain appears poorly controlled. Perform comprehensive pain assessments (score 0-10) with each set of observations. Ensure prescribed analgesia is optimised and offered regularly. Escalate to the Acute Pain Service if pain remains severe.', 'fluid_sig': 'Fluid Management: Significant fluid imbalance identified. Maintain strict fluid balance chart and daily weights. Perform clinical fluid assessment (peripheral oedema, lung auscultation). Liaise with medical team to review fluid orders. Please contact ALERT CNS for support with assessment if required.', 'delirium_mod': 'Cognitive Support: Implement delirium prevention strategies (e.g., reorientation, day/night cycle, family presence). Liaise with the medical team and pharmacy to review for potential deliriogenic medications.', 'mobility_bedbound': 'Mobility & Pressure Care: Implement pressure injury prevention bundle: Regular turns, pressure-relieving mattress, skin assessment. Liaise with physiotherapy for in-bed exercise plan.', 'airway_altered': 'Airway Management: Ensure patient is in an appropriate bed location with trained staff. Confirm required emergency equipment (e.g., spare inner cannula, spare tracheostomy tube of same/smaller size, obturator, 10ml syringe, trach dilators) is present and checked at the bedside. Contact ALERT CNS for support if required.', 'lines_cvc_present': 'Line Management: Daily review of Central Line necessity with medical team (to minimise line days). Maintain strict ANTT for all access and monitor site for signs of infection (CLABSI bundle).', 'drains_high_risk': 'Drain Management: Maintain close monitoring of drain patency, output characteristics, and volume. Escalate immediately to the home team for any sudden changes, particularly for outputs >100ml/hr of fresh blood, or signs of blockage.', 'bowels_issue': 'Bowel Management: Patient has not opened bowels >3 days. Monitor for signs of abdominal distension or discomfort. Escalate to the medical team for review and consideration of aperients.', 'concern_present': "Nursing Concerns: Articulate specific nursing concerns and escalate to senior nursing/medical staff for a 'fresh eyes' review of the patient's trajectory.", 'frailty_mod': 'Frailty Plan: Ensure referrals to Physiotherapy and Occupational Therapy are active to support mobility and function. Focus on falls prevention and nutritional support.', 'after_hours_high_risk': 'TRANSFER SAFETY ALERT: This high-risk patient had an after-hours discharge. Ensure handover to the ward team is exceptionally detailed, highlighting key risks for the first 24 hours.', 'after_hours_very_high_risk': 'CRITICAL RISK: This patient\'s high score combined with an after-hours discharge represents a significant risk of readmission. A direct, senior-level (Registrar or Consultant) discussion between ICU and the receiving home team is strongly recommended before transfer.' };
        
        const impressionMap = {'crit_met':'is currently meeting MET criteria','crit_adds4':'has a high ADDS score indicating physiological instability','crit_lactate_high':'has a critically high lactate concerning for hypoperfusion','crit_af':'is in unstable atrial fibrillation','crit_hb_drop':'has had a significant drop in haemoglobin or is actively bleeding','resp_increasing_o2':'has increasing oxygen requirements','delirium_mod':'is suffering from moderate to severe delirium','fluid_sig':'has a significant fluid imbalance','pain_pca':'has poorly controlled pain requiring advanced analgesia','concern_present':'has specific concerns raised by the bedside nursing staff'};
        
        let standardScores = { getRrScore(rr) { let s=0,m=false; if(rr>=36||rr<5)m=true;else if(rr>=30&&rr<=35)s=3;else if(rr>=25&&rr<=29)s=2;else if(rr>=21&&rr<=24)s=1;else if(rr>=5&&rr<=9)s=3; return {score:s, isMet:m}; }, getSpo2Score(spo2) { let s=0,m=false; if(spo2<=84)m=true;else if(spo2>=85&&spo2<=90)s=2;else if(spo2>=91&&spo2<=93)s=1; return {score:s, isMet:false}; }, getO2Score(o2Flow, o2Unit) { let s=0; if(o2Unit==='lpm'){if(o2Flow>10)s=3;else if(o2Flow>=5&&o2Flow<=9)s=2;else if(o2Flow>=2&&o2Flow<=4)s=1}else{if(o2Flow>=40)s=3;else if(o2Flow>=29)s=2;else if(o2Flow>=21)s=1} return {score:s, isMet:false}; }, getHrScore(hr) { let s=0,m=false; if(hr>=140||hr<30)m=true;else if(hr>=130&&hr<=139)s=3;else if(hr>=120&&hr<=129)s=2;else if(hr>=100&&hr<=119)s=1;else if(hr>=40&&hr<=49)s=1;else if(hr>=30&&hr<=39)s=2; return {score:s, isMet:m}; }, getSbpScore(sbp) { let s=0,m=false; if(sbp<90)m=true;else if(sbp>=190&&sbp<=199)s=3;else if(sbp>=180&&sbp<=189)s=2;else if(sbp>=150&&sbp<=179)s=1;else if(sbp>=80&&sbp<=99)s=1;else if(sbp>=70&&sbp<=79)s=2; return {score:s, isMet:m}; }, getConsciousnessScore(c) { let s=0,m=false; if(c===3)m=true;else if(c>0)s=c; return {score:s, isMet:m}; } };

    document.addEventListener('DOMContentLoaded', () => {
        // --- Element References ---
        const assessmentForm = document.getElementById('assessmentForm');
        const scoreInputs = document.querySelectorAll('.score-input');
        const totalScoreEl = document.getElementById('totalScore');
        const riskCategoryEl = document.getElementById('riskCategory');
        const updatedTotalScoreEl = document.getElementById('updatedTotalScore');
        const updatedRiskCategoryEl = document.getElementById('updatedRiskCategory');
        const emrSummaryEl = document.getElementById('emrSummary');
        const calculatedADDSEl = document.getElementById('calculatedADDSScore');
        const addsBreakdownEl = document.getElementById('addsBreakdown');
        const picsDetailsContainer = document.getElementById('pics_details_container');
        const nursingConcernText = document.getElementById('nursingConcernText');
        const postStepdownFields = document.getElementById('postStepdownFields');
        const afterHoursContainer = document.getElementById('after_hours_container');
        const afterHoursCheckbox = document.getElementById('systemic_after_hours_checkbox');
        const gocSpecificsContainer = document.getElementById('gocSpecificsContainer');
        const allergiesContainer = document.getElementById('allergies_container');
        const infectionControlDetails = document.getElementById('infectionControlDetails');
        const centralLinesContainer = document.getElementById('central_lines_container');
        const pivcsContainer = document.getElementById('pivcs_container');
        const ngTubesContainer = document.getElementById('ng_tubes_container');
        const pacingWiresContainer = document.getElementById('pacing_wires_container');
        const drainsContainer = document.getElementById('drains_container');
        const woundsContainer = document.getElementById('wounds_container');
        const homeTeamPlanDetails = document.getElementById('homeTeamPlanDetails');
        const patientTabsContainer = document.getElementById('patientTabsContainer');
        const tabsPlaceholder = document.getElementById('tabsPlaceholder');
        const digitalListModal = document.getElementById('digitalListModal');
        const digitalListContent = document.getElementById('digitalListContent');
        const printoutContainer = document.getElementById('printoutContainer');
        const addsModificationDetails = document.getElementById('addsModificationDetails');
        const preReviewDirectContainer = document.getElementById('pre_review_direct_container');
        const preReviewCalculateContainer = document.getElementById('pre_review_calculate_container');
        const initialAddsRationale = document.getElementById('initialAddsRationale');
        const launchScreenModal = document.getElementById('launchScreenModal');
        const mainContent = document.getElementById('main-content');
        const qrCodeModal = document.getElementById('qrCodeModal');
        const qrcodeContainer = document.getElementById('qrcode');
        let html5QrCode = null;


        // --- State Management ---
        let patients = {};
        let activePatientId = null;
        const LOCAL_STORAGE_KEY = 'alertToolPatientData_v6.0'; 
        let currentAddsBreakdown = 'Normal Parameters';
        let addsScoreContribution = 0;
        
        const safeGet = (id) => document.getElementById(id)?.value || '';
        const safeIsChecked = (id) => document.getElementById(id)?.checked || false;
        const getSelectText = (selectEl) => selectEl ? (selectEl.options[selectEl.selectedIndex]?.text || '') : '';
        const safeGetNum = (id) => { const val = parseFloat(safeGet(id)); return isNaN(val) ? null : val; };
        
        function resetForm(){
            assessmentForm.reset();
            document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], textarea').forEach(el => el.value = '');
            document.querySelectorAll('select').forEach(el => el.selectedIndex = 0);
            document.querySelectorAll('input[type="checkbox"]').forEach(input => input.checked = false);
            document.querySelectorAll('input[type="radio"]').forEach(rb=>{if(rb.dataset.score==="0" || rb.value==="negative" || rb.value==="0" || rb.value==="calculate"){rb.checked=true}});
            nursingConcernText.style.display='none';
            gocSpecificsContainer.classList.add('hidden');
            allergiesContainer.innerHTML = '';
            allergiesContainer.style.display = 'block';
            document.getElementById('addAllergyButton').style.display = 'block';
            infectionControlDetails.classList.add('hidden');
            homeTeamPlanDetails.classList.add('hidden');
            document.getElementById('homeTeamPlanText').value = '';

            [centralLinesContainer, pivcsContainer, ngTubesContainer, drainsContainer, woundsContainer, pacingWiresContainer].forEach(c => c.innerHTML = '');
            picsDetailsContainer.classList.add('hidden');
            emrSummaryEl.value = '';
            addsModificationDetails.classList.add('hidden');
            addsModificationDetails.querySelectorAll('.mod-details').forEach(d => d.classList.add('hidden'));


            document.querySelectorAll('.input-critical-alert, .critical-input-label, .risk-item-selected-critical, .risk-item-selected-amber').forEach(el => {
                el.classList.remove('input-critical-alert', 'critical-input-label', 'risk-item-selected-critical', 'risk-item-selected-amber');
            });
            
            preReviewDirectContainer.style.display = 'none';
            preReviewCalculateContainer.style.display = 'block';
            initialAddsRationale.classList.add('hidden');


            document.getElementById('reviewType').dispatchEvent(new Event('change'));
            calculateADDS();
        }

        function calculateScore() {
            let totalScore = addsScoreContribution + (window.bloodsScoreContribution || 0);
            scoreInputs.forEach(input => {
                 if (input.name === 'adds_score') return; // Exclude ADDS radios as they are handled by addsScoreContribution
                if (input.checked) {
                    totalScore += parseInt(input.dataset.score, 10) || 0;
                }
            });
            totalScoreEl.textContent = totalScore;
            updatedTotalScoreEl.textContent = totalScore;
            updateRiskCategory(totalScore);
        }

        function getCategoryClass(score) {
            if (score > 40) return 'risk-critical';
            if (score >= 30) return 'risk-intensive-escalate';
            if (score >= 10) return 'risk-intensive';
            if (score >= 4) return 'risk-standard';
            return 'risk-single';
        }

        function updateRiskCategory(score) {
            let categoryText = '';
            let categoryClass = '';
            let followUpMessage = '';
            const stepdownDateStr = safeGet('icuStepdownDate');

            if (score > 40) {
                categoryText = 'Critical Risks Identified - Immediate Senior Review';
                categoryClass = 'category-critical';
            } else if (score >= 30) {
                categoryText = 'Intensive ALERT Post ICU follow up (72hrs) + Consider ALERT Medical Team Escalation';
                categoryClass = 'category-intensive-escalate';
            } else if (score >= 10) {
                categoryText = 'Intensive ALERT Post ICU follow up for up to 72hrs on ward';
                categoryClass = 'category-intensive';
            } else if (score >= 4) {
                categoryText = 'Standard ALERT Post ICU follow up for up to 24 hours on ward';
                categoryClass = 'category-standard';
            } else {
                categoryText = 'At least one follow-up review required on ward';
                categoryClass = 'category-single';
            }

            if (stepdownDateStr) {
                const stepdownDate = new Date(stepdownDateStr);
                const now = new Date();
                const hoursSince = (now - stepdownDate) / (1000 * 60 * 60);
                if (score >= 0 && score <= 3) {
                    followUpMessage = 'Minimum follow-up time met. Consider if safe to discharge from ALERT.';
                } else if (score >= 4 && score <= 9 && hoursSince > 24) {
                    followUpMessage = '24hr follow-up period met. Consider if safe to discharge from ALERT.';
                } else if (score >= 10 && hoursSince > 72) {
                    followUpMessage = '72hr follow-up period met. Consider adding to Patient of Concern list for continued follow-up.';
                }
            }
            
            const fullHtml = `${categoryText} <br> <span class="text-sm font-normal">${followUpMessage}</span>`;
            riskCategoryEl.innerHTML = fullHtml;
            riskCategoryEl.className = `text-xl font-bold p-3 rounded-md mt-1 transition-all duration-300 ${categoryClass}`;
            updatedRiskCategoryEl.innerHTML = fullHtml;
            updatedRiskCategoryEl.className = `text-xl font-bold p-3 rounded-md mt-1 transition-all duration-300 ${categoryClass}`;
        }

        function applyMods() {
            const mods = {};
            document.querySelectorAll('input[name="mod_param"]:checked').forEach(cb => {
                const param = cb.value.toLowerCase();
                const container = cb.closest('.space-y-1');
                if (container) {
                    const inputs = container.querySelectorAll('.mod-value');
                    const op = container.querySelector('.mod-operator');
                    mods[param] = {
                        op: op ? op.value : null,
                        val1: inputs[0] ? parseFloat(inputs[0].value) : null,
                        val2: inputs[1] ? parseFloat(inputs[1].value) : null,
                    };
                }
            });

            if (Object.keys(mods).length === 0) return standardScores;
            
            const modifiedScores = { ...standardScores };

            const createModifiedFn = (param, originalFn) => (val) => {
                const mod = mods[param];
                if (mod === undefined || isNaN(mod.val1)) return originalFn(val);
                if (mod.op === 'less_than' && val < mod.val1) return { score: 0, isMet: false };
                if (mod.op === 'greater_than' && val > mod.val1) return { score: 0, isMet: false };
                if (mod.op === 'between' && !isNaN(mod.val2) && val >= mod.val1 && val <= mod.val2) return { score: 0, isMet: false };
                if ((param === 'spo2' || param === 'sbp') && val >= mod.val1) return { score: 0, isMet: false };
                if (param === 'consciousness' && val <= mod.val1) return { score: 0, isMet: false }; 
                return originalFn(val);
            };

            if(mods.rr) modifiedScores.getRrScore = createModifiedFn('rr', standardScores.getRrScore);
            if(mods.hr) modifiedScores.getHrScore = createModifiedFn('hr', standardScores.getHrScore);
            if(mods.spo2) modifiedScores.getSpo2Score = createModifiedFn('spo2', standardScores.getSpo2Score);
            if(mods.sbp) modifiedScores.getSbpScore = createModifiedFn('sbp', standardScores.getSbpScore);
            if(mods.consciousness) modifiedScores.getConsciousnessScore = createModifiedFn('consciousness', standardScores.getConsciousnessScore);

            return modifiedScores;
        }

        function calculateADDS() {
            let adds = 0; let met = false;
            const breakdownReasons = [];
            const isModsActive = safeIsChecked('addsModificationCheckbox');
            const scoringFunctions = isModsActive ? applyMods() : standardScores;
            const preReviewMethod = document.querySelector('input[name="pre_review_method"]:checked').value;
            
            if(preReviewMethod === 'direct' && safeGet('initialAdds') !== ''){
                adds = safeGetNum('initialAdds');
                breakdownReasons.push(`Direct Entry`);
            } else {
                 const getVital = (id_pre, id_main) => {
                      const val_pre = safeGet(id_pre);
                      const val_main = safeGet(id_main);
                      return val_main !== '' ? val_main : val_pre;
                 };

                 const processVital = (param, value, scoreFn) => {
                      if (value === '' || value === null || isNaN(value)) return;
                      const res = scoreFn(value);
                      adds += res.score;
                      met = met || res.isMet;
                      if (res.score > 0) breakdownReasons.push(`${param.toUpperCase()} ${value} (+${res.score})`);
                 };

                 processVital('rr', parseInt(getVital('pre_rr', 'rr_input'), 10), scoringFunctions.getRrScore);
                 processVital('hr', parseInt(getVital('pre_hr', 'hr_input'), 10), scoringFunctions.getHrScore);
                 processVital('sbp', parseInt(getVital('pre_sbp', 'sbp_input'), 10), scoringFunctions.getSbpScore);
                 processVital('spo2', parseInt(getVital('pre_spo2', 'spo2_input'), 10), scoringFunctions.getSpo2Score);
                 processVital('consciousness', parseInt(getVital('pre_consciousness', 'consciousness_input'), 10), scoringFunctions.getConsciousnessScore);

                 const o2Flow = parseFloat(getVital('pre_o2', 'o2_flow_input'));
                 if (!isNaN(o2Flow) && o2Flow > 0) {
                      const o2Unit = getVital('pre_o2_unit', 'o2_unit_input');
                      const res = scoringFunctions.getO2Score(o2Flow, o2Unit);
                      adds += res.score;
                      if(res.score > 0) breakdownReasons.push(`O2 ${o2Flow}${o2Unit === 'lpm' ? 'L/min' : '%'} (+${res.score})`);
                 }
                 const temp = parseFloat(getVital('pre_temp', 'temp_input')); if (!isNaN(temp)) { let tempScore = 0; if(temp>=38.6||temp<35.1) tempScore=2; else if((temp>=38&&temp<=38.5)||(temp>=35.1&&temp<=36)) tempScore=1; if(tempScore > 0) { adds+=tempScore; breakdownReasons.push(`Temp ${temp}C (+${tempScore})`);}}
            }
            
            if (adds === null) adds = 0;
            if(preReviewMethod === 'calculate') document.getElementById('pre_calculated_adds').textContent = met ? 'MET' : adds;

            const addsLabel = calculatedADDSEl.previousElementSibling;
            if(isModsActive) {
                addsLabel.textContent = 'CALCULATED ADDS (MODS)';
                addsLabel.style.color = '#2563eb';
            } else {
                addsLabel.textContent = 'CALCULATED ADDS';
                addsLabel.style.color = '';
            }
            
            calculatedADDSEl.textContent = met ? 'MET' : adds;
            calculatedADDSEl.className = `font-bold text-5xl my-2 ${met ? 'text-red-600' : 'text-teal-600'}`;
            currentAddsBreakdown = breakdownReasons.length > 0 ? breakdownReasons.join(', ') : 'Normal Parameters';
            addsBreakdownEl.textContent = currentAddsBreakdown;
            
            document.getElementById('crit_adds4_checkbox').checked = !met && adds >= 4;
            document.getElementById('adds_3_radio').checked = !met && adds === 3;
            document.getElementById('adds_0-2_radio').checked = !met && adds >= 0 && adds <= 2;
            
            if (!met && adds >= 0 && adds <= 2) { addsScoreContribution = 1; } 
            else if (!met && adds === 3) { addsScoreContribution = 5; } 
            else { addsScoreContribution = 0; }
            
            updateAllDynamicFlags();
        }
        
        function handleBloodInputs() {
            let score = 0;
            const summaryItems = [];
            const getF = (id) => parseFloat(safeGet(id));
            const isCardiac = safeIsChecked('cts_cardiac_checkbox');

            const updateScoreDisplay = (el, points, colorClass) => {
                if(points > 0) {
                    el.textContent = `(+${points})`;
                    el.className = `blood-score ${colorClass}`;
                } else {
                    el.textContent = '';
                }
            };

            // Lactate
            const lactate = getF('lactate_input');
            let lactatePoints = 0; let lactateColor = '';
            if(!isNaN(lactate)){
                if(lactate >= 3.5) { lactatePoints = 10; lactateColor = 'score-red';}
                else if (lactate >= 2.0) { lactatePoints = 4; lactateColor = 'score-amber';}
                if(lactatePoints > 0) summaryItems.push(`Lactate: ${lactate} (+${lactatePoints})`);
            }
            updateScoreDisplay(document.getElementById('lactate_score_display'), lactatePoints, lactateColor);
            score += lactatePoints;

            // Hb
            const hb = getF('hb_input'), hb_prev = getF('hb_input_prev');
            let hbPoints = 0; let hbColor = '';
            if (!isNaN(hb) && !isNaN(hb_prev) && (hb_prev - hb) > 20) {
                 hbPoints = 10; hbColor = 'score-red';
                 summaryItems.push(`Hb Drop: ${hb_prev} -> ${hb} (+${hbPoints})`);
            } else if (!isNaN(hb) && hb < 80) {
                hbPoints = 3; hbColor = 'score-amber';
                summaryItems.push(`Anaemia (Hb < 80): ${hb} (+${hbPoints})`);
            }
            updateScoreDisplay(document.getElementById('hb_score_display'), hbPoints, hbColor);
            score += hbPoints;
            
            // Electrolytes
            const checkElectrolyte = (id, label, lowCrit, highCrit) => {
                const val = getF(`${id}_input`);
                const scoreEl = document.getElementById(`${id}_score_display`);
                if (isNaN(val) || !scoreEl) return;
                const isActioned = safeIsChecked(`${id}_replaced_checkbox`) || safeIsChecked(`${id}_planned_checkbox`);
                if (!isActioned && (val < lowCrit || val > highCrit)) {
                    updateScoreDisplay(scoreEl, 4, 'score-red');
                    summaryItems.push(`${label}: ${val} (+4)`);
                    score += 4;
                } else {
                    updateScoreDisplay(scoreEl, 0, '');
                }
            };
            checkElectrolyte('k', 'K+', isCardiac ? 4.0 : 3.5, isCardiac ? 5.0 : 5.2);
            checkElectrolyte('mg', 'Mg++', isCardiac ? 0.8 : 0.7, 1.0);

            // Other bloods
            const checkOtherBlood = (id, label, threshold, points) => {
                const val = getF(`${id}_input`);
                const scoreEl = document.getElementById(`${id}_score_display`);
                if(isNaN(val) || !scoreEl) return;
                if(val > threshold) {
                    updateScoreDisplay(scoreEl, points, 'score-amber');
                    summaryItems.push(`${label}: ${val} (+${points})`);
                    score += points;
                } else {
                    updateScoreDisplay(scoreEl, 0, '');
                }
            };
            checkOtherBlood('creatinine', 'Creatinine', 200, 4);
            checkOtherBlood('crp', 'CRP', 100, 3);
            
            const albumin = getF('albumin_input');
            if(!isNaN(albumin) && albumin < 25) {
                updateScoreDisplay(document.getElementById('albumin_score_display'), 3, 'score-amber');
                summaryItems.push(`Albumin: ${albumin} (+3)`);
                score += 3;
            } else {
                 updateScoreDisplay(document.getElementById('albumin_score_display'), 0, '');
            }
            
            const summaryContainer = document.getElementById('bloods_summary_container');
            if (summaryItems.length > 0) {
                summaryContainer.innerHTML = '<strong>Bloods generating scores:</strong> ' + summaryItems.join(', ');
            } else {
                summaryContainer.innerHTML = '';
            }

            window.bloodsScoreContribution = score;
            updateAllDynamicFlags();
        }

        function handleFluidBalance(){
            const fbc24hr = parseFloat(safeGet('fbc_24hr_input'));
            const fbcTotal = parseFloat(safeGet('fbc_total_input'));
            const isSig = (!isNaN(fbc24hr) && Math.abs(fbc24hr) > 1000) || (!isNaN(fbcTotal) && Math.abs(fbcTotal) > 2000);
            const isMild = (!isNaN(fbc24hr) && Math.abs(fbc24hr) > 500) || (!isNaN(fbcTotal) && Math.abs(fbcTotal) > 1000);
            if(isSig) { document.getElementById('fluid_sig_radio').checked = true; } 
            else if (isMild) { document.getElementById('fluid_mild_radio').checked = true; } 
            else { document.getElementById('fluid_0_radio').checked = true; }
            updateAllDynamicFlags();
        }

        function handleAfterHoursLogic() {
            const afterHoursDiv = document.getElementById('after_hours_container');
            if (safeGet('reviewType') === 'pre') {
                afterHoursDiv.style.display = 'none';
                afterHoursCheckbox.checked = false;
            } else {
                const dateStr = safeGet('icuStepdownDate');
                const timeStr = safeGet('icuStepdownTime');
                if (!dateStr || !timeStr) {
                    afterHoursDiv.style.display = 'none'; // Hide if no date/time
                    return;
                }
                const [year, month, day] = dateStr.split('-').map(Number);
                const [hour, minute] = timeStr.split(':').map(Number);
                const dischargeDateTime = new Date(year, month - 1, day, hour, minute);
                const now = new Date();
                const hoursSinceDischarge = (now - dischargeDateTime) / (1000 * 60 * 60);

                if (hoursSinceDischarge > 24) {
                    afterHoursDiv.style.display = 'none';
                    afterHoursCheckbox.checked = false;
                } else {
                    afterHoursDiv.style.display = 'block';
                    const isOOH = document.querySelector(`#icuStepdownTime option[value="${timeStr}"]`)?.dataset.ooh === 'true';
                    afterHoursCheckbox.checked = isOOH;
                }
            }
            updateAllDynamicFlags();
        }

        function updateAllDynamicFlags(){
            const currentTotalBeforeAfterHours = parseInt(totalScoreEl.textContent, 10) - (safeIsChecked('systemic_after_hours_checkbox') ? parseInt(afterHoursCheckbox.dataset.score, 10) : 0);
            afterHoursCheckbox.dataset.score = currentTotalBeforeAfterHours >= 10 ? "5" : "2";

            document.querySelectorAll('.score-input').forEach(input => {
                const parentLabel = input.closest('label');
                if(!parentLabel) return;
                parentLabel.classList.remove('risk-item-selected-critical', 'risk-item-selected-amber');
                if(input.checked){
                    if(input.dataset.isCritical === 'true') parentLabel.classList.add('risk-item-selected-critical');
                    if(input.dataset.isAmber === 'true') parentLabel.classList.add('risk-item-selected-amber');
                }
            });
            calculateScore();
        }

        function createDynamicInput(container, templateHTML) {
            const div = document.createElement('div');
            div.innerHTML = templateHTML.trim();
            const newElement = div.firstChild;
            container.appendChild(newElement);
        }
        
        const createAllergyInput = () => createDynamicInput(allergiesContainer, `
            <div class="allergy-row flex items-center space-x-2 p-2 bg-gray-100 rounded-md">
                <input type="text" placeholder="Allergen" class="allergen-name mt-1 block w-1/2 rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                <input type="text" placeholder="Reaction" class="allergen-reaction mt-1 block w-1/2 rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                <button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold no-print">X</button>
            </div>
        `);
        
        const createCentralLineInput = () => createDynamicInput(centralLinesContainer, `
            <div class="device-row border border-rose-200 p-3 rounded-lg bg-rose-50 space-y-2">
                <div class="flex justify-between items-center"> <h5 class="font-semibold text-rose-800">CVAD</h5> <button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold text-lg no-print">&times;</button> </div>
                <div class="grid grid-cols-2 gap-2">
                    <select class="cvad-type mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option>CVC</option><option>PICC</option><option>Vascath</option></select>
                    <select class="cvad-location mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="">Location...</option><option>R IJ</option><option>L IJ</option><option>R Subclavian</option><option>L Subclavian</option><option>R Femoral</option><option>L Femoral</option><option>R Antecubital</option><option>L Antecubital</option></select>
                    <div><label class="text-xs text-gray-600">Date Inserted</label><input type="date" title="Insertion Date" class="cvad-date device-date-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                    <input type="number" placeholder="Ext. Length (cm)" class="cvad-length mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                    <select class="cvad-site mt-1 block w-full col-span-2 rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="">Site Appearance...</option><option>Clean & Dry</option><option>Oozing</option><option>Redness</option><option>Swelling</option><option>Painful</option></select>
                </div>
            </div>
        `);

        const createPivcInput = () => createDynamicInput(pivcsContainer, `
            <div class="device-row border border-blue-200 p-3 rounded-lg bg-blue-50 space-y-2">
                <div class="flex justify-between items-center"> <h5 class="font-semibold text-blue-800">PIVC</h5> <button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold text-lg no-print">&times;</button> </div>
                <div class="grid grid-cols-2 gap-2">
                    <select class="pivc-location mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="">Location...</option><option>R Hand</option><option>L Hand</option><option>R Wrist</option><option>L Wrist</option><option>R Forearm</option><option>L Forearm</option><option>R Antecubital</option><option>L Antecubital</option></select>
                    <div><label class="text-xs text-gray-600">Date Inserted</label><input type="date" title="Insertion Date" class="pivc-date device-date-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                    <select class="pivc-gauge mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="">Gauge/Colour...</option><option>20G (Pink)</option><option>22G (Blue)</option><option>18G (Green)</option><option>16G (Grey)</option><option>24G (Yellow)</option></select>
                    <input type="number" min="0" max="5" placeholder="PIVAS (0-5)" class="pivc-pivas mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                </div>
            </div>
        `);
        const createPacingWiresInput = () => createDynamicInput(pacingWiresContainer, `
             <div class="device-row border border-purple-200 p-3 rounded-lg bg-purple-50 space-y-2">
                 <div class="flex justify-between items-center"> <h5 class="font-semibold text-purple-800">Pacing Wires</h5> <button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold text-lg no-print">&times;</button> </div>
                 <div class="mt-2 ml-6 space-y-2">
                      <label class="block text-sm font-medium text-gray-700">Status:</label>
                      <select class="pacing_status mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                          <option value="capped">Capped & Secured</option>
                          <option value="backup">Connected (Backup/Sensing)</option>
                          <option value="pacing">Actively Pacing</option>
                      </select>
                      <div class="pacing_settings hidden grid grid-cols-3 gap-2 pt-2">
                          <div><label class="block text-sm font-medium text-gray-700">Mode</label><input type="text" class="pacing_mode mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                          <div><label class="block text-sm font-medium text-gray-700">Rate</label><input type="number" class="pacing_rate mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                          <div><label class="block text-sm font-medium text-gray-700">Output</label><input type="number" class="pacing_output mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div>
                      </div>
                 </div>
             </div>
        `);

        const createNgTubeInput = () => createDynamicInput(ngTubesContainer, `
            <div class="device-row border border-green-200 p-3 rounded-lg bg-green-50 space-y-2">
                 <div class="flex justify-between items-center"> <h5 class="font-semibold text-green-800">Enteral Device</h5> <button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold text-lg no-print">&times;</button> </div>
                 <div class="grid grid-cols-2 gap-2">
                      <select class="ng-type mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option>NG Tube</option><option>NJ Tube</option><option>PEG</option></select>
                      <input type="number" placeholder="Ext. Length (cm)" class="ng-length mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                      <select class="ng-use mt-1 block w-full col-span-2 rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="">Purpose...</option><option>Feeds</option><option>Free Drainage</option><option>Aspiration</option></select>
                 </div>
            </div>
        `);
        
        const createDrainInput = () => createDynamicInput(drainsContainer, `
            <div class="device-row border border-teal-200 p-3 rounded-lg bg-teal-50 space-y-2">
                 <div class="flex justify-between items-center"> <h5 class="font-semibold text-teal-800">Drain</h5> <button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold text-lg no-print">&times;</button> </div>
                 <div class="grid grid-cols-1 gap-2">
                      <select class="drain-type mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" onchange="this.nextElementSibling.classList.toggle('hidden', this.value !== 'Other')"><option value="">Type/Location...</option><option>Abdominal</option><option>Chest Drain</option><option>Nephrostomy</option><option>Wound Drain</option><option value="Other">Other (Specify)</option></select>
                      <input type="text" placeholder="Specify drain type" class="drain-type-other hidden mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                      <input type="text" placeholder="Output Type" class="drain-output-type mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                      <div class="grid grid-cols-2 gap-2">
                          <input type="number" placeholder="24h Output (mL)" class="drain-output-24hr mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                          <input type="number" placeholder="Total Output (mL)" class="drain-output-total mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                      </div>
                 </div>
            </div>
        `);
        
        const createWoundInput = () => createDynamicInput(woundsContainer, `
            <div class="device-row border border-pink-200 p-3 rounded-lg bg-pink-50 space-y-2">
                 <div class="flex justify-between items-center"> <h5 class="font-semibold text-pink-800">Wound</h5> <button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold text-lg no-print">&times;</button> </div>
                 <div class="grid grid-cols-1 gap-2">
                      <select class="wound-location mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" onchange="this.nextElementSibling.classList.toggle('hidden', this.value !== 'Other')"><option value="">Location...</option><option>Sternal</option><option>Abdominal</option><option>Limb</option><option>Pressure Injury</option><option value="Other">Other (Specify)</option></select>
                      <input type="text" placeholder="Specify location" class="wound-location-other hidden mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                      <select class="wound-status mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="">Status/Dressing...</option><option>Clean & Dry</option><option>Oozing</option><option>Dehisced</option><option>Infected</option><option>VAC Dressing</option></select>
                 </div>
            </div>
        `);
        
        function generateSummary() {
            let summary = ``;
            const data = getFormData();
            const reviewType = getSelectText(document.getElementById('reviewType'));
            let hoursPostICU = 'N/A';
            const dateStr = safeGet('icuStepdownDate');
            const timeStr = safeGet('icuStepdownTime');
            if (dateStr && timeStr) {
                const [year, month, day] = dateStr.split('-').map(Number);
                const [hour, minute] = timeStr.split(':').map(Number);
                const dischargeDateTime = new Date(year, month - 1, day, hour, minute);
                const now = new Date();
                const hours = (now - dischargeDateTime) / (1000 * 60 * 60);
                if (hours > 24) {
                    hoursPostICU = `Day ${Math.ceil(hours / 24)} of review`;
                } else {
                    hoursPostICU = `${Math.round(hours)} hours post ICU`;
                }
            }
            
            const allergies = safeIsChecked('nkdaCheckbox') ? 'NKDA' : (Array.from(document.querySelectorAll('.allergen-name')).map(el => el.value).join(', ') || 'Not Documented');
            
            summary += `${reviewType.replace('review', 'review on ward')}\n`;
            summary += `Patient: ${data.patientInitials || 'N/A'}, Ward/Room: ${data.wardAndRoom || 'N/A'}\n`;
            summary += `ICU LOS: ${data.losDays || 'N/A'} days\n`;
            summary += `Review Date/Time: ${new Date().toLocaleDateString('en-AU')} ${new Date().toLocaleTimeString('en-AU', {hour: '2-digit', minute:'2-digit'})}\n`;
            summary += `Time post-ICU: ${hoursPostICU}\n`;
            summary += `Alert Score: ${updatedTotalScoreEl.textContent} (${updatedRiskCategoryEl.textContent.split('<br>')[0].trim()})\n`;
            summary += `Allergies: ${allergies}\n`;
            summary += `GOC: ${data.goc || 'Not Documented'}${data.gocSpecifics ? ` (${data.gocSpecifics})` : ''}\n\n`;

            summary += `ADMISSION REASON: ${data.admissionReason || 'Not documented.'}\n`;
            summary += `ICU SUMMARY: ${data.icuSummary || 'Not documented.'}\n`;
            summary += `PMH: ${data.pmh || 'Not documented.'}\n\n`;

            summary += `IMPRESSION:\n`;
            const impressionsList = [];
            if (safeIsChecked('crit_met')) impressionsList.push(`Patient is currently meeting MET criteria.`);
            if (safeIsChecked('crit_adds4')) impressionsList.push(`High ADDS score of ${calculatedADDSEl.textContent} noted, indicating physiological instability. Breakdown: ${addsBreakdownEl.textContent}`);
            if (safeIsChecked('fluid_sig_radio')) impressionsList.push(`Significant fluid imbalance noted (24hr: ${data.fbc_24hr_input} mL, Total ICU: ${data.fbc_total_input} mL).`);
            if (safeIsChecked('delirium_mod')) impressionsList.push(`Moderate to severe delirium identified.`);
            if (safeIsChecked('pain_pca')) impressionsList.push(`Poorly controlled pain requiring PCA.`);
            if (safeIsChecked('crit_af')) impressionsList.push(`Unstable Atrial Fibrillation noted.`);
            if (safeIsChecked('drains_high_risk')) impressionsList.push(`High-risk drain is present.`);
            if (safeIsChecked('bowels_issue')) impressionsList.push(`Bowels not opened for >3 days or Ileus.`);
            if (data.pre_review_method === 'direct' && data.initialAddsModified) impressionsList.push(`Pre-review ADDS of ${data.initialAdds} was a manual modification. Rationale: ${data.initialAddsRationale}`);

            if (data.pivcs.length > 0) {
                data.pivcs.forEach(pivc => {
                    if (pivc.date) {
                        const dwellHours = Math.round((new Date() - new Date(pivc.date)) / (1000 * 60 * 60));
                        if (dwellHours > 72) impressionsList.push(`PIVC at ${pivc.location} has been in-situ for >72hrs (approx ${dwellHours}h).`);
                    }
                    if (pivc.pivas >= 3) impressionsList.push(`PIVC at ${pivc.location} has a raised PIVAS score of ${pivc.pivas}.`);
                });
            }
            if (data.centralLines.length > 0) {
                data.centralLines.forEach(cvad => {
                    if(cvad.date) {
                        const dwellDays = Math.round((new Date() - new Date(cvad.date)) / (1000 * 60 * 60 * 24));
                        if (dwellDays > 7) impressionsList.push(`CVAD at ${cvad.location} has been in-situ for >7 days (approx ${dwellDays}d).`);
                    }
                });
            }
            
            if (impressionsList.length > 0) {
                summary += impressionsList.map(item => `* ${item}`).join('\n') + '\n\n';
            } else {
                summary += 'Patient appears clinically stable.\n\n';
            }

            summary += `---- KEY INFORMATION & PLAN ----\n`;
            const carePlanItems = [];
            document.querySelectorAll('.score-input:checked').forEach(input => {
                const id = input.dataset.id;
                if (carePlanMap[id]) {
                    carePlanItems.push(`- ${carePlanMap[id]}`);
                }
            });

            // Add all bloods that generated a score
            const bloodSummaryEl = document.getElementById('bloods_summary_container');
            if (bloodSummaryEl && bloodSummaryEl.innerText) {
                 carePlanItems.push(`- Biochemical Plan: ${bloodSummaryEl.innerText.replace('Bloods generating scores: ', '')}`);
            }

            // Add all devices
            let deviceText = '';
            if (data.centralLines.length > 0) {
                deviceText += `CVADs:\n`;
                data.centralLines.forEach(d => deviceText += `  - ${d.type} (${d.location}) inserted on ${d.date}. Site: ${d.site || 'N/A'}\n`);
            }
            if (data.pivcs.length > 0) {
                deviceText += `PIVCs:\n`;
                data.pivcs.forEach(d => deviceText += `  - ${d.gauge} at ${d.location} inserted on ${d.date}. PIVAS: ${d.pivas || 'N/A'}\n`);
            }
            
            let otherDeviceText = '';
            if (data.ngTubes.length > 0) data.ngTubes.forEach(d => otherDeviceText += `  - ${d.type} used for ${d.use}. Ext: ${d.length || 'N/A'}cm.\n`);
            if (data.pacingWires.length > 0) data.pacingWires.forEach(d => otherDeviceText += `  - Pacing Wires (${d.status}). Mode: ${d.mode || 'N/A'}, Rate: ${d.rate || 'N/A'}, Output: ${d.output || 'N/A'}.\n`);
            if (data.drains.length > 0) data.drains.forEach(d => otherDeviceText += `  - Drain: ${d.type === 'Other' ? d.other : d.type}. Output: ${d.outputType || 'N/A'}. 24h: ${d.output24hr || 'N/A'}mL.\n`);
            if (data.wounds.length > 0) data.wounds.forEach(d => otherDeviceText += `  - Wound at ${d.location === 'Other' ? d.other : d.location}. Status: ${d.status}.\n`);

            if (deviceText.length > 0) summary += deviceText + '\n';
            if (otherDeviceText.length > 0) summary += `OTHER DEVICES:\n${otherDeviceText}\n`;

            if (safeIsChecked('concern_present') && safeGet('nursingConcernText')) {
                carePlanItems.push(`- Nursing Concern: ${safeGet('nursingConcernText')}`);
            }
            
            if (data.pics_status === 'positive' || data.pics_status === 'unable') {
                carePlanItems.push(`- PICS: ${data.pics_status.charAt(0).toUpperCase() + data.pics_status.slice(1)}. Plan: ${data.pics_notes}`);
            }

            if (safeIsChecked('homeTeamPlanCheckbox')) {
                carePlanItems.push(`- Home Team Plan in Place: ${data.homeTeamPlanText}`);
            }

            if (safeGet('emrAdditionalNotes')) {
                 carePlanItems.push(`- Additional Notes: ${safeGet('emrAdditionalNotes')}`);
            }

            if (carePlanItems.length > 0) {
                summary += [...new Set(carePlanItems)].join('\n') + '\n\n';
            } else {
                summary += "- Continue with standard ward-based care and observations.\n\n";
            }
            summary += "Reviewed by ALERT CNS. Please escalate any concerns or if support is required.";
            
            emrSummaryEl.value = summary;
        }
        
        function getFormData() {
            const data = {};
            assessmentForm.querySelectorAll('input, select, textarea').forEach(el => {
                let id = el.id;
                if(el.dataset.param) id = el.dataset.param;
                else if (!id) id = el.name;
                
                if (el.type === 'checkbox' || el.type === 'radio') {
                    if (id) data[id] = el.checked;
                } else {
                    if (id) data[id] = el.value;
                }
            });
            
            data.allergies = Array.from(allergiesContainer.querySelectorAll('.allergy-row')).map(row => ({
                name: row.querySelector('.allergen-name').value,
                reaction: row.querySelector('.allergen-reaction').value
            }));

            const saveDevices = (container, selectors) => Array.from(container.querySelectorAll('.device-row')).map(row => {
                const deviceData = {};
                for (const key in selectors) { deviceData[key] = row.querySelector(selectors[key])?.value; }
                return deviceData;
            });
            
            data.centralLines = saveDevices(centralLinesContainer, { type: '.cvad-type', location: '.cvad-location', date: '.cvad-date', length: '.cvad-length', site: '.cvad-site' });
            data.pivcs = saveDevices(pivcsContainer, { location: '.pivc-location', date: '.pivc-date', gauge: '.pivc-gauge', pivas: '.pivc-pivas' });
            data.ngTubes = saveDevices(ngTubesContainer, { type: '.ng-type', length: '.ng-length', use: '.ng-use' });
            data.drains = saveDevices(drainsContainer, { type: '.drain-type', other: '.drain-type-other', outputType: '.drain-output-type', output24hr: '.drain-output-24hr', outputTotal: '.drain-output-total' });
            data.wounds = saveDevices(woundsContainer, { location: '.wound-location', other: '.wound-location-other', status: '.wound-status' });
            data.pacingWires = saveDevices(pacingWiresContainer, { status: '.pacing_status', mode: '.pacing_mode', rate: '.pacing_rate', output: '.pacing_output' });

            return data;
        }
        
        function loadFormData(data) {
            if (!data) return;
            resetForm();
            for (const key in data) {
                const el = document.getElementById(key) || document.querySelector(`[data-param="${key}"]`) || document.querySelector(`[name="${key}"]`);
                if (el) {
                    if (el.type === 'checkbox' || el.type === 'radio') {
                        el.checked = data[key];
                    } else {
                        el.value = data[key];
                    }
                }
            }
            
            if (data.allergies) { data.allergies.forEach(a => { createAllergyInput(); const lastRow = allergiesContainer.lastChild; if (lastRow) { lastRow.querySelector('.allergen-name').value = a.name; lastRow.querySelector('.allergen-reaction').value = a.reaction; } }); }
            if (data.centralLines) { data.centralLines.forEach(d => { createCentralLineInput(); const lastRow = centralLinesContainer.lastChild; if (lastRow) { for(const k in d) { const el = lastRow.querySelector(`.cvad-${k}`); if (el) el.value = d[k]; } } }); }
            if (data.pivcs) { data.pivcs.forEach(d => { createPivcInput(); const lastRow = pivcsContainer.lastChild; if (lastRow) { for(const k in d) { const el = lastRow.querySelector(`.pivc-${k}`); if (el) el.value = d[k]; } } }); }
            if (data.ngTubes) { data.ngTubes.forEach(d => { createNgTubeInput(); const lastRow = ngTubesContainer.lastChild; if (lastRow) { for(const k in d) { const el = lastRow.querySelector(`.ng-${k}`); if (el) el.value = d[k]; } } }); }
            if (data.drains) { data.drains.forEach(d => { createDrainInput(); const lastRow = drainsContainer.lastChild; if (lastRow) { lastRow.querySelector('.drain-type').value = d.type; if(d.type === 'Other') { lastRow.querySelector('.drain-type-other').value = d.other; lastRow.querySelector('.drain-type-other').classList.remove('hidden'); } lastRow.querySelector('.drain-output-type').value = d.outputType; lastRow.querySelector('.drain-output-24hr').value = d.output24hr; lastRow.querySelector('.drain-output-total').value = d.outputTotal;} }); }
            if (data.wounds) { data.wounds.forEach(d => { createWoundInput(); const lastRow = woundsContainer.lastChild; if (lastRow) { lastRow.querySelector('.wound-location').value = d.location; if(d.location === 'Other') { lastRow.querySelector('.wound-location-other').value = d.other; lastRow.querySelector('.wound-location-other').classList.remove('hidden'); } lastRow.querySelector('.wound-status').value = d.status;} }); }
            if (data.pacingWires) { data.pacingWires.forEach(d => { createPacingWiresInput(); const lastRow = pacingWiresContainer.lastChild; if (lastRow) { for(const k in d) { const el = lastRow.querySelector(`.pacing_${k}`); if (el) el.value = d[k]; } } }); }
            
            document.querySelectorAll('input, select').forEach(el => el.dispatchEvent(new Event('input', { bubbles: true })));
            document.querySelectorAll('input, select').forEach(el => el.dispatchEvent(new Event('change', { bubbles: true })));
        }

        function saveState() {
            if (Object.keys(patients).length > 0) {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ patients, activePatientId }));
            } else {
                 localStorage.removeItem(LOCAL_STORAGE_KEY);
            }
        }

        function loadAllData() {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    patients = parsedData.patients || {};
                    activePatientId = parsedData.activePatientId;
                } catch (e) { console.error("Failed to parse data", e); patients = {}; activePatientId = null; }
            }
            if (Object.keys(patients).length === 0) {
                addPatient(false);
            } else {
                if (!activePatientId || !patients[activePatientId]) { activePatientId = Object.keys(patients)[0]; }
                switchPatient(activePatientId);
            }
        }
        
        function saveActivePatientData() {
            if (!activePatientId) return;
            const patientData = getFormData();
            const patientName = patientData.patientInitials || `Patient`;
            const score = parseInt(updatedTotalScoreEl.textContent, 10);
            patients[activePatientId] = { 
                id: activePatientId, 
                name: patientName, 
                score: score, 
                categoryClass: getCategoryClass(score),
                categoryText: updatedRiskCategoryEl.textContent.split('<br>')[0].trim(),
                data: patientData 
            };
            saveState();
            renderTabs();
        }

        function addPatient(doSave = true) {
            const newId = `patient_${Date.now()}`;
            const newPatientName = `Patient ${Object.keys(patients).length + 1}`;
            patients[newId] = { id: newId, name: newPatientName, score: 0, categoryClass: 'risk-single', categoryText: 'At least one follow-up review required', data: {} };
            activePatientId = newId;
            if(doSave) saveState();
            switchPatient(newId);
        }

        function deletePatient(idToDelete) {
            delete patients[idToDelete];
            if (Object.keys(patients).length === 0) {
                addPatient(false);
            } else {
                if (activePatientId === idToDelete) { 
                    activePatientId = Object.keys(patients)[0]; 
                }
                saveState();
                switchPatient(activePatientId);
            }
        }

        function switchPatient(newId) {
            if (activePatientId && patients[activePatientId] && activePatientId !== newId) { saveActivePatientData(); }
            activePatientId = newId;
            const patient = patients[newId];
            if (patient) {
                loadFormData(patient.data);
            }
            renderTabs();
        }

        function renderTabs() {
            patientTabsContainer.querySelectorAll('.patient-tab').forEach(tab => tab.remove());
            const patientCount = Object.keys(patients).length;
            tabsPlaceholder.style.display = patientCount === 0 ? 'block' : 'none';
            if (patientCount > 0) {
                Object.values(patients).forEach(patient => {
                    const tab = document.createElement('div');
                    tab.className = 'patient-tab';
                    if (patient.id === activePatientId) tab.classList.add('active', patient.categoryClass || 'risk-single');
                    tab.dataset.id = patient.id;
                    const scoreBadge = document.createElement('span');
                    scoreBadge.className = 'tab-score-badge';
                    scoreBadge.textContent = patient.score || 0;
                    scoreBadge.style.backgroundColor = categoryColorMap[patient.categoryClass || 'risk-single'];
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = patient.name || 'New Patient';
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.className = 'delete-patient-btn';
                    deleteBtn.title = `Delete ${patient.name}`;
                    deleteBtn.dataset.id = patient.id;
                    tab.append(scoreBadge, nameSpan, deleteBtn);
                    tab.onclick = () => switchPatient(patient.id);
                    patientTabsContainer.appendChild(tab);
                });
            }
        }
        
        function generatePatientCardHTML(patient){
            const d = patient.data || {};
            const score = patient.score || 0;
            const categoryText = patient.categoryText || 'N/A';
            const categoryClass = patient.categoryClass || 'risk-single';
            const categoryColor = categoryColorMap[categoryClass] || '#67E8F9';

            const keyConcerns = [];
            // Simplified impression generation for the card
            if (d.crit_met) keyConcerns.push('MET criteria');
            if (d.crit_adds4) keyConcerns.push(`High ADDS score of ${d.calculatedADDSScore}`);
            if (d.fluid_sig_radio) keyConcerns.push('Significant fluid imbalance');
            if (d.delirium_mod) keyConcerns.push('Moderate to severe delirium');
            if (d.pain_pca) keyConcerns.push('Poorly controlled pain');
            if (d.crit_af) keyConcerns.push('Unstable Atrial Fibrillation');
            if (d.drains_high_risk) keyConcerns.push('High-risk drain present');
            if (d.bowels_issue) keyConcerns.push('Bowel issue (>3d or Ileus)');
            if (d.concern_present) keyConcerns.push(`Nursing concern: ${d.nursingConcernText}`);

            return `
            <div class="ward-list-card">
                <div class="ward-list-header" style="border-top: 4px solid ${categoryColor};">
                    <h3>${d.patientInitials || 'N/A'} <span style="font-weight:normal;">(${d.wardAndRoom || 'N/A'})</span></h3>
                    <div class="score-box">
                        <strong>Score: ${score}</strong><br>
                        <span style="font-size: 8pt;">${categoryText}</span>
                    </div>
                </div>
                <div class="ward-list-body">
                     <div class="ward-list-section">
                         <h4>ICU Admission</h4>
                         <p>${d.admissionReason || 'Not documented.'}</p>
                     </div>
                     <div class="ward-list-section">
                         <h4>ICU Summary</h4>
                         <p>${(d.icuSummary || 'Not documented.').substring(0, 200)}${d.icuSummary && d.icuSummary.length > 200 ? '...' : ''}</p>
                     </div>
                     <div class="ward-list-section">
                         <h4>Key Concerns</h4>
                         ${keyConcerns.length > 0 ? `<ul>${keyConcerns.map(c => `<li>${c}</li>`).join('')}</ul>` : '<p>None identified.</p>'}
                     </div>
                </div>
            </div>`;
        }


        function generateDigitalList() {
            let listHtml = '<div class="digital-list-container">';
            const sortedPatients = Object.values(patients).sort((a, b) => (b.score || 0) - (a.score || 0));
            sortedPatients.forEach(p => {
                listHtml += generatePatientCardHTML(p);
            });
            listHtml += '</div>';
            digitalListContent.innerHTML = listHtml;
            digitalListModal.classList.remove('hidden');
            digitalListModal.classList.add('flex');
        }
        
        function generatePrintList() {
            saveActivePatientData();
            let printHtml = `<h1>ALERT Ward Handover - ${new Date().toLocaleDateString('en-AU')}</h1><div class="print-grid-container">`;
            const sortedPatients = Object.values(patients).sort((a,b) => (b.score || 0) - (a.score || 0));
            sortedPatients.forEach(p => {
                printHtml += generatePatientCardHTML(p);
            });
            printHtml += `</div>`;
            printoutContainer.innerHTML = printHtml;
            document.body.classList.add('print-list-mode');
            window.print();
            document.body.classList.remove('print-list-mode');
        }

        function printBlankForm() {
            document.body.classList.add('print-blank-mode');
            window.print();
            document.body.classList.remove('print-blank-mode');
        }

        function copySummary() {
            if (!emrSummaryEl.value) { alert('Please generate the summary first.'); return; }
            navigator.clipboard.writeText(emrSummaryEl.value).then(() => {
                document.getElementById('copySummaryButton').textContent = 'Copied!';
                setTimeout(() => { document.getElementById('copySummaryButton').textContent = 'Copy to Clipboard'; }, 2000);
            }).catch(err => { console.error('Failed to copy text: ', err); alert('Failed to copy summary.'); });
        }
        
        function checkBowelStatus() {
            const lastBowelDate = safeGet('bowel_last_open');
            const bowelType = safeGet('bowel_type');
            const bowelsIssueCheckbox = document.getElementById('bowels_issue_checkbox');

            let issueFound = false;
            if (bowelType === 'Ileus / Not passed flatus' || bowelType === 'Constipated') {
                issueFound = true;
            } else if (lastBowelDate) {
                const lastBowel = new Date(lastBowelDate);
                const now = new Date();
                const daysSince = (now - lastBowel) / (1000 * 60 * 60 * 24);
                if (daysSince >= 3) {
                    issueFound = true;
                }
            }
             bowelsIssueCheckbox.checked = issueFound;
             // Must manually dispatch change event for score to update
             bowelsIssueCheckbox.dispatchEvent(new Event('change', { bubbles: true }));
        }
        
        function flagDevices() {
            // PIVC checks
            document.querySelectorAll('#pivcs_container .device-row').forEach(row => {
                const pivas = parseInt(row.querySelector('.pivc-pivas').value, 10);
                const dateStr = row.querySelector('.pivc-date').value;
                let flag = false;
                let message = '';

                if (!isNaN(pivas) && pivas >= 3) {
                    flag = true;
                    message = `PIVAS score of ${pivas} is raised.`;
                }
                
                if (dateStr) {
                    const daysSince = (new Date() - new Date(dateStr)) / (1000 * 60 * 60 * 24);
                    if (daysSince > 3) {
                        flag = true;
                        message += message ? ' & ' : '';
                        message += `Dwell time > 72h (${Math.round(daysSince * 24)}h)`;
                    }
                }
                let messageDiv = row.querySelector('.flag-message');
                if (flag) {
                    row.style.border = '2px solid #F59E0B'; // Amber border
                    if (!messageDiv) {
                        messageDiv = document.createElement('div');
                        messageDiv.className = 'flag-message text-xs text-orange-600 font-semibold italic mt-2';
                        row.appendChild(messageDiv);
                    }
                    messageDiv.textContent = `‚ö†Ô∏è PIVC ALERT: ${message}`;
                } else {
                    if (messageDiv) messageDiv.remove();
                    row.style.border = '';
                }
            });

            // CVAD checks
            document.querySelectorAll('#central_lines_container .device-row').forEach(row => {
                const dateStr = row.querySelector('.cvad-date').value;
                let messageDiv = row.querySelector('.flag-message');
                if (dateStr) {
                    const daysSince = (new Date() - new Date(dateStr)) / (1000 * 60 * 60 * 24);
                    if (daysSince > 7) {
                        row.style.border = '2px solid #F97316'; // Orange border
                        if (!messageDiv) {
                             messageDiv = document.createElement('div');
                             messageDiv.className = 'flag-message text-xs text-red-600 font-semibold italic mt-2';
                             row.appendChild(messageDiv);
                        }
                        messageDiv.textContent = `‚ùó CVAD ALERT: Dwell time > 7 days (${Math.round(daysSince)}d)`;
                    } else {
                        if (messageDiv) messageDiv.remove();
                        row.style.border = '';
                    }
                }
            });
        }
        
        // --- QR Code Workflow ---
        function startScanner() {
            document.getElementById('launchButtons').classList.add('hidden');
            document.getElementById('scannerContainer').classList.remove('hidden');
            document.getElementById('stopScanningBtn').classList.remove('hidden');
            
            html5QrCode = new Html5Qrcode("qr-reader");
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                try {
                    const loadedData = JSON.parse(decodedText);
                    if (loadedData.patients && loadedData.activePatientId) {
                        patients = loadedData.patients;
                        activePatientId = loadedData.activePatientId;
                        saveState(); // Save the new state to local storage
                        document.getElementById('qr-scan-result').textContent = '‚úÖ Success! Data loaded.';
                        document.getElementById('qr-scan-result').style.color = 'green';
                        stopScanner();
                        setTimeout(startFromScratch, 1000); // Close modal and show data
                    } else {
                        throw new Error("Invalid data format in QR code.");
                    }
                } catch (e) {
                    console.error("QR Scan Error:", e);
                    document.getElementById('qr-scan-result').textContent = '‚ùå Error: Invalid QR code format.';
                     document.getElementById('qr-scan-result').style.color = 'red';
                }
            };
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                .catch(err => console.log(`Unable to start scanning, error: ${err}`));
        }

        function stopScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    console.log("QR Code scanning stopped.");
                }).catch(err => {
                    console.error("Failed to stop QR scanner.", err);
                });
            }
             document.getElementById('launchButtons').classList.remove('hidden');
             document.getElementById('scannerContainer').classList.add('hidden');
             document.getElementById('stopScanningBtn').classList.add('hidden');
             document.getElementById('qr-scan-result').textContent = '';
        }

        // NEW HELPER FUNCTION TO SHRINK QR CODE DATA
        function getPrunedDataForQRCode() {
            const prunedData = {
                patients: {},
                activePatientId: activePatientId
            };

            for (const patientId in patients) {
                const originalPatient = patients[patientId];
                const prunedPatientData = {};

                // Iterate over the patient's form data
                for (const key in originalPatient.data) {
                    const value = originalPatient.data[key];

                    // Check if the value is meaningful
                    // It's meaningful if it's a non-empty array, a checked box (true), 
                    // a non-empty string, or a number (including 0).
                    if (Array.isArray(value) && value.length > 0) {
                        prunedPatientData[key] = value;
                    } else if (typeof value === 'boolean' && value === true) {
                        prunedPatientData[key] = true;
                    } else if (typeof value === 'string' && value.trim() !== '') {
                        prunedPatientData[key] = value;
                    } else if (typeof value === 'number') {
                         prunedPatientData[key] = value;
                    }
                }
                
                // Reconstruct the patient object with only the pruned data
                prunedData.patients[patientId] = {
                    ...originalPatient,
                    data: prunedPatientData
                };
            }
            return prunedData;
        }

        // UPDATED FUNCTION TO USE THE NEW HELPER
        function generateAndShowQrCode() {
            saveActivePatientData(); // Ensure current data is saved before generating
            
            // Use the new helper function to get only the necessary data
            const dataToEncode = JSON.stringify(getPrunedDataForQRCode());
            
            console.log(`QR Code data size reduced to ${dataToEncode.length} characters.`); // For debugging

            qrcodeContainer.innerHTML = ''; // Clear previous QR code
            new QRCode(qrcodeContainer, {
                text: dataToEncode,
                width: 256,
                height: 256,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.L // Use Low correction level for max data capacity
            });
            qrCodeModal.classList.remove('hidden');
            qrCodeModal.classList.add('flex');
        }
        function startFromScratch() {
            launchScreenModal.classList.add('hidden');
            mainContent.style.visibility = 'visible';
            loadAllData();
        }

        function initializeApp() {
            const eventListeners = {
                'resetButton': { event: 'click', handler: () => { if(confirm('Are you sure you want to reset the form for this patient?')) { resetForm(); saveActivePatientData(); } } },
                'generateSummaryButton': { event: 'click', handler: generateSummary },
                'copySummaryButton': { event: 'click', handler: copySummary },
                'reviewType': { event: 'change', handler: (e) => { postStepdownFields.style.display = e.target.value === 'pre' ? 'none' : 'grid'; handleAfterHoursLogic(); } },
                'goc': { event: 'change', handler: (e) => { const show = ['B', 'C'].includes(e.target.value); gocSpecificsContainer.classList.toggle('hidden', !show); if (!show) document.getElementById('gocSpecifics').value = ''; } },
                'addAllergyButton': { event: 'click', handler: createAllergyInput },
                'nkdaCheckbox': { event: 'change', handler: (e) => { const isChecked = e.target.checked; if(isChecked) allergiesContainer.innerHTML = ''; allergiesContainer.style.display = isChecked ? 'none' : 'block'; addAllergyButton.style.display = isChecked ? 'none' : 'block'; } },
                'addCentralLineButton': { event: 'click', handler: createCentralLineInput },
                'addPivcButton': { event: 'click', handler: createPivcInput },
                'addNgTubeButton': { event: 'click', handler: createNgTubeInput },
                'addDrainButton': { event: 'click', handler: createDrainInput },
                'addWoundButton': { event: 'click', handler: createWoundInput },
                'addPacingWiresButton': { event: 'click', handler: createPacingWiresInput },
                'homeTeamPlanCheckbox': { event: 'change', handler: (e) => { homeTeamPlanDetails.classList.toggle('hidden', !e.target.checked); if(!e.target.checked) document.getElementById('homeTeamPlanText').value = ''; } },
                'addPatientBtn': { event: 'click', handler: () => addPatient() },
                'clearDataBtn': { event: 'click', handler: () => { if(confirm('Confirm delete all inputted data from ALERT Nursing Risk Assessment Tool')) { if(confirm('Second confirmation - this will delete all of your inputted data from the ALERT Nursing Risk Assessment Tool, are you sure?')) { localStorage.removeItem(LOCAL_STORAGE_KEY); patients = {}; activePatientId = null; addPatient(false); } } } },
                'printListBtn': { event: 'click', handler: generatePrintList },
                'printBlankBtn': { event: 'click', handler: printBlankForm },
                'digitalListBtn': { event: 'click', handler: generateDigitalList },
                'closeDigitalListModalBtn': { event: 'click', handler: () => { digitalListModal.classList.add('hidden'); digitalListModal.classList.remove('flex'); } },
                'copyDigitalListBtn': { event: 'click', handler: () => { navigator.clipboard.writeText(digitalListContent.innerText).then(() => { document.getElementById('copyDigitalListBtn').textContent = 'Copied!'; setTimeout(() => { document.getElementById('copyDigitalListBtn').textContent = 'Copy to Clipboard'; }, 2000); }, () => alert('Failed to copy.')); } },
                'addsModificationCheckbox': { event: 'change', handler: (e) => { addsModificationDetails.classList.toggle('hidden', !e.target.checked); calculateADDS(); }},
                'initialAdds': { event: 'input', handler: calculateADDS },
                'initialAddsModified': { event: 'change', handler: (e) => { initialAddsRationale.classList.toggle('hidden', !e.target.checked); } },
                 'preAddsModified': { event: 'change', handler: (e) => {
                      if(e.target.checked){
                           const calculatedScore = document.getElementById('pre_calculated_adds').textContent;
                           document.querySelector('input[name="pre_review_method"][value="direct"]').checked = true;
                           document.getElementById('initialAdds').value = calculatedScore;
                           preReviewDirectContainer.style.display = 'block';
                           preReviewCalculateContainer.style.display = 'none';
                           calculateADDS();
                           e.target.checked = false; // uncheck after use
                      }
                 } },
                // Workflow Buttons
                'startFromScratchBtn': { event: 'click', handler: startFromScratch },
                'scanQRBtn': { event: 'click', handler: startScanner },
                'stopScanningBtn': {event: 'click', handler: stopScanner },
                'sendToMobileBtn': { event: 'click', handler: generateAndShowQrCode },
                'closeQRCodeModalBtn': { event: 'click', handler: () => qrCodeModal.classList.add('hidden') }
            };

            for (const id in eventListeners) {
                const el = document.getElementById(id);
                if (el) el.addEventListener(eventListeners[id].event, eventListeners[id].handler);
            }
            
            patientTabsContainer.addEventListener('click', e => {
                 if (e.target.classList.contains('delete-patient-btn')) {
                     e.stopPropagation();
                     const idToDelete = e.target.dataset.id;
                     if(confirm(`Are you sure you want to delete patient ${patients[idToDelete]?.name || 'this patient'}?`)){
                         deletePatient(idToDelete);
                     }
                 }
            });

            document.querySelectorAll('input[name="pre_review_method"]').forEach(radio => radio.addEventListener('change', e => {
                const isDirect = e.target.value === 'direct';
                preReviewDirectContainer.style.display = isDirect ? 'block' : 'none';
                preReviewCalculateContainer.style.display = isDirect ? 'none' : 'block';
                calculateADDS();
            }));
            
            assessmentForm.addEventListener('change', e => {
                if(e.target.classList.contains('pacing_status')){
                    const settingsDiv = e.target.closest('.device-row').querySelector('.pacing_settings');
                    if(settingsDiv) settingsDiv.classList.toggle('hidden', e.target.value === 'capped');
                }
            });

            document.querySelectorAll('.blood-input, .vital-input, .fluid-input, .time-input, .mod-value, .mod-operator, .pre-obs-input').forEach(input => input.addEventListener('input', () => { handleBloodInputs(); calculateADDS(); handleFluidBalance(); handleAfterHoursLogic(); }));
            document.querySelectorAll('.score-input, #losDays').forEach(input => input.addEventListener('change', (e) => { 
                if(e.target.id === 'losDays'){
                    document.getElementById('losCheckbox').checked = (safeGetNum('losDays') || 0) > 3;
                }
                updateAllDynamicFlags(); 
            }));
            document.querySelectorAll('input[name="concern_score"]').forEach(radio => radio.addEventListener('change', (e) => { nursingConcernText.style.display = e.target.value === '5' && e.target.checked ? 'block' : 'none'; if(!e.target.checked || e.target.value !== '5') nursingConcernText.value = ''; }));
            document.querySelectorAll('input[name="pics_status"]').forEach(radio => radio.addEventListener('change', (e) => { picsDetailsContainer.classList.toggle('hidden', e.target.value === 'negative'); }));
            document.querySelectorAll('.precaution-cb').forEach(cb => { cb.addEventListener('change', () => { const anyChecked = [...document.querySelectorAll('.precaution-cb')].some(c => c.checked); infectionControlDetails.classList.toggle('hidden', !anyChecked); if(!anyChecked) document.getElementById('infectionControlReason').value = ''; }); });
            document.querySelectorAll('input[name="mod_param"]').forEach(cb => cb.addEventListener('change', e => { e.target.closest('.space-y-1').querySelector('.mod-details').classList.toggle('hidden', !e.target.checked); calculateADDS(); }));
            document.querySelectorAll('.mod-operator').forEach(sel => sel.addEventListener('change', e => { e.target.closest('.mod-details').querySelector('.mod-val2-container').style.display = e.target.value === 'between' ? 'inline' : 'none'; calculateADDS(); }));
            
            document.querySelectorAll('.device-date-input, .pivc-pivas').forEach(input => input.addEventListener('input', flagDevices));
            document.getElementById('bowel_last_open').addEventListener('input', checkBowelStatus);
            document.getElementById('bowel_type').addEventListener('change', checkBowelStatus);

            assessmentForm.addEventListener('click', e => {
                if (e.target && e.target.classList.contains('remove-btn')) {
                    const elementToRemove = e.target.closest('.device-row, .allergy-row');
                    if (elementToRemove) elementToRemove.remove();
                }
            });

            let saveTimeout;
            assessmentForm.addEventListener('input', () => { clearTimeout(saveTimeout); saveTimeout = setTimeout(saveActivePatientData, 500); });
            assessmentForm.addEventListener('change', () => { clearTimeout(saveTimeout); saveTimeout = setTimeout(saveActivePatientData, 500); });
            
            // On load, show the launch screen instead of loading data directly.
            // The user's choice on the launch screen will then call loadAllData().
            launchScreenModal.classList.remove('hidden');
        }
        
        initializeApp();
    });
    </script>
</body>
</html>
