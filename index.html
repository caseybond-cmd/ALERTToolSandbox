<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALERT Nursing Risk Assessment Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F0F9F9; }
        .category-critical { background-color: #DC2626; color: #FFFFFF; }
        .category-intensive-escalate { background-color: #F97316; color: #FFFFFF; }
        .category-intensive { background-color: #F59E0B; color: #1A202C; }
        .category-standard { background-color: #2DD4BF; color: #134E4A; }
        .category-single { background-color: #67E8F9; color: #164E63; }
        .header-gradient { background: linear-gradient(to right, #0D9488, #0F766E); }
        .final-score-bg { background-color: #134E4A; }
        .risk-item-selected-amber { background-color: #fef3c7 !important; border-left: 4px solid #f59e0b !important; padding-left: 8px; border-radius: 4px; }
        .risk-item-selected-amber::before { content: '⚠️'; color: #f59e0b; margin-right: 8px; font-weight: bold; }
        .risk-item-selected-critical { border-left: 4px solid #ef4444 !important; background-color: #fee2e2 !important; padding-left: 8px; border-radius: 4px; }
        .risk-item-selected-critical > span { font-weight: 600; }
        .risk-item-selected-critical::before { content: '❗'; color: #ef4444; margin-right: 8px; font-weight: bold; }
        .module-bg-b { background-color: #f0f9ff; } .module-bg-d { background-color: #fffbeb; } .module-bg-e { background-color: #fef2f2; } .module-bg-f { background-color: #faf5ff; } .module-bg-g { background-color: #f5f3ff; }
        .patient-tabs-container { border-bottom: 1px solid #D1D5DB; }
        .patient-tab { position: relative; cursor: pointer; padding: 0.75rem 1rem; color: #4B5563; border: 1px solid transparent; border-bottom: none; border-top: 4px solid transparent; margin-bottom: -1px; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s ease-in-out; }
        .patient-tab:hover { background-color: #F3F4F6; }
        .patient-tab.active { border-color: #D1D5DB; color: #047857; font-weight: 600; background-color: #FFFFFF; }
        .delete-patient-btn { color: #9CA3AF; font-size: 1.1rem; line-height: 1; padding: 2px; border-radius: 99px; }
        .delete-patient-btn:hover { color: #DC2626; background-color: #FEE2E2; }
        .tab-score-badge { font-size: 0.7rem; font-weight: 700; color: white; padding: 2px 6px; border-radius: 8px; }
        .patient-tab.active.risk-critical { border-top-color: #DC2626; } .patient-tab.active.risk-intensive-escalate { border-top-color: #F97316; } .patient-tab.active.risk-intensive { border-top-color: #F59E0B; } .patient-tab.active.risk-standard { border-top-color: #2DD4BF; } .patient-tab.active.risk-single { border-top-color: #67E8F9; }
        .ward-list-card { border: 1px solid #D1D5DB; border-radius: 6px; overflow: hidden; font-family: sans-serif; font-size: 9pt; background-color: #fff; display: flex; flex-direction: column; break-inside: avoid; }
        .ward-list-header { display: flex; justify-content: space-between; align-items: center; padding: 4px 8px; background-color: #F3F4F6; border-bottom: 1px solid #D1D5DB; }
        .ward-list-header h3 { font-size: 11pt; font-weight: bold; margin: 0; }
        .ward-list-header .score-box { text-align: right; }
        .ward-list-body { padding: 8px; flex-grow: 1; line-height: 1.4; }
        .ward-list-section { margin-bottom: 6px; } .ward-list-section:last-child { margin-bottom: 0; }
        .ward-list-section h4 { font-size: 9pt; font-weight: bold; margin: 0 0 4px 0; padding-bottom: 2px; border-bottom: 1px solid #E5E7EB;}
        .ward-list-section p, .ward-list-section ul { margin: 0; font-size: 8.5pt; }
        .ward-list-section ul { padding-left: 1.2em; margin: 0; list-style-position: outside; } .ward-list-section ul li { margin-bottom: 2px; }
        .device-flag { color: #b91c1c; font-weight: bold; font-style: italic; }
        .device-flag-inline { color: #b91c1c; font-weight: bold; font-style: italic; font-size: 0.8rem; margin-left: 8px; }
        @media print { @page { size: A4 landscape; margin: 0.5in; } body > *:not(#printoutContainer) { display: none !important; } #printoutContainer { display: block !important; } #printoutContainer h1 { text-align: center; font-size: 14pt; margin-bottom: 1rem; } .print-grid-container { display: grid; grid-template-columns: repeat(3, 1fr); grid-auto-rows: min-content; gap: 12px; height: 100%; } }
        .digital-list-container { display: flex; flex-direction: column; gap: 1rem; }
        .blood-score { font-size: 0.75rem; font-weight: 600; padding: 2px 4px; border-radius: 4px; color: #fff; } .score-amber { background-color: #F59E0B; } .score-red { background-color: #EF4444; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg mb-6 p-4">
            <div class="flex justify-end items-center mb-3">
                <div class="flex items-center gap-2">
                    <button id="addPatientBtn" type="button" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-3 rounded-lg text-sm transition-colors">Add Patient</button>
                    <button id="printListBtn" type="button" class="bg-blue-100 text-blue-800 hover:bg-blue-200 font-semibold py-2 px-3 rounded-lg text-sm transition-colors">Print List</button>
                    <button id="digitalListBtn" type="button" class="bg-indigo-100 text-indigo-800 hover:bg-indigo-200 font-semibold py-2 px-3 rounded-lg text-sm transition-colors">Digital List</button>
                    <button id="clearDataBtn" type="button" class="bg-red-100 text-red-800 hover:bg-red-200 font-semibold py-2 px-3 rounded-lg text-sm transition-colors">Clear Data</button>
                </div>
            </div>
            <div id="patientTabsContainer" class="patient-tabs-container flex flex-wrap items-center"></div>
        </div>

        <form id="assessmentForm" onsubmit="return false;">
            <div class="bg-white rounded-xl shadow-lg mb-6 overflow-hidden">
                <div class="header-gradient p-6 flex items-center justify-center text-white">
                    <div class="bg-white/20 rounded-full p-2 mr-4"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div>
                    <h1 class="text-2xl sm:text-3xl font-bold">ALERT Nursing Risk Assessment Tool</h1>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg mb-6 p-6 space-y-6">
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Patient & Review Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm">
                        <div class="md:col-span-2">
                            <label for="reviewType" class="block font-medium text-gray-700">Type of Review:</label>
                            <select id="reviewType" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                <option value="post">Post-ICU stepdown review on ward</option><option value="pre">Pre-ICU stepdown review</option>
                            </select>
                        </div>
                        <div>
                            <label for="patientInitials" class="block font-medium text-gray-700">Patient Initials:</label>
                            <input type="text" id="patientInitials" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                        </div>
                        <div>
                            <label for="wardAndRoom" class="block font-medium text-gray-700">Ward & Room No.:</label>
                            <input type="text" id="wardAndRoom" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                        </div>
                        <div id="postStepdownFields" class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4 md:col-span-2">
                            <div>
                                <label for="icuStepdownDate" class="block font-medium text-gray-700">ICU Stepdown Date:</label>
                                <input type="date" id="icuStepdownDate" class="time-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                            </div>
                            <div>
                                <label for="icuStepdownTime" class="block font-medium text-gray-700">ICU Stepdown Time-band:</label>
                                <select id="icuStepdownTime" class="time-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                    <option value="09:00" data-ooh="false">Morning (0600-1159)</option><option value="15:00" data-ooh="false">Afternoon (1200-1759)</option><option value="21:00" data-ooh="true">Evening (1800-2359)</option><option value="03:00" data-ooh="true">Night (0000-0559)</option>
                                </select>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <label for="losDays" class="block font-medium text-gray-700">ICU LOS (days):</label>
                            <input type="number" id="losDays" min="0" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                        </div>
                    </div>
                    <div class="mt-6 pt-4 border-t grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="goc" class="block text-sm font-medium text-gray-700">Goals of Care:</label>
                            <select id="goc" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                                <option value="">Not Documented</option><option value="A">A</option><option value="B">B</option><option value="C">C</option>
                            </select>
                            <div id="gocSpecificsContainer" class="hidden mt-2">
                                <label for="gocSpecifics" class="block text-sm font-medium text-gray-700">Specifics:</label>
                                <input type="text" id="gocSpecifics" class="mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                            </div>
                        </div>
                        <div id="allergies-section">
                            <label class="block text-sm font-medium text-gray-700">Allergies:</label>
                            <div class="mt-2 space-y-2">
                                <div class="flex items-center"><input type="checkbox" id="nkdaCheckbox" class="h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500"><label for="nkdaCheckbox" class="ml-2 block text-sm text-gray-900">No Known Drug Allergies (NKDA)</label></div>
                                <div id="allergies_container" class="space-y-2"></div>
                                <button type="button" id="addAllergyButton" class="mt-2 text-sm bg-blue-100 text-blue-800 hover:bg-blue-200 px-3 py-1 rounded-md">+ Add Allergy</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Pre-Review Observations</h3>
                    <div class="space-y-2 text-sm">
                        <label class="flex items-center p-1"><input type="radio" name="pre_review_method" value="direct" checked> <span class="ml-2">Enter Documented ADDS</span></label>
                        <label class="flex items-center p-1"><input type="radio" name="pre_review_method" value="calculate"> <span class="ml-2">Calculate from Observations</span></label>
                    </div>
                    <div id="pre_review_direct_container" class="mt-4 pl-6 space-y-3">
                        <div>
                            <label for="initialAdds" class="block text-sm font-medium text-gray-700">Last Documented ADDS:</label>
                            <input type="number" id="initialAdds" class="mt-1 block w-full md:w-1/2 rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm">
                        </div>
                    </div>
                    <div id="pre_review_calculate_container" class="hidden mt-4 pl-6 space-y-3">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-2 text-sm items-end">
                            <div><label>RR</label><input type="number" id="pre_rr" class="pre-obs-input mt-1 block w-full rounded-md border-2 border-gray-300 p-1"></div>
                            <div><label>SpO2</label><input type="number" id="pre_spo2" class="pre-obs-input mt-1 block w-full rounded-md border-2 border-gray-300 p-1"></div>
                            <div><label>O2 Flow</label><input type="number" id="pre_o2" class="pre-obs-input mt-1 block w-full rounded-md border-2 border-gray-300 p-1"></div>
                            <div><label>O2 Unit</label><select id="pre_o2_unit" class="pre-obs-input mt-1 block w-full rounded-md border-2 border-gray-300 p-1"><option value="lpm">L/min</option><option value="fio2">%</option></select></div>
                            <div><label>HR</label><input type="number" id="pre_hr" class="pre-obs-input mt-1 block w-full rounded-md border-2 border-gray-300 p-1"></div>
                            <div><label>SBP</label><input type="number" id="pre_sbp" class="pre-obs-input mt-1 block w-full rounded-md border-2 border-gray-300 p-1"></div>
                            <div><label>Temp</label><input type="number" step="0.1" id="pre_temp" class="pre-obs-input mt-1 block w-full rounded-md border-2 border-gray-300 p-1"></div>
                            <div class="col-span-2 md:col-span-1"><label>Consciousness</label><select id="pre_consciousness" class="pre-obs-input mt-1 block w-full rounded-md border-2 border-gray-300 p-1"><option value="0">Alert</option><option value="1">Voice</option><option value="2">Pain</option><option value="3">Unresponsive</option></select></div>
                        </div>
                        <div class="mt-2 text-sm"><span class="font-semibold">Calculated ADDS: <span id="pre_calculated_adds">0</span></span></div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Reason for ICU Admission:</h3>
                    <textarea id="admissionReason" rows="3" class="mt-1 block w-full rounded-md border-2 border-gray-400 bg-gray-100 shadow-sm p-2 text-sm"></textarea>
                </div>
                 <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">ICU Summary / Timeline:</h3>
                    <textarea id="icuSummary" rows="10" class="mt-1 block w-full rounded-md border-2 border-gray-400 bg-gray-100 shadow-sm p-2 text-sm"></textarea>
                </div>
                
                <details class="bg-gray-50 p-4 rounded-lg border border-gray-200" open>
                    <summary class="font-semibold text-gray-700 cursor-pointer">Device, Drain & Wound Assessment</summary>
                    <div class="space-y-6 pt-4">
                        <div id="default_devices">
                            <h4 class="font-medium text-gray-600 mb-2">Central Vascular Access Devices (CVADs)</h4>
                            <div id="central_lines_container" class="space-y-4"></div>
                            <button type="button" id="addCentralLineButton" class="mt-2 text-sm bg-rose-100 text-rose-800 hover:bg-rose-200 px-3 py-1 rounded-md">+ Add CVAD</button>
                        </div>
                         <div class="mt-6">
                            <h4 class="font-medium text-gray-600 mb-2">Peripheral IV Cannulas (PIVCs)</h4>
                            <div id="pivcs_container" class="space-y-4"></div>
                            <button type="button" id="addPivcButton" class="mt-2 text-sm bg-blue-100 text-blue-800 hover:bg-blue-200 px-3 py-1 rounded-md">+ Add PIVC</button>
                        </div>
                        <details class="pt-4 border-t">
                            <summary class="text-sm font-medium text-blue-700 cursor-pointer">Show Additional Devices, Drains & Wounds</summary>
                            <div class="space-y-6 pt-4">
                                <div><h4 class="font-medium text-gray-600 mb-2">GI / Enteral Devices</h4><div id="ng_tubes_container" class="space-y-4"></div><button type="button" id="addNgTubeButton" class="mt-2 text-sm bg-green-100 text-green-800 hover:bg-green-200 px-3 py-1 rounded-md">+ Add Enteral Device</button></div>
                                <div><h4 class="font-medium text-gray-600 mb-2">Epicardial Pacing Wires</h4><div id="pacing_wires_container" class="space-y-4"></div><button type="button" id="addPacingWiresButton" class="mt-2 text-sm bg-purple-100 text-purple-800 hover:bg-purple-200 px-3 py-1 rounded-md">+ Add Pacing Wires</button></div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t">
                                    <div><h4 class="font-medium text-gray-600 mb-2">Drains</h4><div id="drains_container" class="space-y-4"></div><button type="button" id="addDrainButton" class="mt-2 text-sm bg-teal-100 text-teal-800 hover:bg-teal-200 px-3 py-1 rounded-md">+ Add Drain</button></div>
                                    <div><h4 class="font-medium text-gray-600 mb-2">Wounds</h4><div id="wounds_container" class="space-y-4"></div><button type="button" id="addWoundButton" class="mt-2 text-sm bg-pink-100 text-pink-800 hover:bg-pink-200 px-3 py-1 rounded-md">+ Add Wound</button></div>
                                </div>
                            </div>
                        </details>
                    </div>
                </details>
            </div>

            <div class="bg-white rounded-xl shadow-lg mb-6 p-6">
                 <div id="scoringContainer">
                    <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">RISK SCORING ASSESSMENT</h2>
                    <div class="space-y-8">
                         <div class="rounded-lg module-bg-b"><h3 class="font-bold text-xl mb-3 p-3 rounded-t-lg bg-blue-200 text-blue-800">Physiological & Respiratory Stability</h3><div class="space-y-2 p-4">
                            <label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="15" data-id="crit_met" id="crit_met" data-is-critical="true"> <span class="ml-2">Patient is in MET Criteria</span> <span class="text-gray-600">(+15)</span></label>
                            <hr class="my-3">
                            <label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="10" data-id="crit_adds4" id="crit_adds4" data-is-critical="true"> <span class="ml-2">ADDS Score ≥ 4</span> <span class="text-gray-600">(+10)</span></label>
                            <label class="flex items-center p-1"><input type="radio" name="adds_score" class="score-input" data-score="5" data-id="adds_3" id="adds_3" data-is-amber="true"> <span class="ml-2">ADDS Score 3</span> <span class="text-gray-600">(+5)</span></label>
                            <label class="flex items-center p-1"><input type="radio" name="adds_score" class="score-input" data-score="1" data-id="adds_0-2" id="adds_0-2" checked> <span class="ml-2">ADDS Score 0-2</span> <span class="text-gray-600">(+1)</span></label>
                            <hr class="my-3">
                            <label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="5" data-id="adds_worsening" id="adds_worsening" data-is-amber="true"> <span class="ml-2">Worsening ADDS Trend (last 12-24h) (+5)</span></label>
                            <label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="10" data-id="resp_increasing_o2" id="resp_increasing_o2" data-is-amber="true"> <span class="ml-2">Increasing O2 requirements in last 12h</span> <span class="text-gray-600">(+10)</span></label>
                            <label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="6" data-id="resp_rapid_wean" id="resp_rapid_wean" data-is-amber="true"> <span class="ml-2">Rapid weaning of resp support in last 4h (+6)</span></label>
                        </div></div>
                        <div class="p-4 rounded-lg module-bg-d"><h3 class="font-bold text-xl mb-3 p-3 rounded-t-lg bg-yellow-200 text-yellow-800">Clinical</h3><div class="space-y-2 p-4">
                            <label class="flex items-center p-1"><input type="radio" name="pain_score" class="score-input" data-score="0" data-id="pain_0" id="pain_0" checked> <span class="ml-2 text-gray-500">Pain: Well Controlled</span></label><label class="flex items-center p-1"><input type="radio" name="pain_score" class="score-input" data-score="3" data-id="pain_iv" id="pain_iv"> <span class="ml-2">Pain: Requires regular IV/potent analgesia (+3)</span></label><label class="flex items-center p-1"><input type="radio" name="pain_score" class="score-input" data-score="5" data-id="pain_pca" id="pain_pca"> <span class="ml-2">Pain: Poorly controlled or PCA (+5)</span></label><hr class="my-2"><label class="flex items-center p-1"><input type="radio" name="fluid_status_score" class="score-input" data-score="0" data-id="fluid_0" id="fluid_0" checked> <span class="ml-2 text-gray-500">Fluid Status: Euvolaemic</span></label><label class="flex items-center p-1"><input type="radio" name="fluid_status_score" class="score-input" data-score="2" data-id="fluid_mild" id="fluid_mild"> <span class="ml-2">Mild dehydration or overload (+2)</span></label><label class="flex items-center p-1"><input type="radio" name="fluid_status_score" class="score-input" data-score="4" data-id="fluid_sig" id="fluid_sig" data-is-critical="true"> <span class="ml-2">Significant dehydration or overload (+4)</span></label><hr class="my-2"><label class="flex items-center p-1"><input type="radio" name="diet_score" class="score-input" data-score="0" data-id="diet_0" id="diet_0" checked> <span class="ml-2 text-gray-500">Diet: Normal</span></label><label class="flex items-center p-1"><input type="radio" name="diet_score" class="score-input" data-score="2" data-id="diet_modified" id="diet_modified"> <span class="ml-2">Diet: Supplements or Modified (+2)</span></label><label class="flex items-center p-1"><input type="radio" name="diet_score" class="score-input" data-score="4" data-id="diet_nbm" id="diet_nbm"> <span class="ml-2">Diet: NBM, NG, or TPN (+4)</span></label><hr class="my-2"><label class="flex items-center p-1"><input type="radio" name="delirium_score" class="score-input" data-score="0" data-id="delirium_0" id="delirium_0" checked> <span class="ml-2 text-gray-500">Delirium: None</span></label><label class="flex items-center p-1"><input type="radio" name="delirium_score" class="score-input" data-score="4" data-id="delirium_mild" id="delirium_mild"> <span class="ml-2">Delirium: Mild or Subsyndromal (+4)</span></label><label class="flex items-center p-1"><input type="radio" name="delirium_score" class="score-input" data-score="8" data-id="delirium_mod" id="delirium_mod" data-is-critical="true"> <span class="ml-2">Delirium: Moderate to Severe</span> <span class="text-gray-600">(+8)</span></label><hr class="my-2"><label class="flex items-center p-1"><input type="radio" name="mobility_score" class="score-input" data-score="0" data-id="mobility_0" id="mobility_0" checked> <span class="ml-2 text-gray-500">Mobility: At Baseline</span></label><label class="flex items-center p-1"><input type="radio" name="mobility_score" class="score-input" data-score="2" data-id="mobility_assisted" id="mobility_assisted"> <span class="ml-2">Mobility: Assisted (+2)</span></label><label class="flex items-center p-1"><input type="radio" name="mobility_score" class="score-input" data-score="5" data-id="mobility_bedbound" id="mobility_bedbound"> <span class="ml-2">Mobility: Bed-bound (+5)</span></label><hr class="my-2"><label class="flex items-center p-1"><input type="radio" name="lines_score" class="score-input" data-score="0" data-id="lines_0" id="lines_0" checked> <span class="ml-2 text-gray-500">Lines: None or PIVC only</span></label><label class="flex items-center p-1"><input type="radio" name="lines_score" class="score-input" data-score="5" data-id="lines_cvc_present" id="lines_cvc_present"> <span class="ml-2">Central Line present (CVC/PICC/Vascath) (+5)</span></label><hr class="my-3">
                            <label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="10" data-id="crit_af" id="crit_af" data-is-critical="true"> <span class="ml-2">Unstable Atrial Fibrillation</span> <span class="text-gray-600">(+10)</span></label>
                            <label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="3" data-id="bowels_issue" id="bowels_issue"> <span class="ml-2">Bowels: Not opened >3 days or Ileus (+3)</span></label>
                            <label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="5" data-id="airway_altered" id="airway_altered" data-is-critical="true"> <span class="ml-2">Altered Airway (Tracheostomy/Laryngectomy) (+5)</span></label>
                            <label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="3" data-id="drains_high_risk" id="drains_high_risk"> <span class="ml-2">High-Risk Drain present (+3)</span></label>
                        </div></div>
                        <div class="p-4 rounded-lg module-bg-e"><h3 class="font-bold text-xl mb-3 p-3 rounded-t-lg bg-red-200 text-red-800">Systemic</h3><div class="space-y-4 p-4">
                            <div class="flex items-center gap-2"><label for="losDaysSystemic" class="ml-2">ICU LOS (days)</label><input type="number" id="losDaysSystemic" min="0" class="score-input-manual mt-1 block w-24 rounded-md border-2 border-gray-300 p-2 text-sm"><span class="text-gray-600">(+4 if >3 days)</span></div>
                            <hr class="my-2">
                            <label class="flex items-center p-1"><input type="radio" name="frailty_score" class="score-input" data-score="0" data-id="frailty_0" id="frailty_0" checked> <span class="ml-2 text-gray-500">Frailty: Not Frail</span></label><label class="flex items-center p-1"><input type="radio" name="frailty_score" class="score-input" data-score="2" data-id="frailty_mild" id="frailty_mild"> <span class="ml-2">Frailty: Mild (+2)</span></label><label class="flex items-center p-1"><input type="radio" name="frailty_score" class="score-input" data-score="4" data-id="frailty_mod" id="frailty_mod"> <span class="ml-2">Frailty: Mod-Severe (+4)</span></label><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="4" data-id="systemic_comorbid" id="systemic_comorbid"> <span class="ml-2">≥3 chronic comorbidities (+4)</span></label>
                            <div id="after_hours_container"><label class="flex items-center p-1"><input type="checkbox" class="score-input" data-score="0" data-id="systemic_after_hours" id="systemic_after_hours" data-is-amber="true"> <span class="ml-2">After-Hours Discharge <span class="text-gray-400 text-xs">(first 24h)</span></span></label></div>
                        </div></div>
                        <div id="receivingWardModule" class="p-4 rounded-lg module-bg-g"><h3 class="font-bold text-xl mb-3 p-3 rounded-t-lg bg-indigo-200 text-indigo-800">Receiving Ward and Staffing</h3><div class="space-y-4 p-4"><div><h4 class="block text-sm font-medium text-gray-700 mb-2">Bed Type</h4><label class="flex items-center p-1"><input type="radio" name="bed_type" class="score-input" data-score="0" data-id="env_unmonitored" id="env_unmonitored" checked> <span class="ml-2">Unmonitored Bed (+0)</span></label><label class="flex items-center p-1"><input type="radio" name="bed_type" class="score-input" data-score="-3" data-id="env_monitored" id="env_monitored"> <span class="ml-2">Monitored / Telemetry Bed (-3)</span></label></div><hr><div><h4 class="block text-sm font-medium text-gray-700 mb-2">Staffing</h4><label class="flex items-center p-1"><input type="radio" name="env_ratio" class="score-input" data-score="0" data-id="env_standard" id="env_standard" checked> <span class="ml-2">Standard Ward Ratio (+0)</span></label><label class="flex items-center p-1"><input type="radio" name="env_ratio" class="score-input" data-score="-5" data-id="env_enhanced" id="env_enhanced"> <span class="ml-2">Enhanced Ratio (e.g. 1:1, 1:2) (-5)</span></label></div></div></div>
                        <div class="p-4 rounded-lg module-bg-d"><h3 class="font-bold text-xl mb-3 p-3 rounded-t-lg bg-yellow-200 text-yellow-800">Nursing Concern</h3><div class="pt-2 p-4"><label class="flex items-center p-1"><input type="radio" name="concern_score" class="score-input" data-score="0" data-id="concern_0" id="concern_0" value="0" checked> <span class="ml-2 text-gray-500">Nursing Concern: None</span></label><label class="flex items-center p-1"><input type="radio" name="concern_score" class="score-input" data-score="5" data-id="concern_present" id="concern_present" value="5" data-is-critical="true"> <span class="ml-2">Nursing Concern Present</span> <span class="text-gray-600">(+5)</span></label><textarea id="nursingConcernText" class="mt-2 ml-6 w-full rounded-md border-gray-300 shadow-sm text-sm" rows="2" placeholder="Specify concern..." style="display: none;"></textarea></div></div>
                    </div>
                </div>

                <div class="final-score-bg text-white rounded-xl shadow-lg p-6 mt-8">
                    <div class="flex flex-col sm:flex-row justify-between items-center text-center">
                        <div class="mb-4 sm:mb-0"><span class="text-lg font-medium text-gray-400">Preliminary Score</span><div id="totalScore" class="text-5xl font-bold">0</div><span class="text-xs text-gray-500">(pending patient review)</span></div>
                        <div class="w-full sm:w-auto"><span class="text-lg font-medium text-gray-400">Preliminary Category & Action</span><div id="riskCategory" class="text-xl font-bold p-3 rounded-md mt-1 transition-all duration-300"></div></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg mb-6 p-6 space-y-6">
                <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-6">ALERT Nurse Assessment</h2>
                <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-gray-700 mb-2">ADDS</h3>
                    <p class="text-xs italic text-gray-500 mb-4">Entering observations here will calculate a new ADDS and update the final score.</p>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center"><label class="block text-sm font-medium text-gray-700 sm:col-span-1">Resp Rate</label><div class="sm:col-span-2"><input type="number" id="rr_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div></div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center"><label class="block text-sm font-medium text-gray-700 sm:col-span-1">SpO2 (%)</label><div class="sm:col-span-2"><input type="number" id="spo2_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div></div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center"><label class="block text-sm font-medium text-gray-700 sm:col-span-1">Oxygen Delivery</label><div class="sm:col-span-2 flex items-center space-x-2"><input type="number" id="o2_flow_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm" placeholder="Value"><select id="o2_unit_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="lpm">L/min</option><option value="fio2">% FiO2</option></select></div></div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center"><label class="block text-sm font-medium text-gray-700 sm:col-span-1">Heart Rate</label><div class="sm:col-span-2"><input type="number" id="hr_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div></div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center"><label class="block text-sm font-medium text-gray-700 sm:col-span-1">SBP (mmHg)</label><div class="sm:col-span-2"><input type="number" id="sbp_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div></div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center"><label class="block text-sm font-medium text-gray-700 sm:col-span-1">Consciousness</label><div class="sm:col-span-2"><select id="consciousness_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"><option value="0">Alert</option><option value="1">Voice</option><option value="2">Pain</option><option value="3">Unresponsive</option></select></div></div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center"><label class="block text-sm font-medium text-gray-700 sm:col-span-1">Temp (°C)</label><div class="sm:col-span-2"><input type="number" step="0.1" id="temp_input" class="vital-input mt-1 block w-full rounded-md border-2 border-gray-300 bg-white shadow-sm p-2 text-sm"></div></div>
                    </div>
                    <div class="mt-6 bg-teal-50 p-4 rounded-lg text-center border border-teal-200">
                        <span class="text-sm font-medium text-gray-500">CALCULATED ADDS</span>
                        <div id="calculatedADDSScore" class="font-bold text-5xl text-teal-600 my-2">0</div>
                        <div id="addsBreakdown" class="text-xs text-gray-600 min-h-[3em]">Normal Parameters</div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Post-ICU Syndrome (PICS)</h3>
                    <div class="p-4 rounded-lg module-bg-f"><div class="space-y-2 p-4">
                        <div class="flex flex-wrap items-center gap-x-6 gap-y-2">
                            <label class="flex items-center text-sm"><input type="radio" name="pics_status" value="negative" checked> <span class="ml-2">Negative</span></label>
                            <label class="flex items-center text-sm"><input type="radio" name="pics_status" value="positive"> <span class="ml-2">Positive</span></label>
                            <label class="flex items-center text-sm"><input type="radio" name="pics_status" value="unable"> <span class="ml-2">Unable to assess</span></label>
                        </div>
                        <div id="pics_details_container" class="hidden ml-6 mt-2">
                            <label for="pics_notes" class="block text-sm font-medium text-gray-700">Information / Plan:</label>
                            <textarea id="pics_notes" rows="2" class="mt-1 block w-full rounded-md border-2 border-gray-400 bg-gray-100 shadow-sm p-2 text-sm" placeholder="Information/Plan..."></textarea>
                        </div>
                    </div></div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg mt-6 p-6">
                <div class="final-score-bg text-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex flex-col sm:flex-row justify-between items-center text-center">
                        <div class="mb-4 sm:mb-0"><span class="text-lg font-medium text-gray-400">Updated Final Score</span><div id="updatedTotalScore" class="text-5xl font-bold">0</div></div>
                        <div class="w-full sm:w-auto"><span class="text-lg font-medium text-gray-400">FINAL CATEGORY & ACTION</span><div id="updatedRiskCategory" class="text-xl font-bold p-3 rounded-md mt-1 transition-all duration-300"></div></div>
                    </div>
                </div>
                <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">DMR Summary Generator</h2>
                <div class="flex space-x-4 mb-4"><button type="button" id="generateSummaryButton" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-1/2">Generate DMR Summary</button><button type="button" id="copySummaryButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors w-1/2">Copy to Clipboard</button></div>
                <textarea id="emrSummary" rows="20" class="w-full p-2 border border-gray-300 rounded-md bg-gray-50 font-mono text-xs" placeholder="Your summary will appear here..."></textarea>
            </div>
        </form>
    </div>
    
    <div id="digitalListModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-6xl max-h-[90vh] flex flex-col"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">Digital Ward List</h2><button id="closeDigitalListModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div><div id="digitalListContent" class="flex-grow overflow-y-auto border p-4 bg-gray-50 text-sm"></div></div></div>
    <div id="printoutContainer" class="hidden"></div>
    <div class="text-center mt-8 text-gray-500 text-sm">Version 5.2.2 - Bug Fixes & UX Update</div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Element References ---
        const assessmentForm = document.getElementById('assessmentForm');
        const scoreInputs = document.querySelectorAll('.score-input');
        const totalScoreEl = document.getElementById('totalScore');
        const riskCategoryEl = document.getElementById('riskCategory');
        const updatedTotalScoreEl = document.getElementById('updatedTotalScore');
        const updatedRiskCategoryEl = document.getElementById('updatedRiskCategory');
        const emrSummaryEl = document.getElementById('emrSummary');
        const calculatedADDSEl = document.getElementById('calculatedADDSScore');
        const addsBreakdownEl = document.getElementById('addsBreakdown');
        const picsDetailsContainer = document.getElementById('pics_details_container');
        const nursingConcernText = document.getElementById('nursingConcernText');
        const postStepdownFields = document.getElementById('postStepdownFields');
        const afterHoursContainer = document.getElementById('after_hours_container');
        const afterHoursCheckbox = document.getElementById('systemic_after_hours_checkbox');
        const gocSpecificsContainer = document.getElementById('gocSpecificsContainer');
        const allergiesContainer = document.getElementById('allergies_container');
        const centralLinesContainer = document.getElementById('central_lines_container');
        const pivcsContainer = document.getElementById('pivcs_container');
        const ngTubesContainer = document.getElementById('ng_tubes_container');
        const pacingWiresContainer = document.getElementById('pacing_wires_container');
        const drainsContainer = document.getElementById('drains_container');
        const woundsContainer = document.getElementById('wounds_container');
        const patientTabsContainer = document.getElementById('patientTabsContainer');
        const digitalListModal = document.getElementById('digitalListModal');
        const digitalListContent = document.getElementById('digitalListContent');
        const printoutContainer = document.getElementById('printoutContainer');
        
        // --- State Management ---
        let patients = {};
        let activePatientId = null;
        const LOCAL_STORAGE_KEY = 'alertToolPatientData_v5.2.2'; 
        let addsScoreContribution = 0;

        const categoryColorMap = { 'risk-critical': '#DC2626', 'risk-intensive-escalate': '#F97316', 'risk-intensive': '#F59E0B', 'risk-standard': '#2DD4BF', 'risk-single': '#67E8F9' };
        const carePlanMap = { 'crit_met': 'CRITICAL: Patient is in MET Criteria. Liaise with ICU and home teams for mitigation plan before stepdown.', 'crit_adds4': 'CRITICAL: High ADDS score indicates physiological instability. Escalate for urgent medical review (<30 mins) & follow AORC pathway.', 'crit_af': "CRITICAL: Unstable AF requires urgent intervention. Escalate for cardiology/medical review & perform 12-lead ECG.", 'resp_increasing_o2': 'Respiratory Plan: Increasing O2 needs. Perform focused respiratory assessments (WOB) per AORC. Document RR/O2 trends. Liaise with medical team.', 'resp_rapid_wean': 'Respiratory Plan: Recent rapid wean of resp support. Perform focused respiratory assessments (WOB) for signs of fatigue.', 'pain_pca': 'Pain Management: Pain appears poorly controlled. Perform comprehensive pain assessments (0-10) with each obs set. Optimise analgesia. Escalate to Acute Pain Service if severe.', 'fluid_sig': 'Fluid Management: Significant fluid imbalance identified. Maintain strict FBC & daily weights. Perform clinical fluid assessment. Liaise with medical team to review fluid orders.', 'delirium_mod': 'Cognitive Support: Implement delirium prevention/management strategies. Liaise with medical team & pharmacy to review for deliriogenic medications.', 'mobility_bedbound': 'Mobility & Pressure Care: Implement pressure injury prevention bundle. Liaise with physiotherapy for in-bed exercise plan.', 'airway_altered': 'Airway Management: Ensure appropriate bed location with trained staff & emergency equipment at bedside. Contact ALERT CNS for support if required.', 'lines_cvc_present': 'Line Management: Daily review of Central Line necessity with medical team. Maintain strict ANTT & monitor site for infection (CLABSI bundle).', 'drains_high_risk': 'Drain Management: Close monitoring of drain patency, output, and volume. Escalate to home team for any sudden changes.', 'bowels_issue': 'Bowel Management: Patient has not opened bowels >3 days. Monitor for abdominal distension/discomfort. Escalate to medical team for review.', 'concern_present': "Nursing Concerns: Articulate specific nursing concerns and escalate to senior nursing/medical staff for a 'fresh eyes' review.", 'frailty_mod': 'Frailty Plan: Ensure active PT/OT referrals. Focus on falls prevention and nutritional support.', 'crit_lactate_high': 'CRITICAL BIOCHEMISTRY: High lactate requires urgent escalation to medical team. Consider fluid bolus as per AORC and repeat lactate within 4 hours.', 'crit_hb_drop': 'CRITICAL BIOCHEMISTRY: Significant Hb drop/active bleeding requires urgent medical/surgical escalation. Ensure patent IV access & consider group and hold.', 'bloods_electrolytes_unmanaged': 'BIOCHEMISTRY: Unmanaged electrolyte abnormalities noted. Escalate to medical officer for review and prescribing of replacement therapy. For severe K+ issues, contact ALERT CNS.', 'bloods_aki': 'BIOCHEMISTRY: Worsening renal function. Maintain strict FBC and monitor urine output. Escalate if UO < 0.5ml/kg/hr. Liaise with pharmacy to review nephrotoxic medications.', 'bloods_low_albumin': 'NUTRITION: Significant hypoalbuminaemia noted. Ensure active dietitian referral for nutritional assessment. Monitor for oedema.'};
        const impressionMap = {'crit_met':'is currently meeting MET criteria','crit_adds4':'has a high ADDS score indicating physiological instability','crit_af':'is in unstable atrial fibrillation','delirium_mod':'is suffering from moderate to severe delirium','fluid_sig':'has a significant fluid imbalance','pain_pca':'has poorly controlled pain requiring advanced analgesia','concern_present':'has specific concerns raised by the bedside nursing staff', 'crit_lactate_high':'has a critically high lactate concerning for hypoperfusion','crit_hb_drop':'has had a significant drop in haemoglobin or is actively bleeding','resp_increasing_o2':'has increasing oxygen requirements'};
        let standardScores = { getRrScore(rr) { let s=0,m=false; if(rr>=36||rr<5)m=true;else if(rr>=30&&rr<=35)s=3;else if(rr>=25&&rr<=29)s=2;else if(rr>=21&&rr<=24)s=1;else if(rr>=5&&rr<=9)s=3; return {score:s, isMet:m}; }, getSpo2Score(spo2) { let s=0; if(spo2<=84)s=3;else if(spo2>=85&&spo2<=90)s=2;else if(spo2>=91&&spo2<=93)s=1; return {score:s}; }, getO2Score(o2Flow, o2Unit) { let s=0; if(o2Unit==='lpm'){if(o2Flow>10)s=3;else if(o2Flow>=5&&o2Flow<=9)s=2;else if(o2Flow>=2&&o2Flow<=4)s=1}else{if(o2Flow>=40)s=3;else if(o2Flow>=29)s=2;else if(o2Flow>=21)s=1} return {score:s}; }, getHrScore(hr) { let s=0,m=false; if(hr>=140||hr<30)m=true;else if(hr>=130&&hr<=139)s=3;else if(hr>=120&&hr<=129)s=2;else if(hr>=100&&hr<=119)s=1;else if(hr>=40&&hr<=49)s=1;else if(hr>=30&&hr<=39)s=2; return {score:s, isMet:m}; }, getSbpScore(sbp) { let s=0,m=false; if(sbp<90)m=true;else if(sbp>=190&&sbp<=199)s=3;else if(sbp>=180&&sbp<=189)s=2;else if(sbp>=150&&sbp<=179)s=1;else if(sbp>=80&&sbp<=99)s=1;else if(sbp>=70&&sbp<=79)s=2; return {score:s, isMet:m}; }, getConsciousnessScore(c) { let s=0,m=false; if(c===3)m=true;else if(c>0)s=c; return {score:s, isMet:m}; } };
        
        const safeGet = (id) => document.getElementById(id)?.value || '';
        const safeIsChecked = (id) => document.getElementById(id)?.checked || false;
        const getSelectText = (el) => el ? (el.options[el.selectedIndex]?.text || '') : '';
        const safeGetNum = (id) => { const val = parseFloat(safeGet(id)); return isNaN(val) ? null : val; };
        
        function resetForm(){ assessmentForm.reset(); document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], textarea').forEach(el => el.value = ''); document.querySelectorAll('select').forEach(el => el.selectedIndex = 0); document.querySelectorAll('input[type="checkbox"]').forEach(i => i.checked = false); document.querySelectorAll('input[type="radio"]').forEach(rb=>{ if(rb.name.endsWith('_score') || ['bed_type','env_ratio','pics_status','pre_review_method'].includes(rb.name)){ rb.checked = rb.dataset.score === "0" || rb.value === "negative" || rb.value === "direct" }}); nursingConcernText.style.display='none'; gocSpecificsContainer.classList.add('hidden'); allergiesContainer.innerHTML = ''; document.getElementById('addAllergyButton').style.display = 'block'; [centralLinesContainer, pivcsContainer, ngTubesContainer, drainsContainer, woundsContainer, pacingWiresContainer].forEach(c => c.innerHTML = ''); picsDetailsContainer.classList.add('hidden'); emrSummaryEl.value = ''; document.getElementById('reviewType').dispatchEvent(new Event('change')); calculateADDS(); }

        function calculateScore() {
            let totalScore = addsScoreContribution + (window.bloodsScoreContribution || 0);
            document.querySelectorAll('.score-input:checked').forEach(input => { if (input.name !== 'adds_score') totalScore += parseInt(input.dataset.score, 10) || 0; });
            const losDays = safeGetNum('losDaysSystemic');
            if(losDays && losDays > 3) totalScore += 4;
            totalScoreEl.textContent = totalScore; updatedTotalScoreEl.textContent = totalScore; updateRiskCategory(totalScore);
        }

        function updateRiskCategory(score) { let categoryText = ''; let categoryClass = ''; let followUpMessage = ''; if (score > 40) { categoryText = 'Critical Risks - Immediate Senior Review'; categoryClass = 'category-critical'; } else if (score >= 30) { categoryText = 'Intensive (72hr) + Consider Medical Escalation'; categoryClass = 'category-intensive-escalate'; } else if (score >= 10) { categoryText = 'Intensive ALERT Follow up (up to 72hr)'; categoryClass = 'category-intensive'; } else if (score >= 4) { categoryText = 'Standard ALERT Follow up (up to 24hr)'; categoryClass = 'category-standard'; } else { categoryText = 'Single Review Required'; categoryClass = 'category-single'; } const stepdownDateStr = safeGet('icuStepdownDate'); if (stepdownDateStr) { const hoursSince = (new Date() - new Date(stepdownDateStr)) / 36e5; if (score <= 3 && hoursSince > 24) { followUpMessage = 'Min. f/u time met. Consider discharge from ALERT.'; } else if (score <= 9 && hoursSince > 24) { followUpMessage = '24hr f/u met. Consider discharge from ALERT.'; } else if (score >= 10 && hoursSince > 72) { followUpMessage = '72hr f/u met. Consider transfer to PoC list.'; } } const fullHtml = `${categoryText} <br> <span class="text-sm font-normal">${followUpMessage}</span>`; riskCategoryEl.innerHTML = fullHtml; riskCategoryEl.className = `text-xl font-bold p-3 rounded-md mt-1 transition-all duration-300 ${categoryClass}`; updatedRiskCategoryEl.innerHTML = fullHtml; updatedRiskCategoryEl.className = `text-xl font-bold p-3 rounded-md mt-1 transition-all duration-300 ${categoryClass}`; }
        
        function calculateADDS() {
            let adds = 0; let met = false; const breakdown = [];
            const getVital = (mainId, preId) => { const mainVal = safeGet(mainId); return mainVal !== '' ? mainVal : safeGet(preId); };
            const processVital = (param, value, scoreFn) => { const v = parseInt(value, 10); if (isNaN(v)) return; const res = scoreFn(v); adds += res.score; met = met || res.isMet; if (res.score > 0) breakdown.push(`${param.toUpperCase()}(${res.score})`); };
            const hasMainVitals = ['rr_input','hr_input','sbp_input','spo2_input'].some(id => safeGet(id));
            if (hasMainVitals) {
                processVital('RR', getVital('rr_input'), standardScores.getRrScore); processVital('HR', getVital('hr_input'), standardScores.getHrScore); processVital('SBP', getVital('sbp_input'), standardScores.getSbpScore); processVital('SpO2', getVital('spo2_input'), standardScores.getSpo2Score); processVital('AVPU', getVital('consciousness_input', 'pre_consciousness'), standardScores.getConsciousnessScore);
                const o2Flow = parseFloat(getVital('o2_flow_input', 'pre_o2')); if (!isNaN(o2Flow) && o2Flow > 0) { const res = standardScores.getO2Score(o2Flow, getVital('o2_unit_input', 'pre_o2_unit')); adds += res.score; if(res.score > 0) breakdown.push(`O2(${res.score})`);}
                const temp = parseFloat(getVital('temp_input', 'pre_temp')); if (!isNaN(temp)) { let ts=0; if(temp>=38.6||temp<35.1) ts=2; else if((temp>=38&&temp<=38.5)||(temp>=35.1&&temp<=36)) ts=1; if(ts > 0) { adds+=ts; breakdown.push(`Temp(${ts})`);}}
            } else if (safeIsChecked('pre_review_method_calculate')) {
                processVital('RR', safeGet('pre_rr'), standardScores.getRrScore); processVital('HR', safeGet('pre_hr'), standardScores.getHrScore); processVital('SBP', safeGet('pre_sbp'), standardScores.getSbpScore); processVital('SpO2', safeGet('pre_spo2'), standardScores.getSpo2Score); processVital('AVPU', safeGet('pre_consciousness'), standardScores.getConsciousnessScore);
                const o2 = parseFloat(safeGet('pre_o2')); if(!isNaN(o2) && o2 > 0){ const res = standardScores.getO2Score(o2, safeGet('pre_o2_unit')); adds+=res.score; if(res.score > 0) breakdown.push(`O2(${res.score})`);}
                const temp = parseFloat(safeGet('pre_temp')); if (!isNaN(temp)) { let ts=0; if(temp>=38.6||temp<35.1) ts=2; else if((temp>=38&&temp<=38.5)||(temp>=35.1&&temp<=36)) ts=1; if(ts > 0) { adds+=ts; breakdown.push(`Temp(${ts})`);}}
                document.getElementById('pre_calculated_adds').textContent = met ? 'MET' : adds;
            } else { adds = safeGetNum('initialAdds') || 0; if (adds > 0) breakdown.push(`Direct Entry(${adds})`); }
            
            calculatedADDSEl.textContent = met ? 'MET' : adds; calculatedADDSEl.className = `font-bold text-5xl my-2 ${met ? 'text-red-600' : 'text-teal-600'}`; addsBreakdownEl.textContent = breakdown.length > 0 ? breakdown.join(', ') : 'Normal Parameters';
            document.getElementById('crit_met').checked = met; document.getElementById('crit_adds4').checked = !met && adds >= 4; document.getElementById('adds_3').checked = !met && adds === 3; document.getElementById('adds_0-2').checked = !met && adds >= 0 && adds <= 2;
            if (met) { addsScoreContribution = 0; } else if (adds >= 0 && adds <= 2) { addsScoreContribution = 1; } else if (adds === 3) { addsScoreContribution = 5; } else { addsScoreContribution = 0; }
            updateAllDynamicFlags();
        }
        
        function handleBloodInputs() { let score = 0; const getF = (id) => parseFloat(safeGet(id)); const isCardiac = safeIsChecked('cts_cardiac_checkbox'); const updateSD = (el, p, c) => { el.textContent = p > 0 ? `(+${p})` : ''; if(p > 0) el.className = `blood-score ${c}`; }; const lactate = getF('lactate_input'); if(!isNaN(lactate)){ let p=0, c=''; if(lactate >= 3.5) { p=10; c='score-red';} else if (lactate >= 2.0) { p=4; c='score-amber';} updateSD(document.getElementById('lactate_score_display'), p, c); score+=p; } else { updateSD(document.getElementById('lactate_score_display'), 0, ''); } const hb=getF('hb_input'), hb_prev=getF('hb_input_prev'); let hp=0, hc=''; if(!isNaN(hb) && !isNaN(hb_prev) && (hb_prev - hb) > 20) { hp=10; hc='score-red'; } else if (!isNaN(hb) && hb < 80) { hp=3; hc='score-amber'; } updateSD(document.getElementById('hb_score_display'), hp, hc); score+=hp; const checkE=(id, low, high) => { const val = getF(`${id}_input`), el = document.getElementById(`${id}_score_display`); if(isNaN(val) || !el) {if(el)updateSD(el,0,''); return;} const act = safeIsChecked(`${id}_replaced_checkbox`) || safeIsChecked(`${id}_planned_checkbox`); if (!act && (val<low||val>high)) {updateSD(el, 4, 'score-red'); score+=4;} else {updateSD(el,0,'');}}; checkE('k', isCardiac?4.0:3.5, isCardiac?5.0:5.2); checkE('mg', isCardiac?0.8:0.7, 1.0); const creat = getF('creatinine_input'), creat_prev = getF('creatinine_input_prev'); let cp = 0; if(!isNaN(creat) && !isNaN(creat_prev) && creat > creat_prev*1.5) { cp=4; } updateSD(document.getElementById('creatinine_score_display'), cp, 'score-amber'); score += cp; const albumin = getF('albumin_input'); if(!isNaN(albumin) && albumin < 25) { updateSD(document.getElementById('albumin_score_display'), 3, 'score-amber'); score += 3; } else { updateSD(document.getElementById('albumin_score_display'), 0, ''); } window.bloodsScoreContribution = score; updateAllDynamicFlags(); }
        function handleFluidBalance(){ const fbc24hr = safeGetNum('fbc_24hr_input'), fbcTotal = safeGetNum('fbc_total_input'); const isSig = (fbc24hr && Math.abs(fbc24hr) > 1000) || (fbcTotal && Math.abs(fbcTotal) > 2000); const isMild = (fbc24hr && Math.abs(fbc24hr) > 500) || (fbcTotal && Math.abs(fbcTotal) > 1000); if(isSig) { document.getElementById('fluid_sig').checked = true; } else if (isMild) { document.getElementById('fluid_mild').checked = true; } else { document.getElementById('fluid_0').checked = true; } updateAllDynamicFlags(); }
        function handleAfterHoursLogic() { if (safeGet('reviewType') === 'pre') { afterHoursContainer.style.display = 'none'; afterHoursCheckbox.checked = false; } else { const dateStr = safeGet('icuStepdownDate'), timeStr = safeGet('icuStepdownTime'); if (!dateStr || !timeStr) { afterHoursContainer.style.display = 'none'; return; } const hoursSince = (new Date() - new Date(`${dateStr}T${timeStr}`)) / 36e5; if (hoursSince > 24) { afterHoursContainer.style.display = 'none'; afterHoursCheckbox.checked = false; } else { afterHoursContainer.style.display = 'block'; afterHoursCheckbox.checked = document.querySelector(`#icuStepdownTime option[value="${timeStr}"]`)?.dataset.ooh === 'true'; } } updateAllDynamicFlags(); }
        function updateAllDynamicFlags(){ const currentTotal = parseInt(totalScoreEl.textContent,10) - (safeIsChecked('systemic_after_hours') ? parseInt(afterHoursCheckbox.dataset.score,10) : 0); afterHoursCheckbox.dataset.score = currentTotal >= 10 ? "5" : "2"; document.querySelectorAll('.score-input').forEach(input => { const p = input.closest('label'); if(!p)return; p.classList.remove('risk-item-selected-critical', 'risk-item-selected-amber'); if(input.checked && (input.dataset.isCritical || input.dataset.isAmber)) p.classList.add(input.dataset.isCritical ? 'risk-item-selected-critical' : 'risk-item-selected-amber');}); calculateScore(); }
        
        // --- Functions for Handover Summaries ---
        function generatePatientCardHTML(patient) { const d = patient.data || {}; const score = patient.score || 0; const categoryClass = patient.categoryClass || 'risk-single'; const keyConcerns = Object.keys(impressionMap).filter(key => d[key]).map(key => { let c = impressionMap[key].replace('is currently','').replace(/^has (a|had a)/,'').replace('is in','').replace('is suffering from',''); return c.charAt(0).toUpperCase() + c.slice(1).trim(); }); const nursingConcernHTML = (d.concern_present && d.nursingConcernText) ? `<p style="margin-top:4px;"><strong>Staff Concern:</strong> ${d.nursingConcernText}</p>`: ''; const getDeviceFlags = (dev, type) => { const flags = []; if (dev.date) { const days = (new Date() - new Date(dev.date)) / 864e5; if (type === 'cvad' && days > 7) flags.push(`>7 days`); if (type === 'pivc' && days > 3) flags.push(`>72 hrs`); } if (type === 'pivc' && dev.pivas && parseInt(dev.pivas, 10) >= 2) flags.push(`PIVAS ${dev.pivas}`); if (dev.site && dev.site !== 'Clean & Dry') flags.push(dev.site); return flags.length > 0 ? `<span class="device-flag">(${flags.join(', ')})</span>` : ''; }; const devicesHTML = [...(d.centralLines||[]).map(c=>`<li><b>CVAD:</b> ${c.type||''} ${c.location||''} ${getDeviceFlags(c,'cvad')}</li>`), ...(d.pivcs||[]).map(p=>`<li><b>PIVC:</b> ${p.gauge||''} ${p.location||''} ${getDeviceFlags(p,'pivc')}</li>`), ...(d.ngTubes||[]).map(n=>`<li><b>Enteral:</b> ${n.type||''} for ${n.use||'N/A'}</li>`), ...(d.drains||[]).map(dr=>`<li><b>Drain:</b> ${dr.type==='Other'?dr.other:dr.type}</li>`), ...(d.wounds||[]).map(w=>`<li><b>Wound:</b> ${w.location==='Other'?w.other:w.location} (${w.status})</li>`)].join(''); return `<div class="ward-list-card"><div class="ward-list-header" style="border-top:4px solid ${categoryColorMap[categoryClass]||'#67E8F9'};"><h3>${d.patientInitials||'N/A'} <span style="font-weight:normal;">(${d.wardAndRoom||'N/A'})</span></h3><div class="score-box"><strong>Score: ${score}</strong><br><span style="font-size:8pt;">${patient.categoryText||'N/A'}</span></div></div><div class="ward-list-body"><div class="ward-list-section"><h4>ICU Summary</h4><p>${(d.icuSummary||'Not documented.').substring(0,150)}${d.icuSummary&&d.icuSummary.length>150?'...':''}</p></div>${devicesHTML?`<div class="ward-list-section"><h4>Devices & Lines</h4><ul>${devicesHTML}</ul></div>`:''}<div class="ward-list-section"><h4>Key Concerns for Follow-up</h4>${keyConcerns.length>0?`<ul>${keyConcerns.map(c=>`<li>${c}</li>`).join('')}</ul>`:'<p>None identified.</p>'}${nursingConcernHTML}</div></div></div>`; }
        function generateDigitalList() { saveActivePatientData(); let h='<div class="digital-list-container">'; Object.values(patients).sort((a,b)=>(b.score||0)-(a.score||0)).forEach(p=>{h+=generatePatientCardHTML(p);}); h+='</div>'; digitalListContent.innerHTML=h; digitalListModal.classList.remove('hidden'); digitalListModal.classList.add('flex'); }
        function generatePrintList() { saveActivePatientData(); let h=`<h1>ALERT Ward Handover - ${new Date().toLocaleDateString('en-AU')}</h1><div class="print-grid-container">`; Object.values(patients).sort((a,b)=>(b.score||0)-(a.score||0)).forEach(p=>{h+=generatePatientCardHTML(p);}); h+=`</div>`; printoutContainer.innerHTML=h; window.print(); }
        
        // --- Functions for Saving and Loading Data ---
        function getFormData() { const d={}; assessmentForm.querySelectorAll('input,select,textarea').forEach(el=>{let id=el.id||el.name; if(el.type==='checkbox'||el.type==='radio'){if(id)d[id]=el.checked;}else{if(id)d[id]=el.value;}}); d.allergies=Array.from(allergiesContainer.querySelectorAll('.allergy-row')).map(r=>({name:r.querySelector('.allergen-name').value, reaction:r.querySelector('.allergen-reaction').value})); const saveDevs=(c,s)=>Array.from(c.querySelectorAll('.device-row')).map(r=>{const dev={}; for(const k in s){dev[k]=r.querySelector(s[k])?.value;} return dev;}); d.centralLines=saveDevs(centralLinesContainer,{type:'.cvad-type',location:'.cvad-location',date:'.cvad-date',length:'.cvad-length',site:'.cvad-site'}); d.pivcs=saveDevs(pivcsContainer,{location:'.pivc-location',date:'.pivc-date',gauge:'.pivc-gauge',pivas:'.pivc-pivas'}); d.ngTubes=saveDevs(ngTubesContainer,{type:'.ng-type',length:'.ng-length',use:'.ng-use'}); d.drains=saveDevs(drainsContainer,{type:'.drain-type',other:'.drain-type-other',outputType:'.drain-output-type',output24hr:'.drain-output-24hr',outputTotal:'.drain-output-total'}); d.wounds=saveDevs(woundsContainer,{location:'.wound-location',other:'.wound-location-other',status:'.wound-status'}); d.pacingWires=saveDevs(pacingWiresContainer,{status:'.pacing_status',mode:'.pacing_mode',rate:'.pacing_rate',output:'.pacing_output'}); return d;}
        function loadFormData(d){if(!d)return; resetForm(); for(const k in d){const el=document.getElementById(k)||document.querySelector(`[name="${k}"]`); if(el){if(el.type==='checkbox'||el.type==='radio'){el.checked=d[k];}else{el.value=d[k];}}} if(d.allergies){d.allergies.forEach(a=>{createAllergyInput();const r=allergiesContainer.lastChild;if(r){r.querySelector('.allergen-name').value=a.name; r.querySelector('.allergen-reaction').value=a.reaction;}});} const loadDevs=(data, cF, c, p)=>{if(data)data.forEach(dev=>{cF(); const r=c.lastChild; if(r)for(const k in dev){const el=r.querySelector(`.${p}-${k}`); if(el)el.value=dev[k];}});} loadDevs(d.centralLines, createCentralLineInput, centralLinesContainer, 'cvad'); loadDevs(d.pivcs, createPivcInput, pivcsContainer, 'pivc'); loadDevs(d.ngTubes, createNgTubeInput, ngTubesContainer, 'ng'); loadDevs(d.drains, createDrainInput, drainsContainer, 'drain'); loadDevs(d.wounds, createWoundInput, woundsContainer, 'wound'); loadDevs(d.pacingWires, createPacingWiresInput, pacingWiresContainer, 'pacing'); document.querySelectorAll('input,select').forEach(el=>el.dispatchEvent(new Event('change',{bubbles:true})));}
        function saveState(){if(Object.keys(patients).length>0)localStorage.setItem(LOCAL_STORAGE_KEY,JSON.stringify({patients,activePatientId}));else localStorage.removeItem(LOCAL_STORAGE_KEY);}
        function loadAllData(){const d=localStorage.getItem(LOCAL_STORAGE_KEY);if(d){try{const p=JSON.parse(d);patients=p.patients||{};activePatientId=p.activePatientId;}catch(e){patients={};activePatientId=null;}} if(Object.keys(patients).length===0){addPatient(false);}else{if(!activePatientId||!patients[activePatientId]){activePatientId=Object.keys(patients)[0];}switchPatient(activePatientId);}}
        function saveActivePatientData(){if(!activePatientId)return;const d=getFormData();const s=parseInt(totalScoreEl.textContent,10);patients[activePatientId]={id:activePatientId,name:d.patientInitials||'Patient',score:s,categoryClass:getCategoryClass(s),categoryText:riskCategoryEl.textContent.split(' - ')[0].trim(),data:d};saveState();renderTabs();}
        function addPatient(doSave=true){const id=`p_${Date.now()}`;patients[id]={id:id,name:`Patient ${Object.keys(patients).length+1}`,score:0,categoryClass:'risk-single',categoryText:'...',data:{}};activePatientId=id;if(doSave)saveState();switchPatient(id);}
        function deletePatient(id){delete patients[id];if(Object.keys(patients).length===0){addPatient(false);}else{if(activePatientId===id)activePatientId=Object.keys(patients)[0];saveState();switchPatient(activePatientId);}}
        function switchPatient(id){if(activePatientId&&patients[activePatientId]&&activePatientId!==id)saveActivePatientData();activePatientId=id;if(patients[id])loadFormData(patients[id].data);renderTabs();}
        function renderTabs(){patientTabsContainer.innerHTML='';Object.values(patients).forEach(p=>{const t=document.createElement('div');t.className='patient-tab';if(p.id===activePatientId)t.classList.add('active',p.categoryClass||'risk-single');t.dataset.id=p.id;t.innerHTML=`<span class="tab-score-badge" style="background-color:${categoryColorMap[p.categoryClass]||'#67E8F9'}">${p.score||0}</span><span>${p.name||'New'}</span><button class="delete-patient-btn" title="Delete ${p.name}">&times;</button>`;t.onclick=(e)=>{if(e.target.classList.contains('delete-patient-btn')){e.stopPropagation();if(confirm(`Delete patient ${p.name}?`))deletePatient(p.id);}else{switchPatient(p.id);}};patientTabsContainer.appendChild(t);});}
        
        // --- App Initialization ---
        function initializeApp() {
            ['addCentralLineButton', 'addPivcButton', 'addNgTubeButton', 'addDrainButton', 'addWoundButton', 'addPacingWiresButton'].forEach(id => document.getElementById(id).addEventListener('click', {[id]:()=>createDynamicInput(eval(id.replace('add','').replace('Button','').toLowerCase()+'Container'), eval('create'+id.replace('add','').replace('Button','')+'Input').toString().match(/`([^`]*)`/)[1])}[id]));
            document.getElementById('addPatientBtn').addEventListener('click',()=>addPatient()); document.getElementById('printListBtn').addEventListener('click',generatePrintList); document.getElementById('digitalListBtn').addEventListener('click',generateDigitalList); document.getElementById('clearDataBtn').addEventListener('click',()=>{if(confirm('This will delete ALL patient data. Are you sure?')){localStorage.removeItem(LOCAL_STORAGE_KEY);patients={};activePatientId=null;addPatient(false);}}); document.getElementById('closeDigitalListModalBtn').addEventListener('click',()=>digitalListModal.classList.add('hidden')); document.getElementById('generateSummaryButton').addEventListener('click',generateSummary);
            document.querySelectorAll('.vital-input, .pre-obs-input').forEach(i => i.addEventListener('input', calculateADDS));
            document.querySelectorAll('.blood-input, .fluid-input, .time-input, .score-input, .score-input-manual').forEach(i => i.addEventListener('input', ()=>{handleBloodInputs(); handleFluidBalance(); handleAfterHoursLogic();}));
            assessmentForm.addEventListener('change', e=>{if(e.target.closest('.device-row'))updateDeviceFlagsOnForm();});
            let saveTimeout; assessmentForm.addEventListener('input', ()=>{clearTimeout(saveTimeout); saveTimeout=setTimeout(saveActivePatientData, 500);});
            const los1 = document.getElementById('losDays'), los2 = document.getElementById('losDaysSystemic'); los1.addEventListener('input', ()=>los2.value=los1.value); los2.addEventListener('input', ()=>los1.value=los2.value);
            loadAllData();
        }
        initializeApp();
    });
    </script>
</body>
</html>
